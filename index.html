<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>行銷管理系統</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.0.1/build/index.umd.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const STORAGE_KEY = "marketing-system-db";

      const DEFAULT_ADMIN = {
        id: "u-1",
        username: "admin",
        password: "admin",
        displayName: "系統管理員",
        role: "admin",
        permissions: {
          products: true,
          ads: false,
        },
      };

      const DEFAULT_DB = {
        users: [DEFAULT_ADMIN],
        referenceOptions: {
          categories: ["保養", "美妝", "生活家電"],
          usageFlows: ["日常保養", "彩妝步驟", "深層清潔"],
          usageMethods: ["早晚使用", "睡前使用", "運動前後"],
          audiences: ["女性", "男性", "青少年", "敏感肌"],
          painPoints: ["出油", "暗沉", "痘痘", "乾裂"],
          awards: ["FG 特優", "女人我最大推薦", "百大網友口碑"],
          channelLinks: ["官網", "蝦皮", "屈臣氏"],
        },
        products: [],
      };

      const strip = (value) => (typeof value === "string" ? value.trim() : "");

      const normalizeFeatures = (features = []) => {
        const list = Array.isArray(features) ? features : [];
        return Array.from({ length: 5 }, (_, index) => strip(list[index] ?? ""));
      };

      const normalizeFaqs = (faqs = []) => {
        if (!Array.isArray(faqs)) return [];
        return faqs
          .map((item) => {
            if (typeof item === "string") {
              return { question: strip(item), answer: "" };
            }
            if (Array.isArray(item)) {
              return {
                question: strip(item[0]),
                answer: strip(item[1]),
              };
            }
            return {
              question: strip(item?.question ?? item?.q ?? ""),
              answer: strip(item?.answer ?? item?.a ?? ""),
            };
          })
          .filter((item) => item.question || item.answer);
      };

      const normalizeRecommendedCombos = (combos = []) => {
        if (!Array.isArray(combos)) return [];
        return combos
          .map((item) => {
            if (typeof item === "string") {
              return { name: strip(item), link: "", reason: "" };
            }
            return {
              name: strip(item?.name ?? item?.title ?? ""),
              link: strip(item?.link ?? item?.url ?? ""),
              reason: strip(item?.reason ?? item?.note ?? ""),
            };
          })
          .filter((item) => item.name || item.link || item.reason);
      };

      const sanitizeProduct = (product) => {
        const channelLinks = Object.fromEntries(
          Object.entries(product.channelLinks || {})
            .map(([channel, url]) => [channel, strip(url)])
            .filter(([, url]) => url)
        );
        const features = normalizeFeatures(product.features);
        return {
          ...product,
          productNumber: strip(product.productNumber),
          nameZh: strip(product.nameZh),
          nameEn: strip(product.nameEn),
          nickname: strip(product.nickname),
          usageMethod: strip(product.usageMethod),
          category: strip(product.category),
          usageFlow: strip(product.usageFlow),
          shortDescription: strip(product.shortDescription),
          faqs: normalizeFaqs(product.faqs),
          recommendedCombos: normalizeRecommendedCombos(product.recommendedCombos),
          features,
          channelLinks,
        };
      };

      const saveToStorage = (data) =>
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

      const readFromStorage = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : DEFAULT_DB;
        } catch (error) {
          console.error("讀取 localStorage 失敗", error);
          return DEFAULT_DB;
        }
      };

      const normalizePermissions = (permissions = {}) => ({
        products: permissions.products ?? true,
        ads: permissions.ads ?? false,
      });

      const ensureDbShape = (data) => {
        const next = { ...DEFAULT_DB, ...data };
        let users = (next.users || []).map((user, index) => ({
          id: user.id || `u-${index + 1}`,
          username: user.username || "",
          password: user.password || "",
          displayName: user.displayName || user.username || "",
          role: user.role || "member",
          permissions: normalizePermissions(user.permissions),
        }));

        const adminIndex = users.findIndex(
          (user) => user.username === DEFAULT_ADMIN.username
        );

        if (adminIndex === -1) {
          users.push({
            ...DEFAULT_ADMIN,
            id: DEFAULT_ADMIN.id || crypto.randomUUID(),
          });
        } else {
          users[adminIndex] = {
            ...DEFAULT_ADMIN,
            ...users[adminIndex],
            password: DEFAULT_ADMIN.password,
            role: "admin",
            permissions: normalizePermissions({
              products: true,
              ads: false,
              ...users[adminIndex].permissions,
            }),
          };
        }

        const hasAdmin = users.some((user) => user.role === "admin");
        if (!hasAdmin) {
          users.push({
            ...DEFAULT_ADMIN,
            id: crypto.randomUUID(),
          });
        }

        next.users = users;
        next.referenceOptions = {
          ...DEFAULT_DB.referenceOptions,
          ...(next.referenceOptions || {}),
        };
        next.products = (next.products || []).map((product, index) =>
          sanitizeProduct({
            id: product.id || `p-${index + 1}`,
            ...product,
          })
        );
        return next;
      };

      const usePersistentDb = () => {
        const [db, setDb] = useState(() => ensureDbShape(readFromStorage()));

        useEffect(() => {
          saveToStorage(db);
        }, [db]);

        return [db, setDb];
      };

      const SectionCard = ({ title, actions, children }) => (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-6 shadow-2xl shadow-black/40">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <div className="w-1 h-6 bg-emerald-400 rounded-full"></div>
              <h2 className="text-lg font-semibold tracking-wide">{title}</h2>
            </div>
            {actions}
          </div>
          <div className="space-y-3">{children}</div>
        </div>
      );

      const Badge = ({ label }) => (
        <span className="px-3 py-1 text-xs rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">
          {label}
        </span>
      );

      const LoginForm = ({ onLogin, onResetStorage }) => {
        const [form, setForm] = useState({ username: "", password: "" });
        const [error, setError] = useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          const success = onLogin(form);
          if (!success) {
            setError("帳號或密碼錯誤");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-950">
            <div className="w-full max-w-md space-y-6 bg-slate-900/80 border border-slate-800 rounded-3xl p-10 shadow-2xl shadow-black/70">
              <div>
                <p className="text-emerald-400 uppercase tracking-[0.3em] text-xs mb-2">
                  MARKETING OPS
                </p>
                <h1 className="text-3xl font-semibold mb-2">
                  行銷部管理系統
                </h1>
                <p className="text-slate-400 text-sm">
                  請先登入以進入管理介面
                </p>
              </div>
              <form className="space-y-4" onSubmit={handleSubmit} autoComplete="off">
                <div>
                  <input
                    type="text"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="off"
                    value={form.username}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, username: e.target.value }))
                    }
                  />
                </div>
                <div>
                  <input
                    type="password"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="new-password"
                    value={form.password}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, password: e.target.value }))
                    }
                  />
                </div>
                {error && (
                  <div className="text-sm text-red-400 bg-red-400/10 border border-red-500/20 px-3 py-2 rounded-xl">
                    {error}
                  </div>
                )}
                <button
                  type="submit"
                  className="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 text-slate-950 font-semibold shadow-lg shadow-emerald-500/30"
                >
                  登入系統
                </button>
              </form>
      
              <button
                type="button"
                onClick={onResetStorage}
                className="w-full text-xs text-slate-400 hover:text-emerald-300 underline mt-2"
              >
                若無法登入，點此清除本機資料並重設
              </button>
            </div>
          </div>
        );
      };

      const OptionEditor = ({ optionKey, label, options, onSave }) => {
        const [value, setValue] = useState("");
        const handleAdd = () => {
          if (!value.trim()) return;
          onSave(optionKey, [...options, value.trim()]);
          setValue("");
        };
        const handleRemove = (item) => {
          onSave(
            optionKey,
            options.filter((opt) => opt !== item)
          );
        };
        return (
          <SectionCard title={`${label} 管理`}>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                placeholder={`新增${label}`}
                value={value}
                onChange={(e) => setValue(e.target.value)}
              />
              <button
                className="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/40 text-emerald-200"
                onClick={handleAdd}
              >
                新增
              </button>
            </div>
            <div className="flex flex-wrap gap-2 mt-2">
              {options.map((opt) => (
                <button
                  key={opt}
                  onClick={() => handleRemove(opt)}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 hover:border-red-400 hover:text-red-200 transition"
                >
                  {opt} ×
                </button>
              ))}
              {!options.length && (
                <p className="text-slate-500 text-sm">尚未設定任何項目</p>
              )}
            </div>
          </SectionCard>
        );
      };

      const MultiInput = ({ label, values, placeholder, onChange }) => {
        const [input, setInput] = useState("");
        const handleAdd = () => {
          if (!input.trim()) return;
          onChange([...values, input.trim()]);
          setInput("");
        };
        const handleRemove = (item) =>
          onChange(values.filter((val) => val !== item));
        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">{label}</label>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                value={input}
                placeholder={placeholder}
                onChange={(e) => setInput(e.target.value)}
              />
              <button
                type="button"
                onClick={handleAdd}
                className="px-4 py-2 rounded-xl border border-emerald-500/30 text-emerald-300"
              >
                加入
              </button>
            </div>
            <div className="flex flex-wrap gap-2">
              {values.map((val) => (
                <span
                  key={val}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 flex items-center gap-2"
                >
                  {val}
                  <button onClick={() => handleRemove(val)} className="text-red-300">
                    ×
                  </button>
                </span>
              ))}
            </div>
          </div>
        );
      };

      const FiveFeaturesInput = ({ values = [], onChange }) => {
        const normalized = normalizeFeatures(values);

        const handleChange = (index, value) => {
          const next = [...normalized];
          next[index] = value;
          onChange(next);
        };

        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">產品主要五大特色</label>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {normalized.map((feature, index) => (
                <input
                  key={index}
                  className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                  placeholder={`特色 ${index + 1}`}
                  value={feature}
                  onChange={(e) => handleChange(index, e.target.value)}
                />
              ))}
            </div>
            <p className="text-xs text-slate-500">
              請輸入最多五個產品亮點；可留空的欄位會自動忽略。
            </p>
          </div>
        );
      };

      const FAQEditor = ({ items = [], onChange }) => {
        const handleAdd = () =>
          onChange([...(items || []), { question: "", answer: "" }]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">常見問答</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                新增問答
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder={`問題 #${index + 1}`}
                      value={item.question}
                      onChange={(e) =>
                        handleChange(index, "question", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="答案"
                      value={item.answer}
                      onChange={(e) =>
                        handleChange(index, "answer", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      刪除此問答
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">尚未新增問答</p>
              )}
            </div>
          </div>
        );
      };

      const ComboEditor = ({ items = [], onChange }) => {
        const handleAdd = () =>
          onChange([
            ...(items || []),
            { name: "", link: "", reason: "" },
          ]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">推薦搭配產品</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                新增推薦
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="產品名稱"
                      value={item.name}
                      onChange={(e) =>
                        handleChange(index, "name", e.target.value)
                      }
                    />
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="產品超連結（可選）"
                      value={item.link}
                      onChange={(e) =>
                        handleChange(index, "link", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="推薦原因（可描述搭配情境）"
                      value={item.reason}
                      onChange={(e) =>
                        handleChange(index, "reason", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      刪除此推薦
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">尚未新增推薦產品</p>
              )}
            </div>
          </div>
        );
      };

      const FileUploader = ({ images, onChange }) => {
        const handleFiles = (files) => {
          const readers = Array.from(files).map(
            (file) =>
              new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
              })
          );
          Promise.all(readers).then((results) => {
            onChange([...images, ...results]);
          });
        };
        const handleRemove = (img) => {
          onChange(images.filter((item) => item !== img));
        };
        return (
          <div className="space-y-3">
            <label className="text-sm text-slate-300">產品圖片 (1:1)</label>
            <input
              type="file"
              accept="image/*"
              multiple
              onChange={(e) => handleFiles(e.target.files)}
              className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
            />
            <div className="grid grid-cols-3 gap-3">
              {images.map((img, idx) => (
                <div key={idx} className="relative group">
                  <img
                    src={img}
                    alt="product"
                    className="w-full aspect-square object-cover rounded-2xl border border-slate-800"
                  />
                  <button
                    onClick={() => handleRemove(img)}
                    className="absolute top-2 right-2 bg-black/60 text-xs px-2 py-1 rounded-full hidden group-hover:block"
                  >
                    刪除
                  </button>
                </div>
              ))}
              {!images.length && (
                <div className="col-span-3 text-sm text-slate-500">
                  尚未上傳圖片
                </div>
              )}
            </div>
          </div>
        );
      };

      const ExportPanel = ({ selectedProducts }) => {
        const [fields, setFields] = useState([
          "productNumber",
          "nameZh",
          "nameEn",
          "category",
          "features",
          "channelSkus",
          "shortDescription",
        ]);
        const [previewOpen, setPreviewOpen] = useState(false);

        const fieldConfig = [
          { key: "productNumber", label: "產品編號" },
          { key: "category", label: "大分類" },
          { key: "usageFlow", label: "使用程序" },
          { key: "nameZh", label: "中文品名" },
          { key: "nameEn", label: "英文品名" },
          { key: "features", label: "五大特色" },
          { key: "nickname", label: "產品綽號" },
          { key: "usageMethod", label: "產品使用方式" },
          { key: "audiences", label: "產品受眾" },
          { key: "painPoints", label: "產品痛點" },
          { key: "awards", label: "得獎榮譽" },
          { key: "channelSkus", label: "通路貨號" },
          { key: "channelLinks", label: "通路短連結" },
          { key: "purchaseDecision", label: "購買決策" },
          { key: "faqs", label: "常見問答" },
          { key: "shortDescription", label: "產品介紹短文" },
          { key: "recommendedCombos", label: "推薦搭配產品" },
          { key: "recommendedOthers", label: "推薦其他產品" },
          { key: "highConversionAssets", label: "高轉換素材" },
        ];

        const toggleField = (key) => {
          setFields((prev) =>
            prev.includes(key) ? prev.filter((item) => item !== key) : [...prev, key]
          );
        };

        const formatFieldValue = (field, value) => {
          if (value === null || value === undefined) return "";
          if (Array.isArray(value)) {
            if (!value.length) return "";
            if (field === "faqs") {
              return value
                .map(
                  (item, idx) =>
                    `Q${idx + 1}: ${item?.question || ""}\nA${idx + 1}: ${
                      item?.answer || ""
                    }`
                )
                .join("\n");
            }
            if (field === "recommendedCombos") {
              return value
                .map((item) => {
                  const parts = [item?.name || ""];
                  if (item?.link) parts.push(item.link);
                  if (item?.reason) parts.push(item.reason);
                  return parts.filter(Boolean).join(" | ");
                })
                .join("\n");
            }
            return value
              .map((v) =>
                typeof v === "object" ? Object.values(v).join(" / ") : v
              )
              .join("\n");
          }
          if (typeof value === "object") {
            return Object.entries(value)
              .map(([k, v]) => `${k}: ${v}`)
              .join("\n");
          }
          if (typeof value === "string") return strip(value);
          return String(value ?? "");
        };

        const buildRows = () =>
          selectedProducts.map((product) => {
            const row = {};
            fields.forEach((field) => {
              row[field] = formatFieldValue(field, product[field]);
            });
            return row;
          });

        const handleExport = async (type) => {
          if (!selectedProducts.length) {
            alert("請先選擇至少 1 個產品");
            return;
          }
          const rows = buildRows();
          if (type === "excel") {
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
            XLSX.writeFile(workbook, "products.xlsx");
          } else if (type === "pdf") {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt" });
            rows.forEach((row, index) => {
              const startY = 40 + index * 220;
              if (startY > 720) {
                doc.addPage();
              }
              let line = 0;
              Object.entries(row).forEach(([key, value]) => {
                const text = `${key}: ${value}`;
                const lines = doc.splitTextToSize(text, 500);
                doc.text(lines, 40, 60 + line * 16 + index * 200);
                line += lines.length;
              });
              doc.line(30, 220 + index * 200, 560, 220 + index * 200);
            });
            doc.save("products.pdf");
          } else if (type === "word") {
            const doc = new docx.Document({
              sections: [
                {
                  properties: {},
                  children: rows.map(
                    (row) =>
                      new docx.Paragraph({
                        children: Object.entries(row).map(
                          ([key, value]) =>
                            new docx.TextRun({
                              text: `${key}: ${value}`,
                              break: 1,
                            })
                        ),
                      })
                  ),
                },
              ],
            });
            const blob = await docx.Packer.toBlob(doc);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "products.docx";
            document.body.appendChild(link);
            link.click();
            link.remove();
          }
        };

        return (
          <SectionCard
            title="匯出中心"
            actions={
              <button
                onClick={() => setPreviewOpen(!previewOpen)}
                className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
              >
                {previewOpen ? "關閉預覽" : "匯出預覽"}
              </button>
            }
          >
            <div className="space-y-3 text-sm">
              <p className="text-slate-400">
                已選 {selectedProducts.length} 項產品，請選擇要匯出的欄位與格式。
              </p>
              <div className="grid grid-cols-2 gap-2">
                {fieldConfig.map(({ key, label }) => (
                  <label
                    key={key}
                    className="flex items-center gap-2 text-xs border border-slate-800 rounded-xl px-2 py-1"
                  >
                    <input
                      type="checkbox"
                      checked={fields.includes(key)}
                      onChange={() => toggleField(key)}
                    />
                    {label}
                  </label>
                ))}
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => handleExport("excel")}
                  className="flex-1 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/50"
                >
                  匯出 Excel
                </button>
                <button
                  onClick={() => handleExport("word")}
                  className="flex-1 py-2 rounded-xl bg-sky-500/20 border border-sky-500/50"
                >
                  匯出 Word
                </button>
                <button
                  onClick={() => handleExport("pdf")}
                  className="flex-1 py-2 rounded-xl bg-purple-500/20 border border-purple-500/50"
                >
                  匯出 PDF
                </button>
              </div>
              {previewOpen && (
                <div className="border border-slate-800 rounded-xl p-3 bg-slate-950/60 space-y-2 max-h-64 overflow-auto">
                  {selectedProducts.map((product) => (
                    <div key={product.id} className="border border-slate-800 rounded-xl p-3">
                      <p className="font-semibold">{product.nameZh}</p>
                      <p className="text-xs text-slate-400">{product.productNumber}</p>
                      <div className="text-xs text-slate-300 mt-2 space-y-1">
                        {fields.map((field) => (
                          <p key={field} className="whitespace-pre-line">
                            <span className="text-slate-500">{field}：</span>
                            {formatFieldValue(field, product[field]) || "-"}
                          </p>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </SectionCard>
        );
      };

      const ProductForm = ({
        initialValue,
        referenceOptions,
        onSubmit,
        onCancel,
        onAddReference = () => {},
      }) => {
        const [form, setForm] = useState(() =>
          initialValue
            ? sanitizeProduct(initialValue)
            : {
                id: crypto.randomUUID(),
                productNumber: "",
                category: "",
                usageFlow: "",
                usageMethod: "",
                nameZh: "",
                nameEn: "",
                nickname: "",
                shortDescription: "",
                purchaseDecision: "",
                channelLinks: {},
                features: normalizeFeatures(),
                audiences: [],
                painPoints: [],
                awards: [],
                images: [],
                channelSkus: [],
                recommendedCombos: [],
                recommendedOthers: [],
                highConversionAssets: [],
                faqs: [],
              }
        );

        const updateField = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handleQuickAdd = (optionKey, label, targetField) => {
          const value = window.prompt(`請輸入新的${label}`);
          if (!value || !value.trim()) return;
          const trimmed = value.trim();
          onAddReference(optionKey, trimmed);
          updateField(targetField, trimmed);
        };

        const handleChannelSkuAdd = () => {
          setForm((prev) => ({
            ...prev,
            channelSkus: [...prev.channelSkus, { channel: "", sku: "" }],
          }));
        };

        const handleChannelLinkChange = (channel, value) => {
          setForm((prev) => {
            const nextLinks = { ...(prev.channelLinks || {}) };
            if (value) {
              nextLinks[channel] = value;
            } else {
              delete nextLinks[channel];
            }
            return { ...prev, channelLinks: nextLinks };
          });
        };

        const handleListChange = (key, index, field, value) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            ),
          }));
        };

        const handleListRemove = (key, index) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].filter((_, idx) => idx !== index),
          }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(form);
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-6">
            <SectionCard
              title="基本資訊"
              actions={
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={onCancel}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    取消
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    儲存
                  </button>
                </div>
              }
            >
              <div className="grid md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">產品編號</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.productNumber}
                    onChange={(e) => updateField("productNumber", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">大分類</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.category}
                      onChange={(e) => updateField("category", e.target.value)}
                    >
                      <option value="">選擇分類</option>
                      {referenceOptions.categories.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("categories", "大分類", "category")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + 新增
                    </button>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">使用程序分類</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.usageFlow}
                      onChange={(e) => updateField("usageFlow", e.target.value)}
                    >
                      <option value="">選擇分類</option>
                      {referenceOptions.usageFlows.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("usageFlows", "使用程序分類", "usageFlow")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + 新增
                    </button>
                  </div>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">中文品名</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameZh}
                    onChange={(e) => updateField("nameZh", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">英文品名</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameEn}
                    onChange={(e) => updateField("nameEn", e.target.value)}
                  />
                </div>
              </div>
              <div className="space-y-2">
                <label className="text-sm">產品介紹短文</label>
                <textarea
                  className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 min-h-[120px]"
                  value={form.shortDescription}
                  onChange={(e) => updateField("shortDescription", e.target.value)}
                ></textarea>
              </div>
              <div className="space-y-4">
                <FiveFeaturesInput
                  values={form.features}
                  onChange={(values) => updateField("features", values)}
                />
                <ComboEditor
                  items={form.recommendedCombos || []}
                  onChange={(values) => updateField("recommendedCombos", values)}
                />
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <FAQEditor
                  items={form.faqs || []}
                  onChange={(values) => updateField("faqs", values)}
                />
                <MultiInput
                  label="購買決策"
                  values={
                    Array.isArray(form.purchaseDecision)
                      ? form.purchaseDecision
                      : form.purchaseDecision
                      ? [form.purchaseDecision]
                      : []
                  }
                  placeholder="輸入購買決策要點"
                  onChange={(values) =>
                    updateField("purchaseDecision", values.join("、"))
                  }
                />
              </div>
            </SectionCard>

            <SectionCard title="通路與圖片">
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <h3 className="text-sm text-slate-300">通路貨號</h3>
                  <button
                    type="button"
                    onClick={handleChannelSkuAdd}
                    className="px-3 py-1 text-xs rounded-full border border-slate-700"
                  >
                    新增通路
                  </button>
                </div>
                <div className="space-y-3">
                  {form.channelSkus.map((item, index) => (
                    <div
                      key={index}
                      className="grid md:grid-cols-3 gap-3 bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                    >
                      <input
                        className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                        placeholder="通路名稱"
                        value={item.channel}
                        onChange={(e) =>
                          handleListChange("channelSkus", index, "channel", e.target.value)
                        }
                      />
                      <input
                        className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                        placeholder="通路貨號"
                        value={item.sku}
                        onChange={(e) =>
                          handleListChange("channelSkus", index, "sku", e.target.value)
                        }
                      />
                      <button
                        type="button"
                        onClick={() => handleListRemove("channelSkus", index)}
                        className="rounded-xl border border-red-500/40 text-red-300 text-sm"
                      >
                        移除
                      </button>
                    </div>
                  ))}
                  {!form.channelSkus.length && (
                    <p className="text-sm text-slate-500">尚無通路設定</p>
                  )}
                </div>
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <h3 className="text-sm text-slate-300">通路短連結</h3>
                    <p className="text-xs text-slate-500">
                      通路選項可在右側「通路管理」編輯
                    </p>
                  </div>
                  <div className="space-y-3">
                    {referenceOptions.channelLinks.length ? (
                      referenceOptions.channelLinks.map((channel) => (
                        <div
                          key={channel}
                          className="grid md:grid-cols-3 gap-3 items-center bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                        >
                          <div className="text-sm font-medium text-slate-200">
                            {channel}
                          </div>
                          <div className="md:col-span-2">
                            <input
                              className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                              placeholder="輸入短網址或完整網址"
                              value={form.channelLinks?.[channel] || ""}
                              onChange={(e) =>
                                handleChannelLinkChange(channel, e.target.value)
                              }
                            />
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-sm text-slate-500">
                        尚未設定通路，請至右側「通路管理」新增。
                      </div>
                    )}
                  </div>
                </div>
                <FileUploader
                  images={form.images}
                  onChange={(images) => updateField("images", images)}
                />
              </div>
            </SectionCard>

            <SectionCard title="受眾與痛點">
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">產品使用方式</label>
                  <input
                    list="usage-method-options"
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    placeholder="輸入或選擇使用方式"
                    value={form.usageMethod}
                    onChange={(e) => updateField("usageMethod", e.target.value)}
                  />
                  <datalist id="usage-method-options">
                    {referenceOptions.usageMethods.map((opt) => (
                      <option key={opt} value={opt} />
                    ))}
                  </datalist>
                </div>
                <MultiInput
                  label="產品綽號"
                  values={form.nickname ? [form.nickname] : []}
                  placeholder="輸入綽號"
                  onChange={(values) =>
                    updateField("nickname", values.length ? values[0] : "")
                  }
                />
                <MultiInput
                  label="產品受眾"
                  values={form.audiences}
                  placeholder="新增受眾"
                  onChange={(values) => updateField("audiences", values)}
                />
                <MultiInput
                  label="產品痛點"
                  values={form.painPoints}
                  placeholder="新增痛點"
                  onChange={(values) => updateField("painPoints", values)}
                />
              </div>
              <MultiInput
                label="得獎榮譽"
                values={form.awards}
                placeholder="新增得獎紀錄"
                onChange={(values) => updateField("awards", values)}
              />
            </SectionCard>
          </form>
        );
      };

      const ProductList = ({ products, onSelect, selectedIds }) => (
        <SectionCard
          title="產品清單"
          actions={<Badge label={`${products.length} 項`} />}
        >
          <div className="space-y-2">
            {products.map((product) => (
              <button
                key={product.id}
                onClick={() => onSelect(product)}
                className={`w-full text-left px-4 py-3 rounded-2xl border ${
                  selectedIds.includes(product.id)
                    ? "border-emerald-400 bg-emerald-400/10"
                    : "border-slate-800 hover:border-emerald-400/40"
                }`}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-semibold">{product.nameZh || "未命名產品"}</p>
                    <p className="text-xs text-slate-400">{product.productNumber}</p>
                  </div>
                  <div className="flex gap-2">
                    {product.category && <Badge label={product.category} />}
                    {product.usageFlow && <Badge label={product.usageFlow} />}
                  </div>
                </div>
              </button>
            ))}
            {!products.length && (
              <div className="text-center text-sm text-slate-500 py-10">
                尚無產品，請先建立。
              </div>
            )}
          </div>
        </SectionCard>
      );

      const ProductModule = ({ db, setDb }) => {
        const [mode, setMode] = useState("list");
        const [editingProduct, setEditingProduct] = useState(null);
        const [selected, setSelected] = useState([]);
        const [search, setSearch] = useState("");
        const [filterCategory, setFilterCategory] = useState("");

        const filteredProducts = useMemo(() => {
          return db.products.filter((p) => {
            const matchCategory = filterCategory ? p.category === filterCategory : true;
            const matchSearch = search
              ? (p.nameZh || "").includes(search) ||
                (p.nameEn || "").includes(search) ||
                (p.productNumber || "").includes(search)
              : true;
            return matchCategory && matchSearch;
          });
        }, [db.products, search, filterCategory]);

        const handleSaveProduct = (product) => {
          const cleanProduct = sanitizeProduct(product);
          setDb((prev) => {
            const exists = prev.products.some((p) => p.id === cleanProduct.id);
            const products = exists
              ? prev.products.map((p) =>
                  p.id === cleanProduct.id ? cleanProduct : p
                )
              : [...prev.products, cleanProduct];
            return { ...prev, products };
          });
          setMode("list");
          setEditingProduct(null);
        };

        const handleDelete = (product) => {
          if (!window.confirm("確定刪除此產品？")) return;
          setDb((prev) => ({
            ...prev,
            products: prev.products.filter((p) => p.id !== product.id),
          }));
          setSelected((prev) => prev.filter((id) => id !== product.id));
        };

        const handleReferenceSave = (key, items) => {
          setDb((prev) => ({
            ...prev,
            referenceOptions: {
              ...prev.referenceOptions,
              [key]: items,
            },
          }));
        };

        const handleReferenceAdd = (key, value) => {
          if (!value || !value.trim()) return;
          setDb((prev) => {
            const current = prev.referenceOptions[key] || [];
            if (current.includes(value)) return prev;
            return {
              ...prev,
              referenceOptions: {
                ...prev.referenceOptions,
                [key]: [...current, value],
              },
            };
          });
        };

        const toggleSelect = (product) => {
          setSelected((prev) =>
            prev.includes(product.id)
              ? prev.filter((id) => id !== product.id)
              : [...prev, product.id]
          );
        };

        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              {mode === "list" && (
                <>
                  <SectionCard
                    title="查找產品"
                    actions={
                      <button
                        onClick={() => {
                          setMode("edit");
                          setEditingProduct(null);
                        }}
                        className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                      >
                        新增產品
                      </button>
                    }
                  >
                    <div className="grid md:grid-cols-3 gap-3">
                      <input
                        placeholder="輸入品名 / 編號"
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                      />
                      <select
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={filterCategory}
                        onChange={(e) => setFilterCategory(e.target.value)}
                      >
                        <option value="">全部分類</option>
                        {db.referenceOptions.categories.map((cat) => (
                          <option key={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                  </SectionCard>
                  <ProductList
                    products={filteredProducts}
                    selectedIds={selected}
                    onSelect={(product) => {
                      setEditingProduct(product);
                      setMode("details");
                    }}
                  />
                </>
              )}
              {mode === "edit" && (
                <ProductForm
                  initialValue={editingProduct}
                  referenceOptions={db.referenceOptions}
                  onSubmit={handleSaveProduct}
                  onAddReference={handleReferenceAdd}
                  onCancel={() => {
                    setMode("list");
                    setEditingProduct(null);
                  }}
                />
              )}
              {mode === "details" && editingProduct && (
                <SectionCard
                  title={editingProduct.nameZh || "產品詳情"}
                  actions={
                    <div className="flex gap-2">
                      <button
                        onClick={() => toggleSelect(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        {selected.includes(editingProduct.id) ? "取消勾選" : "勾選匯出"}
                      </button>
                      <button
                        onClick={() => {
                          setMode("edit");
                        }}
                        className="px-3 py-1 rounded-xl border border-emerald-400/40 text-xs"
                      >
                        編輯
                      </button>
                      <button
                        onClick={() => handleDelete(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        刪除
                      </button>
                      <button
                        onClick={() => {
                          setMode("list");
                          setEditingProduct(null);
                        }}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        返回列表
                      </button>
                    </div>
                  }
                >
                  <div className="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="text-slate-400">產品編號</p>
                      <p>{editingProduct.productNumber || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">分類</p>
                      <p>{editingProduct.category || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">中文品名</p>
                      <p>{editingProduct.nameZh || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">英文品名</p>
                      <p>{editingProduct.nameEn || "-"}</p>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">產品特色</p>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {editingProduct.features?.map((f) => (
                          <Badge key={f} label={f} />
                        ))}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">產品介紹</p>
                      <p>{editingProduct.shortDescription || "-"}</p>
                    </div>
                  </div>
                  {editingProduct.images?.length > 0 && (
                    <div className="grid grid-cols-3 gap-3 mt-4">
                      {editingProduct.images.map((img, idx) => (
                        <img
                          key={idx}
                          src={img}
                          className="rounded-2xl border border-slate-800"
                        />
                      ))}
                    </div>
                  )}
                </SectionCard>
              )}
            </div>
            <div className="space-y-6">
              <ExportPanel
                selectedProducts={db.products.filter((p) => selected.includes(p.id))}
              />
              <OptionEditor
                optionKey="categories"
                label="大分類"
                options={db.referenceOptions.categories}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageFlows"
                label="使用程序分類"
                options={db.referenceOptions.usageFlows}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageMethods"
                label="使用方式"
                options={db.referenceOptions.usageMethods}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="channelLinks"
                label="通路管理"
                options={db.referenceOptions.channelLinks}
                onSave={handleReferenceSave}
              />
            </div>
          </div>
        );
      };

      const PermissionBadges = ({ permissions }) => (
        <div className="flex flex-wrap gap-2">
          {Object.entries(permissions).map(([key, value]) =>
            value ? (
              <Badge
                key={key}
                label={
                  {
                    products: "產品資料庫",
                    ads: "廣告文案",
                  }[key] || key
                }
              />
            ) : null
          )}
        </div>
      );

      const UserManagement = ({ db, setDb, currentUser }) => {
        const emptyUser = {
          id: "",
          username: "",
          password: "",
          displayName: "",
          role: "member",
          permissions: { products: false, ads: false },
        };

        const [form, setForm] = useState(emptyUser);
        const [isEditing, setIsEditing] = useState(false);

        const openCreate = () => {
          setForm({ ...emptyUser, id: crypto.randomUUID() });
          setIsEditing(false);
        };

        const openEdit = (user) => {
          setForm({
            ...user,
            permissions: normalizePermissions(user.permissions),
          });
          setIsEditing(true);
        };

        const resetForm = () => {
          setForm(emptyUser);
          setIsEditing(false);
        };

        const handleChange = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handlePermissionChange = (key) => {
          setForm((prev) => ({
            ...prev,
            permissions: {
              ...prev.permissions,
              [key]: !prev.permissions[key],
            },
          }));
        };

        const usernameExists = (username, excludeId) =>
          db.users.some(
            (user) =>
              user.username.toLowerCase() === username.toLowerCase() &&
              user.id !== excludeId
          );

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!form.username.trim() || !form.password.trim()) {
            alert("帳號與密碼為必填");
            return;
          }
          if (usernameExists(form.username, form.id)) {
            alert("此帳號已存在");
            return;
          }

          const payload = {
            ...form,
            username: form.username.trim(),
            password: form.password,
            displayName: form.displayName.trim() || form.username.trim(),
            role: form.role,
            permissions: normalizePermissions(form.permissions),
          };

          setDb((prev) => {
            const exists = prev.users.some((user) => user.id === payload.id);
            const users = exists
              ? prev.users.map((user) => (user.id === payload.id ? payload : user))
              : [...prev.users, payload];
            return { ...prev, users };
          });
          resetForm();
        };

        const handleDelete = (user) => {
          if (user.id === currentUser.id) {
            alert("無法刪除自己");
            return;
          }
          const admins = db.users.filter((u) => u.role === "admin");
          if (user.role === "admin" && admins.length <= 1) {
            alert("至少需要一位管理員");
            return;
          }
          if (!window.confirm(`確定刪除帳號：${user.username}？`)) return;
          setDb((prev) => ({
            ...prev,
            users: prev.users.filter((u) => u.id !== user.id),
          }));
        };

        return (
          <div className="space-y-6">
            <SectionCard
              title="帳號列表"
              actions={
                <button
                  onClick={openCreate}
                  className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                >
                  新增帳號
                </button>
              }
            >
              <div className="space-y-3 text-sm">
                {db.users.map((user) => (
                  <div
                    key={user.id}
                    className="p-4 rounded-2xl border border-slate-800 bg-slate-950/30 flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
                  >
                    <div>
                      <p className="font-semibold">
                        {user.displayName}{" "}
                        <span className="text-xs uppercase text-slate-400 ml-2">
                          {user.role}
                        </span>
                      </p>
                      <p className="text-xs text-slate-400">{user.username}</p>
                      <PermissionBadges permissions={user.permissions} />
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => openEdit(user)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        編輯
                      </button>
                      <button
                        onClick={() => handleDelete(user)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        刪除
                      </button>
                    </div>
                  </div>
                ))}
                {!db.users.length && (
                  <p className="text-center text-slate-500">尚無帳號</p>
                )}
              </div>
            </SectionCard>

            <SectionCard title={isEditing ? "編輯帳號" : "新增帳號"}>
              <form className="space-y-4" onSubmit={handleSubmit}>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-sm">帳號</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.username}
                      onChange={(e) => handleChange("username", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">密碼</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.password}
                      onChange={(e) => handleChange("password", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">顯示名稱</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.displayName}
                      onChange={(e) => handleChange("displayName", e.target.value)}
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">角色</label>
                    <select
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.role}
                      onChange={(e) => handleChange("role", e.target.value)}
                    >
                      <option value="admin">admin</option>
                      <option value="editor">editor</option>
                      <option value="member">member</option>
                    </select>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">可使用管理介面</label>
                  <div className="flex flex-wrap gap-3">
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.products}
                        onChange={() => handlePermissionChange("products")}
                      />
                      產品資料庫
                    </label>
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.ads}
                        onChange={() => handlePermissionChange("ads")}
                      />
                      廣告文案（預留）
                    </label>
                  </div>
                </div>
                <div className="flex gap-3">
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    {isEditing ? "更新帳號" : "建立帳號"}
                  </button>
                  <button
                    type="button"
                    onClick={resetForm}
                    className="px-4 py-2 rounded-xl border border-slate-700"
                  >
                    清空
                  </button>
                </div>
              </form>
            </SectionCard>
          </div>
        );
      };

      const Dashboard = ({ user, onLogout, db, setDb }) => {
        const availableTabs = React.useMemo(
          () =>
            [
              user.permissions?.products && {
                key: "products",
                label: "產品資料庫管理",
                disabled: false,
              },
              user.permissions?.ads && {
                key: "ads",
                label: "廣告文案模組（即將推出）",
                disabled: true,
              },
              user.role === "admin" && {
                key: "users",
                label: "會員管理系統",
                disabled: false,
              },
            ].filter(Boolean),
          [user]
        );

        const initialTab = availableTabs[0]?.key || "products";
        const [activeTab, setActiveTab] = useState(initialTab);

        useEffect(() => {
          if (!availableTabs.find((tab) => tab.key === activeTab)) {
            setActiveTab(availableTabs[0]?.key || "products");
          }
        }, [availableTabs, activeTab]);

        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-950 to-slate-900 text-slate-100">
            <header className="border-b border-white/5 bg-black/30 backdrop-blur sticky top-0 z-20">
              <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                <div>
                  <p className="text-xs tracking-[0.3em] text-emerald-400">
                    MARKETING OPS
                  </p>
                  <h1 className="text-xl font-semibold">行銷部管理系統</h1>
                </div>
                <div className="flex items-center gap-4">
                  <div className="text-sm">
                    <p className="font-semibold">{user.displayName}</p>
                    <p className="text-slate-400 text-xs uppercase">{user.role}</p>
                  </div>
                  <button
                    onClick={onLogout}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    登出
                  </button>
                </div>
              </div>
              <nav className="max-w-6xl mx-auto px-6 py-3 flex gap-3 text-sm flex-wrap">
                {availableTabs.map((tab) => (
                  <button
                    key={tab.key}
                    disabled={tab.disabled}
                    onClick={() => setActiveTab(tab.key)}
                    className={`px-4 py-2 rounded-2xl border ${
                      activeTab === tab.key
                        ? "border-emerald-400 bg-emerald-400/10"
                        : "border-transparent hover:border-slate-700"
                    } ${tab.disabled ? "opacity-50 cursor-not-allowed" : ""}`}
                  >
                    {tab.label}
                  </button>
                ))}
              </nav>
            </header>
            <main className="max-w-6xl mx-auto px-6 py-8 space-y-8">
              {activeTab === "products" && user.permissions?.products && (
                <ProductModule db={db} setDb={setDb} />
              )}
              {activeTab === "products" && !user.permissions?.products && (
                <SectionCard title="無權限">
                  <p className="text-sm text-slate-400">
                    您尚未被授權使用產品資料庫，請聯絡管理員。
                  </p>
                </SectionCard>
              )}
              {activeTab === "users" && user.role === "admin" && (
                <UserManagement db={db} setDb={setDb} currentUser={user} />
              )}
              {activeTab === "ads" && (
                <SectionCard title="廣告文案模組">
                  <p className="text-sm text-slate-400">
                    模組開發中，敬請期待。
                  </p>
                </SectionCard>
              )}
            </main>
          </div>
        );
      };

      const App = () => {
        const [db, setDb] = usePersistentDb();
        const [user, setUser] = useState(null);

        const refreshUser = (target) => {
          if (!target) return;
          setUser({
            ...target,
            permissions: normalizePermissions(target.permissions),
          });
        };

        useEffect(() => {
          if (!user) return;
          const fresh = db.users.find((u) => u.id === user.id);
          if (fresh) {
            const next = {
              ...fresh,
              permissions: normalizePermissions(fresh.permissions),
            };
            if (JSON.stringify(next) !== JSON.stringify(user)) {
              setUser(next);
            }
          }
        }, [db.users]);

        const handleLogin = ({ username, password }) => {
          const found = db.users.find(
            (u) => u.username === username && u.password === password
          );
          if (found) {
            refreshUser(found);
            return true;
          }
          return false;
        };

        const handleLogout = () => setUser(null);

        const handleResetStorage = () => {
          if (
            window.confirm(
              "此動作會清除本機已儲存的資料庫並重新載入預設帳號。確定要繼續？"
            )
          ) {
            localStorage.removeItem(STORAGE_KEY);
            window.location.reload();
          }
        };

        return user ? (
          <Dashboard
            user={user}
            onLogout={handleLogout}
            db={db}
            setDb={setDb}
          />
        ) : (
          <LoginForm onLogin={handleLogin} onResetStorage={handleResetStorage} />
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </body>
</html>


