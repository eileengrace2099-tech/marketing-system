<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡ŒéŠ·ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        .icon { display: inline-block; width: 1.25rem; height: 1.25rem; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ç°¡åŒ–çš„åœ–ç¤ºçµ„ä»¶
        const Icon = ({ d, className = "w-5 h-5" }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={d} />
            </svg>
        );

        const icons = {
            Plus: "M12 4v16m8-8H4",
            Edit: "M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z",
            Trash: "M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16",
            Save: "M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4",
            X: "M6 18L18 6M6 6l12 12",
            Search: "M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z",
            Download: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4",
            Upload: "M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12",
            Image: "M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z",
            Lock: "M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z",
            User: "M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z",
            Shield: "M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z",
            Logout: "M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1",
            Eye: "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
        };

        function MarketingSystem() {
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [currentUser, setCurrentUser] = useState(null);
            const [currentPage, setCurrentPage] = useState('dashboard');
            const [users, setUsers] = useState([]);
            const [products, setProducts] = useState([]);
            const [categories, setCategories] = useState(['ä¿é¤Šå“', 'æ¸…æ½”ç”¨å“', 'ç¾å¦']);
            const [channels, setChannels] = useState(['å®˜ç¶²', 'è¦çš®', 'å±ˆè‡£æ°']);

            const PERMISSIONS = {
                VIEW_PRODUCTS: 'æŸ¥çœ‹ç”¢å“',
                ADD_PRODUCTS: 'æ–°å¢ç”¢å“',
                EDIT_PRODUCTS: 'ç·¨è¼¯ç”¢å“',
                DELETE_PRODUCTS: 'åˆªé™¤ç”¢å“',
                MANAGE_USERS: 'ç®¡ç†ä½¿ç”¨è€…',
                EXPORT_DATA: 'åŒ¯å‡ºè³‡æ–™'
            };

            useEffect(() => {
                loadData();
            }, []);

            const loadData = async () => {
                try {
                    const usersData = await window.storage.get('users');
                    const productsData = await window.storage.get('products');
                    const categoriesData = await window.storage.get('categories');
                    const channelsData = await window.storage.get('channels');
                    const sessionData = await window.storage.get('session');

                    if (usersData) setUsers(JSON.parse(usersData.value));
                    else {
                        const admin = {
                            id: '1',
                            username: 'admin',
                            password: 'admin123',
                            role: 'ç®¡ç†å“¡',
                            permissions: Object.keys(PERMISSIONS)
                        };
                        setUsers([admin]);
                        await window.storage.set('users', JSON.stringify([admin]));
                    }

                    if (productsData) setProducts(JSON.parse(productsData.value));
                    if (categoriesData) setCategories(JSON.parse(categoriesData.value));
                    if (channelsData) setChannels(JSON.parse(channelsData.value));
                    
                    if (sessionData) {
                        const session = JSON.parse(sessionData.value);
                        if (session.expiry > Date.now()) {
                            setCurrentUser(session.user);
                            setIsLoggedIn(true);
                        }
                    }
                } catch (error) {
                    console.log('åˆå§‹åŒ–ç³»çµ±');
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const username = e.target.username.value;
                const password = e.target.password.value;
                const user = users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    const session = { user, expiry: Date.now() + 24*60*60*1000 };
                    await window.storage.set('session', JSON.stringify(session));
                    setCurrentUser(user);
                    setIsLoggedIn(true);
                } else {
                    alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
                }
            };

            const handleLogout = async () => {
                await window.storage.delete('session');
                setCurrentUser(null);
                setIsLoggedIn(false);
                setCurrentPage('dashboard');
            };

            const hasPermission = (perm) => currentUser?.permissions?.includes(perm);

            const saveProducts = async (newProducts) => {
                setProducts(newProducts);
                await window.storage.set('products', JSON.stringify(newProducts));
            };

            const addProduct = async (product) => {
                const newProducts = [...products, { ...product, id: Date.now().toString() }];
                await saveProducts(newProducts);
            };

            const updateProduct = async (id, updatedProduct) => {
                const newProducts = products.map(p => p.id === id ? { ...updatedProduct, id } : p);
                await saveProducts(newProducts);
            };

            const deleteProduct = async (id) => {
                if (window.confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç”¢å“ï¼Ÿ')) {
                    const newProducts = products.filter(p => p.id !== id);
                    await saveProducts(newProducts);
                }
            };

            const exportToExcel = () => {
                let csv = '\uFEFFç”¢å“ç·¨è™Ÿ,ä¸­æ–‡å“å,è‹±æ–‡å“å,å¤§åˆ†é¡,ç”¢å“ç¶½è™Ÿ\n';
                products.forEach(p => {
                    csv += `"${p.code || ''}","${p.nameCh || ''}","${p.nameEn || ''}","${p.category || ''}","${p.nickname || ''}"\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `ç”¢å“è³‡æ–™_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                            <div className="text-center mb-8">
                                <div className="inline-block p-4 bg-blue-100 rounded-full mb-4">
                                    <Icon d={icons.Lock} className="w-12 h-12 text-blue-600" />
                                </div>
                                <h1 className="text-3xl font-bold text-gray-800">è¡ŒéŠ·ç®¡ç†ç³»çµ±</h1>
                                <p className="text-gray-600 mt-2">è«‹ç™»å…¥ä»¥ç¹¼çºŒä½¿ç”¨</p>
                            </div>
                            <form onSubmit={handleLogin} className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">å¸³è™Ÿ</label>
                                    <input name="username" type="text" required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                                    <input name="password" type="password" required className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
                                </div>
                                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold">ç™»å…¥</button>
                            </form>
                            <div className="mt-6 p-4 bg-gray-50 rounded-lg text-center">
                                <p className="text-xs text-gray-600">é è¨­ç®¡ç†å“¡</p>
                                <p className="text-sm text-gray-800 mt-1">å¸³è™Ÿ: <strong>admin</strong> / å¯†ç¢¼: <strong>admin123</strong></p>
                            </div>
                        </div>
                    </div>
                );
            }

            if (currentPage === 'dashboard') {
                return <Dashboard 
                    user={currentUser} 
                    products={products}
                    users={users}
                    onNavigate={setCurrentPage}
                    onLogout={handleLogout}
                    hasPermission={hasPermission}
                />;
            }

            if (currentPage === 'products') {
                return <ProductsPage
                    user={currentUser}
                    products={products}
                    categories={categories}
                    channels={channels}
                    onAdd={addProduct}
                    onUpdate={updateProduct}
                    onDelete={deleteProduct}
                    onExport={exportToExcel}
                    onBack={() => setCurrentPage('dashboard')}
                    onLogout={handleLogout}
                    hasPermission={hasPermission}
                />;
            }

            return null;
        }

        function Dashboard({ user, products, users, onNavigate, onLogout, hasPermission }) {
            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-white shadow border-b">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">è¡ŒéŠ·ç®¡ç†ç³»çµ±</h1>
                                <p className="text-sm text-gray-600">æ­¡è¿, {user.username} ({user.role})</p>
                            </div>
                            <button onClick={onLogout} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                                <Icon d={icons.Logout} className="w-4 h-4" /> ç™»å‡º
                            </button>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white rounded-xl shadow p-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-600 text-sm">ç¸½ç”¢å“æ•¸</p>
                                        <p className="text-3xl font-bold text-blue-600">{products.length}</p>
                                    </div>
                                    <div className="text-4xl">ğŸ“¦</div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow p-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-600 text-sm">ä½¿ç”¨è€…æ•¸</p>
                                        <p className="text-3xl font-bold text-green-600">{users.length}</p>
                                    </div>
                                    <div className="text-4xl">ğŸ‘¥</div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow p-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-600 text-sm">ç³»çµ±ç‹€æ…‹</p>
                                        <p className="text-lg font-bold text-green-600">é‹è¡Œä¸­</p>
                                    </div>
                                    <div className="text-4xl">âœ…</div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl shadow p-6">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-600 text-sm">ä»Šæ—¥æ—¥æœŸ</p>
                                        <p className="text-sm font-bold text-purple-600">{new Date().toLocaleDateString('zh-TW')}</p>
                                    </div>
                                    <div className="text-4xl">ğŸ“…</div>
                                </div>
                            </div>
                        </div>

                        <h2 className="text-xl font-bold mb-4">åŠŸèƒ½æ¨¡çµ„</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                            {hasPermission('VIEW_PRODUCTS') && (
                                <button onClick={() => onNavigate('products')} className="group bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg hover:shadow-xl p-6 text-white transition-all hover:scale-105">
                                    <div className="text-5xl mb-3">ğŸ“¦</div>
                                    <h3 className="text-xl font-bold mb-2">ç”¢å“è³‡æ–™åº«</h3>
                                    <p className="text-sm text-white/90 mb-3">ç®¡ç†ç”¢å“è³‡è¨Šã€åœ–ç‰‡ã€åˆ†é¡</p>
                                    <div className="text-xs bg-white/20 rounded-full px-3 py-1 inline-block">{products.length} å€‹ç”¢å“</div>
                                </button>
                            )}
                            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white opacity-50">
                                <div className="text-5xl mb-3">ğŸ“</div>
                                <h3 className="text-xl font-bold mb-2">å»£å‘Šæ–‡æ¡ˆç®¡ç†</h3>
                                <p className="text-sm text-white/90 mb-3">æ’°å¯«ã€ç®¡ç†å»£å‘Šæ–‡æ¡ˆ</p>
                                <div className="text-xs bg-white/20 rounded-full px-3 py-1 inline-block">å³å°‡æ¨å‡º</div>
                            </div>
                            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white opacity-50">
                                <div className="text-5xl mb-3">ğŸ“Š</div>
                                <h3 className="text-xl font-bold mb-2">æ•¸æ“šåˆ†æ</h3>
                                <p className="text-sm text-white/90 mb-3">éŠ·å”®å ±è¡¨ã€ç”¢å“åˆ†æ</p>
                                <div className="text-xs bg-white/20 rounded-full px-3 py-1 inline-block">å³å°‡æ¨å‡º</div>
                            </div>
                            <div className="bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl shadow-lg p-6 text-white opacity-50">
                                <div className="text-5xl mb-3">ğŸ’¬</div>
                                <h3 className="text-xl font-bold mb-2">LINE å®¢æœ</h3>
                                <p className="text-sm text-white/90 mb-3">è‡ªå‹•å›è¦†ã€å®¢æˆ¶ç®¡ç†</p>
                                <div className="text-xs bg-white/20 rounded-full px-3 py-1 inline-block">å³å°‡æ¨å‡º</div>
                            </div>
                        </div>

                        {products.length > 0 && (
                            <div className="mt-8 bg-white rounded-xl shadow p-6">
                                <h2 className="text-xl font-bold mb-4">æœ€è¿‘æ›´æ–°çš„ç”¢å“</h2>
                                <div className="space-y-3">
                                    {products.slice(-5).reverse().map(p => (
                                        <div key={p.id} className="flex items-center gap-4 p-3 hover:bg-gray-50 rounded-lg">
                                            {p.image ? (
                                                <img src={p.image} alt={p.nameCh} className="w-12 h-12 rounded object-cover" />
                                            ) : (
                                                <div className="w-12 h-12 bg-gray-200 rounded flex items-center justify-center text-gray-400">ğŸ“¦</div>
                                            )}
                                            <div className="flex-1">
                                                <h3 className="font-semibold">{p.nameCh || 'æœªå‘½å'}</h3>
                                                <p className="text-sm text-gray-500">{p.code}</p>
                                            </div>
                                            {p.category && <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{p.category}</span>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ProductsPage({ user, products, categories, channels, onAdd, onUpdate, onDelete, onExport, onBack, onLogout, hasPermission }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [editingProduct, setEditingProduct] = useState(null);
            const [filterCategory, setFilterCategory] = useState('å…¨éƒ¨');
            const [showSearchDialog, setShowSearchDialog] = useState(false);
            const [searchResults, setSearchResults] = useState([]);

            const filteredProducts = products.filter(p => {
                const matchSearch = (p.nameCh || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
                                   (p.code || '').toLowerCase().includes(searchTerm.toLowerCase());
                const matchCategory = filterCategory === 'å…¨éƒ¨' || p.category === filterCategory;
                return matchSearch && matchCategory;
            });

            const handleAdvancedSearch = (searchParams) => {
                const results = products.filter(p => {
                    const matchCode = !searchParams.code || (p.code || '').toLowerCase().includes(searchParams.code.toLowerCase());
                    const matchName = !searchParams.name || (p.nameCh || '').toLowerCase().includes(searchParams.name.toLowerCase()) || (p.nameEn || '').toLowerCase().includes(searchParams.name.toLowerCase());
                    const matchCategory = !searchParams.category || searchParams.category === 'å…¨éƒ¨' || p.category === searchParams.category;
                    const matchNickname = !searchParams.nickname || (p.nickname || '').toLowerCase().includes(searchParams.nickname.toLowerCase());
                    return matchCode && matchName && matchCategory && matchNickname;
                });
                setSearchResults(results);
            };

            const handleSave = (product) => {
                if (editingProduct?.id) {
                    onUpdate(editingProduct.id, product);
                } else {
                    onAdd(product);
                }
                setEditingProduct(null);
            };

            const handleImageUpload = (e, product) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const size = Math.min(img.width, img.height);
                            canvas.width = 800;
                            canvas.height = 800;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, (img.width - size) / 2, (img.height - size) / 2, size, size, 0, 0, 800, 800);
                            setEditingProduct({ ...product, image: canvas.toDataURL('image/jpeg', 0.9) });
                        };
                        img.src = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            if (showSearchDialog) {
                return <SearchDialog 
                    categories={categories}
                    onSearch={handleAdvancedSearch}
                    onClose={() => setShowSearchDialog(false)}
                    results={searchResults}
                    onSelectProduct={(p) => {
                        setEditingProduct(p);
                        setShowSearchDialog(false);
                    }}
                />;
            }

            if (editingProduct) {
                return <ProductForm 
                    product={editingProduct}
                    categories={categories}
                    channels={channels}
                    onSave={handleSave}
                    onCancel={() => setEditingProduct(null)}
                    onImageUpload={(e) => handleImageUpload(e, editingProduct)}
                    onChange={setEditingProduct}
                />;
            }

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-lg shadow p-6 mb-6">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-4">
                                    <button onClick={onBack} className="text-gray-600 hover:text-gray-800">
                                        <Icon d="M10 19l-7-7m0 0l7-7m-7 7h18" className="w-6 h-6" />
                                    </button>
                                    <div>
                                        <h1 className="text-3xl font-bold">ç”¢å“è³‡æ–™åº«</h1>
                                        <p className="text-sm text-gray-600">{user.username} ({user.role})</p>
                                    </div>
                                </div>
                                <div className="flex gap-2 flex-wrap">
                                    {hasPermission('VIEW_PRODUCTS') && (
                                        <button onClick={() => setShowSearchDialog(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2">
                                            <Icon d={icons.Search} /> æŸ¥æ‰¾ç”¢å“
                                        </button>
                                    )}
                                    {hasPermission('ADD_PRODUCTS') && (
                                        <button onClick={() => setEditingProduct({ 
                                            code: '', nameCh: '', nameEn: '', category: '', nickname: '', 
                                            features: [''], channelLinks: [{ channel: '', url: '' }],
                                            channelSkus: [{ channel: '', sku: '' }]
                                        })} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                            <Icon d={icons.Plus} /> æ–°å¢ç”¢å“
                                        </button>
                                    )}
                                    {hasPermission('EXPORT_DATA') && (
                                        <button onClick={onExport} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                            <Icon d={icons.Download} /> åŒ¯å‡º
                                        </button>
                                    )}
                                    <button onClick={onLogout} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                                        <Icon d={icons.Logout} /> ç™»å‡º
                                    </button>
                                </div>
                            </div>

                            <div className="flex gap-4 mb-6">
                                <div className="flex-1 relative">
                                    <Icon d={icons.Search} className="absolute left-3 top-3 text-gray-400" />
                                    <input type="text" placeholder="å¿«é€Ÿæœå°‹ç”¢å“åç¨±æˆ–ç·¨è™Ÿ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-lg" />
                                </div>
                                <select value={filterCategory} onChange={(e) => setFilterCategory(e.target.value)} className="px-4 py-2 border rounded-lg">
                                    <option>å…¨éƒ¨</option>
                                    {categories.map(c => <option key={c}>{c}</option>)}
                                </select>
                            </div>

                            <p className="text-sm text-gray-600">å…± {filteredProducts.length} å€‹ç”¢å“</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {filteredProducts.map(p => (
                                <div key={p.id} className="bg-white rounded-lg shadow hover:shadow-xl transition">
                                    {p.image ? (
                                        <img src={p.image} alt={p.nameCh} className="w-full h-48 object-cover rounded-t-lg" />
                                    ) : (
                                        <div className="w-full h-48 bg-gray-200 flex items-center justify-center text-gray-400 text-4xl rounded-t-lg">ğŸ“¦</div>
                                    )}
                                    <div className="p-4">
                                        <div className="flex justify-between mb-2">
                                            <div>
                                                <h3 className="font-bold text-lg">{p.nameCh}</h3>
                                                <p className="text-sm text-gray-600">{p.nameEn}</p>
                                            </div>
                                            <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded h-fit">{p.code}</span>
                                        </div>
                                        {p.category && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">{p.category}</span>}
                                        {p.nickname && <p className="text-sm text-gray-600 mt-2">ç¶½è™Ÿ: {p.nickname}</p>}
                                        <div className="flex gap-2 mt-4">
                                            {hasPermission('EDIT_PRODUCTS') && (
                                                <button onClick={() => setEditingProduct(p)} className="flex-1 bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600 flex items-center justify-center gap-2">
                                                    <Icon d={icons.Edit} className="w-4 h-4" /> ç·¨è¼¯
                                                </button>
                                            )}
                                            {hasPermission('DELETE_PRODUCTS') && (
                                                <button onClick={() => onDelete(p.id)} className="flex-1 bg-red-500 text-white px-3 py-2 rounded hover:bg-red-600 flex items-center justify-center gap-2">
                                                    <Icon d={icons.Trash} className="w-4 h-4" /> åˆªé™¤
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>

                        {filteredProducts.length === 0 && (
                            <div className="bg-white rounded-lg shadow p-12 text-center">
                                <p className="text-gray-500 text-lg">å°šæœªæ–°å¢ç”¢å“</p>
                                {hasPermission('ADD_PRODUCTS') && (
                                    <button onClick={() => setEditingProduct({ code: '', nameCh: '', nameEn: '', features: [''], channelLinks: [{ channel: '', url: '' }], channelSkus: [{ channel: '', sku: '' }] })} className="mt-4 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                                        æ–°å¢ç¬¬ä¸€å€‹ç”¢å“
                                    </button>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function SearchDialog({ categories, onSearch, onClose, results, onSelectProduct }) {
            const [searchParams, setSearchParams] = useState({
                code: '',
                name: '',
                category: 'å…¨éƒ¨',
                nickname: ''
            });

            const handleSearch = () => {
                onSearch(searchParams);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-lg shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-2xl font-bold">ğŸ” é€²éšæŸ¥æ‰¾ç”¢å“</h2>
                                    <p className="text-sm text-white/80 mt-1">ä½¿ç”¨å¤šå€‹æ¢ä»¶ç²¾ç¢ºæŸ¥æ‰¾ç”¢å“</p>
                                </div>
                                <button onClick={onClose} className="text-white hover:bg-white/20 p-2 rounded-lg">
                                    <Icon d={icons.X} className="w-6 h-6" />
                                </button>
                            </div>
                        </div>

                        <div className="p-6">
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“ç·¨è™Ÿ</label>
                                    <input 
                                        type="text" 
                                        value={searchParams.code}
                                        onChange={(e) => setSearchParams({ ...searchParams, code: e.target.value })}
                                        placeholder="è¼¸å…¥ç”¢å“ç·¨è™Ÿ..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“åç¨±</label>
                                    <input 
                                        type="text"
                                        value={searchParams.name}
                                        onChange={(e) => setSearchParams({ ...searchParams, name: e.target.value })}
                                        placeholder="ä¸­æ–‡æˆ–è‹±æ–‡åç¨±..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“åˆ†é¡</label>
                                    <select 
                                        value={searchParams.category}
                                        onChange={(e) => setSearchParams({ ...searchParams, category: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    >
                                        <option value="å…¨éƒ¨">å…¨éƒ¨åˆ†é¡</option>
                                        {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">ç”¢å“ç¶½è™Ÿ</label>
                                    <input 
                                        type="text"
                                        value={searchParams.nickname}
                                        onChange={(e) => setSearchParams({ ...searchParams, nickname: e.target.value })}
                                        placeholder="è¼¸å…¥ç¶½è™Ÿ..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                                    />
                                </div>
                            </div>

                            <button 
                                onClick={handleSearch}
                                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 font-semibold flex items-center justify-center gap-2"
                            >
                                <Icon d={icons.Search} /> é–‹å§‹æœå°‹
                            </button>

                            {results.length > 0 && (
                                <div className="mt-6">
                                    <h3 className="font-semibold text-gray-800 mb-3">æœå°‹çµæœ ({results.length} å€‹ç”¢å“)</h3>
                                    <div className="max-h-96 overflow-y-auto space-y-3">
                                        {results.map(p => (
                                            <div 
                                                key={p.id} 
                                                onClick={() => onSelectProduct(p)}
                                                className="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 cursor-pointer transition"
                                            >
                                                {p.image ? (
                                                    <img src={p.image} alt={p.nameCh} className="w-16 h-16 object-cover rounded" />
                                                ) : (
                                                    <div className="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-2xl">ğŸ“¦</div>
                                                )}
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-gray-800">{p.nameCh}</h4>
                                                    <p className="text-sm text-gray-600">{p.nameEn}</p>
                                                    <div className="flex gap-2 mt-1">
                                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">{p.code}</span>
                                                        {p.category && <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">{p.category}</span>}
                                                        {p.nickname && <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">{p.nickname}</span>}
                                                    </div>
                                                </div>
                                                <Icon d={icons.Edit} className="w-5 h-5 text-gray-400" />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {results.length === 0 && searchParams.code && (
                                <div className="mt-6 text-center p-8 bg-gray-50 rounded-lg">
                                    <p className="text-gray-500">ğŸ˜• æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„ç”¢å“</p>
                                    <p className="text-sm text-gray-400 mt-2">è©¦è©¦èª¿æ•´æœå°‹æ¢ä»¶</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
                        )}
                    </div>
                </div>
            );
        }

        function ProductForm({ product, categories, channels, onSave, onCancel, onImageUpload, onChange }) {
            const updateField = (field, value) => {
                onChange({ ...product, [field]: value });
            };

            const updateArrayField = (field, index, value) => {
                const newArray = [...(product[field] || [])];
                newArray[index] = value;
                onChange({ ...product, [field]: newArray });
            };

            const addArrayItem = (field, defaultValue = '') => {
                onChange({ ...product, [field]: [...(product[field] || []), defaultValue] });
            };

            const removeArrayItem = (field, index) => {
                onChange({ ...product, [field]: product[field].filter((_, i) => i !== index) });
            };

            return (
                <div className="min-h-screen bg-gray-50 p-6">
                    <div className="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold">{product.id ? 'ç·¨è¼¯ç”¢å“' : 'æ–°å¢ç”¢å“'}</h2>
                            <div className="flex gap-2">
                                <button onClick={() => onSave(product)} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                                    <Icon d={icons.Save} /> å„²å­˜
                                </button>
                                <button onClick={onCancel} className="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 flex items-center gap-2">
                                    <Icon d={icons.X} /> å–æ¶ˆ
                                </button>
                            </div>
                        </div>

                        <div className="space-y-6 max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">ç”¢å“ç·¨è™Ÿ</label>
                                    <input type="text" value={product.code || ''} onChange={(e) => updateField('code', e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">ç”¢å“ç¶½è™Ÿ</label>
                                    <input type="text" value={product.nickname || ''} onChange={(e) => updateField('nickname', e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-2">ä¸­æ–‡å“å</label>
                                    <input type="text" value={product.nameCh || ''} onChange={(e) => updateField('nameCh', e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">è‹±æ–‡å“å</label>
                                    <input type="text" value={product.nameEn || ''} onChange={(e) => updateField('nameEn', e.target.value)} className="w-full px-3 py-2 border rounded-lg" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">å¤§åˆ†é¡</label>
                                <select value={product.category || ''} onChange={(e) => updateField('category', e.target.value)} className="w-full px-3 py-2 border rounded-lg">
                                    <option value="">é¸æ“‡åˆ†é¡</option>
                                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">ç”¢å“åœ–ç‰‡ (è‡ªå‹•è£åˆ‡ç‚ºæ­£æ–¹å½¢ 800x800)</label>
                                <div className="flex items-start gap-4">
                                    <div className="flex flex-col gap-2">
                                        <input type="file" accept="image/*" onChange={onImageUpload} className="hidden" id="imageUpload" />
                                        <label htmlFor="imageUpload" className="cursor-pointer bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                            <Icon d={icons.Image} /> ä¸Šå‚³åœ–ç‰‡
                                        </label>
                                        {product.image && (
                                            <button onClick={() => updateField('image', '')} className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                                                <Icon d={icons.Trash} /> åˆªé™¤åœ–ç‰‡
                                            </button>
                                        )}
                                    </div>
                                    {product.image ? (
                                        <div>
                                            <img src={product.image} alt="ç”¢å“" className="h-32 w-32 object-cover rounded-lg border-2" />
                                            <p className="text-xs text-gray-500 mt-1 text-center">800x800 åƒç´ </p>
                                        </div>
                                    ) : (
                                        <div className="h-32 w-32 bg-gray-100 rounded-lg border-2 border-dashed flex items-center justify-center text-gray-400">æœªä¸Šå‚³</div>
                                    )}
                                </div>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium">ç”¢å“ç‰¹è‰²</label>
                                    <button onClick={() => addArrayItem('features', '')} className="text-blue-600 text-sm flex items-center gap-1">
                                        <Icon d={icons.Plus} className="w-4 h-4" /> æ–°å¢
                                    </button>
                                </div>
                                {(product.features || ['']).map((f, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={f} onChange={(e) => updateArrayField('features', i, e.target.value)} className="flex-1 px-3 py-2 border rounded-lg" placeholder={`ç‰¹è‰² ${i + 1}`} />
                                        <button onClick={() => removeArrayItem('features', i)} className="text-red-600">
                                            <Icon d={icons.Trash} className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium">é€šè·¯çŸ­é€£çµ</label>
                                    <button onClick={() => addArrayItem('channelLinks', { channel: '', url: '' })} className="text-blue-600 text-sm flex items-center gap-1">
                                        <Icon d={icons.Plus} className="w-4 h-4" /> æ–°å¢
                                    </button>
                                </div>
                                {(product.channelLinks || [{ channel: '', url: '' }]).map((link, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={link.channel} onChange={(e) => updateArrayField('channelLinks', i, { ...link, channel: e.target.value })} placeholder="é€šè·¯åç¨±" className="w-32 px-3 py-2 border rounded-lg" />
                                        <input type="text" value={link.url} onChange={(e) => updateArrayField('channelLinks', i, { ...link, url: e.target.value })} placeholder="é€£çµç¶²å€" className="flex-1 px-3 py-2 border rounded-lg" />
                                        <button onClick={() => removeArrayItem('channelLinks', i)} className="text-red-600">
                                            <Icon d={icons.Trash} className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-sm font-medium">é€šè·¯è²¨è™Ÿ</label>
                                    <button onClick={() => addArrayItem('channelSkus', { channel: '', sku: '' })} className="text-blue-600 text-sm flex items-center gap-1">
                                        <Icon d={icons.Plus} className="w-4 h-4" /> æ–°å¢
                                    </button>
                                </div>
                                <div className="mb-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p className="text-xs text-blue-800">ğŸ’¡ è¨˜éŒ„å„é€šè·¯çš„ç”¢å“ç·¨è™Ÿï¼Œæ–¹ä¾¿è¿½è¹¤ç®¡ç†</p>
                                </div>
                                {(product.channelSkus || [{ channel: '', sku: '' }]).map((item, i) => (
                                    <div key={i} className="flex gap-2 mb-2">
                                        <input type="text" value={item.channel} onChange={(e) => updateArrayField('channelSkus', i, { ...item, channel: e.target.value })} placeholder="é€šè·¯åç¨±" className="w-40 px-3 py-2 border rounded-lg" />
                                        <input type="text" value={item.sku} onChange={(e) => updateArrayField('channelSkus', i, { ...item, sku: e.target.value })} placeholder="é€šè·¯è²¨è™Ÿ" className="flex-1 px-3 py-2 border rounded-lg" />
                                        <button onClick={() => removeArrayItem('channelSkus', i)} className="text-red-600">
                                            <Icon d={icons.Trash} className="w-4 h-4" />
                                        </button>
                                    </div>
                                ))}
                            </div>

                            <div>
                                <label className="block text-sm font-medium mb-2">ç”¢å“ä»‹ç´¹</label>
                                <textarea value={product.description || ''} onChange={(e) => updateField('description', e.target.value)} rows="4" className="w-full px-3 py-2 border rounded-lg" placeholder="ç”¢å“è©³ç´°ä»‹ç´¹..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // å•Ÿå‹•æ‡‰ç”¨
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MarketingSystem />);
    </script>
</body>
</html>
