<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¡ŒéŠ·ç®¡ç†ç³»çµ±</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.0.1/build/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // ============================================
      // ğŸ”§ Supabase è¨­å®š
      // ============================================
      // æ–¹æ³• 1ï¼šä½¿ç”¨ Zeabur ç’°å¢ƒè®Šæ•¸ï¼ˆæ¨è–¦ï¼Œæ›´å®‰å…¨ï¼‰
      // åœ¨ Zeabur â†’ Settings â†’ Environment Variables è¨­å®šï¼š
      // - VITE_SUPABASE_URL = ä½ çš„ Supabase Project URL
      // - VITE_SUPABASE_KEY = ä½ çš„ Supabase anon public key
      //
      // æ–¹æ³• 2ï¼šç›´æ¥å¡«å…¥ï¼ˆåƒ…ç”¨æ–¼æœ¬åœ°æ¸¬è©¦ï¼‰
      // å¦‚æœç’°å¢ƒè®Šæ•¸ä¸å­˜åœ¨ï¼Œæœƒä½¿ç”¨ä¸‹é¢çš„é è¨­å€¼
      // ============================================
      const SUPABASE_URL = 
        window.VITE_SUPABASE_URL || 
        'https://rocxusxophynujcrrigu.supabase.co'; // ä½ çš„ Supabase Project URL
      
      const SUPABASE_KEY = 
        window.VITE_SUPABASE_KEY || 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvY3h1c3hvcGh5bnVqY3JyaWd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTYxMDIsImV4cCI6MjA3OTAzMjEwMn0.fB5aSqcGBB7sFoEA596QUDpP8iVO3WtoFltt4oUkqK8'; // ä½ çš„ Supabase API Key
      
      // å¦‚æœé‚„æ²’è¨­å®š Supabaseï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰
      const USE_SUPABASE = SUPABASE_URL && SUPABASE_KEY;
      const supabase = USE_SUPABASE ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

      const STORAGE_KEY = "marketing-system-db";

      const DEFAULT_ADMIN = {
        id: "u-1",
        username: "admin",
        password: "admin",
        displayName: "ç³»çµ±ç®¡ç†å“¡",
        role: "admin",
        permissions: {
          products: true,
          ads: false,
        },
      };

      const DEFAULT_DB = {
        users: [DEFAULT_ADMIN],
        referenceOptions: {
          categories: ["ä¿é¤Š", "ç¾å¦", "ç”Ÿæ´»å®¶é›»"],
          usageFlows: ["æ—¥å¸¸ä¿é¤Š", "å½©å¦æ­¥é©Ÿ", "æ·±å±¤æ¸…æ½”"],
          usageMethods: ["æ—©æ™šä½¿ç”¨", "ç¡å‰ä½¿ç”¨", "é‹å‹•å‰å¾Œ"],
          audiences: ["å¥³æ€§", "ç”·æ€§", "é’å°‘å¹´", "æ•æ„Ÿè‚Œ"],
          painPoints: ["å‡ºæ²¹", "æš—æ²‰", "ç—˜ç—˜", "ä¹¾è£‚"],
          awards: ["FG ç‰¹å„ª", "å¥³äººæˆ‘æœ€å¤§æ¨è–¦", "ç™¾å¤§ç¶²å‹å£ç¢‘"],
          channelLinks: ["å®˜ç¶²", "è¦çš®", "å±ˆè‡£æ°"],
        },
        products: [],
      };

      const strip = (value) => (typeof value === "string" ? value.trim() : "");

      const normalizeFeatures = (features = []) => {
        const list = Array.isArray(features) ? features : [];
        return Array.from({ length: 5 }, (_, index) => strip(list[index] ?? ""));
      };

      const normalizeFaqs = (faqs = []) => {
        if (!Array.isArray(faqs)) return [];
        return faqs
          .map((item) => {
            if (typeof item === "string") {
              return { question: strip(item), answer: "" };
            }
            if (Array.isArray(item)) {
              return {
                question: strip(item[0]),
                answer: strip(item[1]),
              };
            }
            return {
              question: strip(item?.question ?? item?.q ?? ""),
              answer: strip(item?.answer ?? item?.a ?? ""),
            };
          })
          .filter((item) => item.question || item.answer);
      };

      const normalizeRecommendedCombos = (combos = []) => {
        if (!Array.isArray(combos)) return [];
        return combos
          .map((item) => {
            if (typeof item === "string") {
              return { name: strip(item), link: "", reason: "" };
            }
            return {
              name: strip(item?.name ?? item?.title ?? ""),
              link: strip(item?.link ?? item?.url ?? ""),
              reason: strip(item?.reason ?? item?.note ?? ""),
            };
          })
          .filter((item) => item.name || item.link || item.reason);
      };

      const sanitizeProduct = (product) => {
        const channelLinks = Object.fromEntries(
          Object.entries(product.channelLinks || {})
            .map(([channel, url]) => [channel, strip(url)])
            .filter(([, url]) => url)
        );
        const features = normalizeFeatures(product.features);
        const purchaseDecision = Array.isArray(product.purchaseDecision)
          ? product.purchaseDecision.filter(pd => pd && pd.trim())
          : product.purchaseDecision
          ? [product.purchaseDecision].filter(pd => pd && pd.trim())
          : [];
        return {
          ...product,
          productNumber: strip(product.productNumber),
          nameZh: strip(product.nameZh),
          nameEn: strip(product.nameEn),
          nickname: strip(product.nickname),
          usageMethod: strip(product.usageMethod),
          category: strip(product.category),
          usageFlow: strip(product.usageFlow),
          shortDescription: strip(product.shortDescription),
          purchaseDecision,
          faqs: normalizeFaqs(product.faqs),
          recommendedCombos: normalizeRecommendedCombos(product.recommendedCombos),
          features,
          channelLinks,
        };
      };

      // ============================================
      // ğŸ“¦ Supabase è³‡æ–™æ“ä½œå‡½æ•¸
      // ============================================
      const loadFromSupabase = async () => {
        if (!USE_SUPABASE) return null;
        
        try {
          // è¼‰å…¥ users
          const { data: usersData, error: usersError } = await supabase
            .from('users')
            .select('*');
          if (usersError) throw usersError;

          // è¼‰å…¥ products
          const { data: productsData, error: productsError } = await supabase
            .from('products')
            .select('*');
          if (productsError) throw productsError;

          // è¼‰å…¥ reference_options
          const { data: refData, error: refError } = await supabase
            .from('reference_options')
            .select('*');
          if (refError) throw refError;

          // è½‰æ› reference_options æ ¼å¼
          const referenceOptions = {};
          if (refData) {
            refData.forEach((item) => {
              referenceOptions[item.option_key] = item.options || [];
            });
          }

          // è½‰æ› users æ ¼å¼ï¼ˆSupabase ä½¿ç”¨ snake_caseï¼Œå‰ç«¯ä½¿ç”¨ camelCaseï¼‰
          const users = (usersData || []).map((user) => ({
            id: user.id,
            username: user.username,
            password: user.password,
            email: user.email,
            displayName: user.display_name,
            role: user.role,
            permissions: user.permissions || { products: false, ads: false },
          }));

          // è½‰æ› products æ ¼å¼
          const products = (productsData || []).map((product) => ({
            id: product.id,
            productNumber: product.product_number,
            category: product.category,
            usageFlow: product.usage_flow,
            usageMethod: product.usage_method,
            nameZh: product.name_zh,
            nameEn: product.name_en,
            nickname: product.nickname,
            shortDescription: product.short_description,
            purchaseDecision: Array.isArray(product.purchase_decision) 
              ? product.purchase_decision 
              : product.purchase_decision 
              ? [product.purchase_decision] 
              : [],
            channelLinks: product.channel_links || {},
            features: product.features || [],
            audiences: product.audiences || [],
            painPoints: product.pain_points || [],
            awards: product.awards || [],
            images: product.images || [],
            channelSkus: product.channel_skus || [],
            recommendedCombos: product.recommended_combos || [],
            recommendedOthers: product.recommended_others || [],
            highConversionAssets: product.high_conversion_assets || [],
            faqs: product.faqs || [],
          }));

          return {
            users: users,
            products: products,
            referenceOptions: referenceOptions,
          };
        } catch (error) {
          console.error('Supabase è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç”¨ localStorage', error);
          return null;
        }
      };

      const saveToSupabase = async (data) => {
        if (!USE_SUPABASE) return false;

        try {
          // å„²å­˜ users
          if (data.users) {
            for (const user of data.users) {
              const { error } = await supabase
                .from('users')
                .upsert({
                  id: user.id,
                  username: user.username,
                  password: user.password,
                  email: user.email || null,
                  display_name: user.displayName,
                  role: user.role,
                  permissions: user.permissions,
                }, { onConflict: 'id' });
              if (error) throw error;
            }
          }

          // å„²å­˜ products
          if (data.products) {
            for (const product of data.products) {
              const { error } = await supabase
                .from('products')
                .upsert({
                  id: product.id,
                  product_number: product.productNumber,
                  category: product.category,
                  usage_flow: product.usageFlow,
                  usage_method: product.usageMethod,
                  name_zh: product.nameZh,
                  name_en: product.nameEn,
                  nickname: product.nickname,
                  short_description: product.shortDescription,
                  purchase_decision: product.purchaseDecision,
                  channel_links: product.channelLinks || {},
                  features: product.features || [],
                  audiences: product.audiences || [],
                  pain_points: product.painPoints || [],
                  awards: product.awards || [],
                  images: product.images || [],
                  channel_skus: product.channelSkus || [],
                  recommended_combos: product.recommendedCombos || [],
                  recommended_others: product.recommendedOthers || [],
                  high_conversion_assets: product.highConversionAssets || [],
                  faqs: product.faqs || [],
                }, { onConflict: 'id' });
              if (error) throw error;
            }
          }

          // å„²å­˜ reference_options
          if (data.referenceOptions) {
            for (const [key, options] of Object.entries(data.referenceOptions)) {
              const { error } = await supabase
                .from('reference_options')
                .upsert({
                  option_key: key,
                  options: options,
                }, { onConflict: 'option_key' });
              if (error) throw error;
            }
          }

          return true;
        } catch (error) {
          console.error('Supabase å„²å­˜å¤±æ•—ï¼Œæ”¹ç”¨ localStorage', error);
          return false;
        }
      };

      // ============================================
      // ğŸ’¾ æœ¬åœ°å„²å­˜ï¼ˆlocalStorageï¼‰å‡½æ•¸ï¼ˆå‚™ç”¨ï¼‰
      // ============================================
      const saveToStorage = (data) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (error) {
          console.error('localStorage å„²å­˜å¤±æ•—', error);
        }
      };

      const readFromStorage = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : DEFAULT_DB;
        } catch (error) {
          console.error("è®€å– localStorage å¤±æ•—", error);
          return DEFAULT_DB;
        }
      };

      const normalizePermissions = (permissions = {}) => ({
        products: permissions.products ?? true,
        ads: permissions.ads ?? false,
      });

      const ensureDbShape = (data) => {
        const next = { ...DEFAULT_DB, ...data };
        let users = (next.users || []).map((user, index) => ({
          id: user.id || `u-${index + 1}`,
          username: user.username || "",
          password: user.password || "",
          displayName: user.displayName || user.username || "",
          role: user.role || "member",
          permissions: normalizePermissions(user.permissions),
        }));

        const adminIndex = users.findIndex(
          (user) => user.username === DEFAULT_ADMIN.username
        );

        if (adminIndex === -1) {
          users.push({
            ...DEFAULT_ADMIN,
            id: DEFAULT_ADMIN.id || crypto.randomUUID(),
          });
        } else {
          users[adminIndex] = {
            ...DEFAULT_ADMIN,
            ...users[adminIndex],
            password: DEFAULT_ADMIN.password,
            role: "admin",
            permissions: normalizePermissions({
              products: true,
              ads: false,
              ...users[adminIndex].permissions,
            }),
          };
        }

        const hasAdmin = users.some((user) => user.role === "admin");
        if (!hasAdmin) {
          users.push({
            ...DEFAULT_ADMIN,
            id: crypto.randomUUID(),
          });
        }

        next.users = users;
        next.referenceOptions = {
          ...DEFAULT_DB.referenceOptions,
          ...(next.referenceOptions || {}),
        };
        next.products = (next.products || []).map((product, index) =>
          sanitizeProduct({
            id: product.id || `p-${index + 1}`,
            ...product,
          })
        );
        return next;
      };

      const usePersistentDb = () => {
        const [db, setDb] = useState(() => ensureDbShape(readFromStorage()));
        const [isLoading, setIsLoading] = useState(USE_SUPABASE);
        const [storageMode, setStorageMode] = useState(USE_SUPABASE ? 'supabase' : 'localStorage');

        // åˆå§‹åŒ–ï¼šå¾ Supabase è¼‰å…¥è³‡æ–™
        useEffect(() => {
          if (USE_SUPABASE) {
            loadFromSupabase().then((supabaseData) => {
              if (supabaseData) {
                const merged = ensureDbShape({
                  ...readFromStorage(),
                  ...supabaseData,
                });
                setDb(merged);
                setStorageMode('supabase');
                console.log('âœ… Supabase é€£ç·šæˆåŠŸï¼Œè³‡æ–™å·²å¾é›²ç«¯è¼‰å…¥');
              } else {
                setStorageMode('localStorage');
                console.log('â„¹ï¸ ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰');
              }
              setIsLoading(false);
            });
          } else {
            setIsLoading(false);
            console.log('â„¹ï¸ ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰');
          }
        }, []);

        // å„²å­˜è³‡æ–™ï¼šåŒæ™‚å¯«å…¥ Supabase å’Œ localStorage
        useEffect(() => {
          if (isLoading) return;

          // ç¸½æ˜¯å¯«å…¥ localStorageï¼ˆä½œç‚ºå‚™ä»½ï¼‰
          saveToStorage(db);

          // å¦‚æœ Supabase å¯ç”¨ï¼Œä¹Ÿå¯«å…¥ Supabase
          if (USE_SUPABASE && storageMode === 'supabase') {
            saveToSupabase(db).then((success) => {
              if (!success) {
                setStorageMode('localStorage');
                console.warn('âš ï¸ Supabase å„²å­˜å¤±æ•—ï¼Œå·²åˆ‡æ›åˆ° localStorage');
              }
            });
          }
        }, [db, isLoading, storageMode]);

        return [db, setDb, { isLoading, storageMode }];
      };

      const SectionCard = ({ title, actions, children }) => (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-6 shadow-2xl shadow-black/40">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <div className="w-1 h-6 bg-emerald-400 rounded-full"></div>
              <h2 className="text-lg font-semibold tracking-wide">{title}</h2>
            </div>
            {actions}
          </div>
          <div className="space-y-3">{children}</div>
        </div>
      );

      const Badge = ({ label }) => (
        <span className="px-3 py-1 text-xs rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">
          {label}
        </span>
      );

      const LoginForm = ({ onLogin, onResetStorage }) => {
        const [form, setForm] = useState({ username: "", password: "" });
        const [error, setError] = useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          const success = onLogin(form);
          if (!success) {
            setError("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-950">
            <div className="w-full max-w-md space-y-6 bg-slate-900/80 border border-slate-800 rounded-3xl p-10 shadow-2xl shadow-black/70">
              <div>
                <p className="text-emerald-400 uppercase tracking-[0.3em] text-xs mb-2">
                  MARKETING OPS
                </p>
                <h1 className="text-3xl font-semibold mb-2">
                  è¡ŒéŠ·éƒ¨ç®¡ç†ç³»çµ±
                </h1>
                <p className="text-slate-400 text-sm">
                  è«‹å…ˆç™»å…¥ä»¥é€²å…¥ç®¡ç†ä»‹é¢
                </p>
              </div>
              <form className="space-y-4" onSubmit={handleSubmit} autoComplete="off">
                <div>
                  <input
                    type="text"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="off"
                    value={form.username}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, username: e.target.value }))
                    }
                  />
                </div>
                <div>
                  <input
                    type="password"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="new-password"
                    value={form.password}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, password: e.target.value }))
                    }
                  />
                </div>
                {error && (
                  <div className="text-sm text-red-400 bg-red-400/10 border border-red-500/20 px-3 py-2 rounded-xl">
                    {error}
                  </div>
                )}
                <button
                  type="submit"
                  className="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 text-slate-950 font-semibold shadow-lg shadow-emerald-500/30"
                >
                  ç™»å…¥ç³»çµ±
                </button>
              </form>
      
              <button
                type="button"
                onClick={onResetStorage}
                className="w-full text-xs text-slate-400 hover:text-emerald-300 underline mt-2"
              >
                è‹¥ç„¡æ³•ç™»å…¥ï¼Œé»æ­¤æ¸…é™¤æœ¬æ©Ÿè³‡æ–™ä¸¦é‡è¨­
              </button>
            </div>
          </div>
        );
      };

      const OptionEditor = ({ optionKey, label, options, onSave }) => {
        const [value, setValue] = useState("");
        const handleAdd = () => {
          if (!value.trim()) return;
          onSave(optionKey, [...options, value.trim()]);
          setValue("");
        };
        const handleRemove = (item) => {
          onSave(
            optionKey,
            options.filter((opt) => opt !== item)
          );
        };
        return (
          <SectionCard title={`${label} ç®¡ç†`}>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                placeholder={`æ–°å¢${label}`}
                value={value}
                onChange={(e) => setValue(e.target.value)}
              />
              <button
                className="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/40 text-emerald-200"
                onClick={handleAdd}
              >
                æ–°å¢
              </button>
            </div>
            <div className="flex flex-wrap gap-2 mt-2">
              {options.map((opt) => (
                <button
                  key={opt}
                  onClick={() => handleRemove(opt)}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 hover:border-red-400 hover:text-red-200 transition"
                >
                  {opt} Ã—
                </button>
              ))}
              {!options.length && (
                <p className="text-slate-500 text-sm">å°šæœªè¨­å®šä»»ä½•é …ç›®</p>
              )}
            </div>
          </SectionCard>
        );
      };

      const MultiInput = ({ label, values, placeholder, onChange }) => {
        const [input, setInput] = useState("");
        const handleAdd = () => {
          if (!input.trim()) return;
          onChange([...values, input.trim()]);
          setInput("");
        };
        const handleRemove = (item) =>
          onChange(values.filter((val) => val !== item));
        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">{label}</label>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                value={input}
                placeholder={placeholder}
                onChange={(e) => setInput(e.target.value)}
              />
              <button
                type="button"
                onClick={handleAdd}
                className="px-4 py-2 rounded-xl border border-emerald-500/30 text-emerald-300"
              >
                åŠ å…¥
              </button>
            </div>
            <div className="flex flex-wrap gap-2">
              {values.map((val) => (
                <span
                  key={val}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 flex items-center gap-2"
                >
                  {val}
                  <button onClick={() => handleRemove(val)} className="text-red-300">
                    Ã—
                  </button>
                </span>
              ))}
            </div>
          </div>
        );
      };

      const FiveFeaturesInput = ({ values = [], onChange }) => {
        const normalized = normalizeFeatures(values);

        const handleChange = (index, value) => {
          const next = [...normalized];
          next[index] = value;
          onChange(next);
        };

        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">ç”¢å“ä¸»è¦äº”å¤§ç‰¹è‰²</label>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {normalized.map((feature, index) => (
                <input
                  key={index}
                  className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                  placeholder={`ç‰¹è‰² ${index + 1}`}
                  value={feature}
                  onChange={(e) => handleChange(index, e.target.value)}
                />
              ))}
            </div>
            <p className="text-xs text-slate-500">
              è«‹è¼¸å…¥æœ€å¤šäº”å€‹ç”¢å“äº®é»ï¼›å¯ç•™ç©ºçš„æ¬„ä½æœƒè‡ªå‹•å¿½ç•¥ã€‚
            </p>
          </div>
        );
      };

      const FAQEditor = ({ items = [], onChange }) => {
        const handleAdd = () =>
          onChange([...(items || []), { question: "", answer: "" }]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">å¸¸è¦‹å•ç­”</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                æ–°å¢å•ç­”
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder={`å•é¡Œ #${index + 1}`}
                      value={item.question}
                      onChange={(e) =>
                        handleChange(index, "question", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="ç­”æ¡ˆ"
                      value={item.answer}
                      onChange={(e) =>
                        handleChange(index, "answer", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      åˆªé™¤æ­¤å•ç­”
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">å°šæœªæ–°å¢å•ç­”</p>
              )}
            </div>
          </div>
        );
      };

      const ComboEditor = ({ items = [], onChange }) => {
        const handleAdd = () =>
          onChange([
            ...(items || []),
            { name: "", link: "", reason: "" },
          ]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">æ¨è–¦æ­é…ç”¢å“</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                æ–°å¢æ¨è–¦
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="ç”¢å“åç¨±"
                      value={item.name}
                      onChange={(e) =>
                        handleChange(index, "name", e.target.value)
                      }
                    />
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="ç”¢å“è¶…é€£çµï¼ˆå¯é¸ï¼‰"
                      value={item.link}
                      onChange={(e) =>
                        handleChange(index, "link", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="æ¨è–¦åŸå› ï¼ˆå¯æè¿°æ­é…æƒ…å¢ƒï¼‰"
                      value={item.reason}
                      onChange={(e) =>
                        handleChange(index, "reason", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      åˆªé™¤æ­¤æ¨è–¦
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">å°šæœªæ–°å¢æ¨è–¦ç”¢å“</p>
              )}
            </div>
          </div>
        );
      };

      const FileUploader = ({ images, onChange }) => {
        const handleFiles = (files) => {
          const readers = Array.from(files).map(
            (file) =>
              new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsDataURL(file);
              })
          );
          Promise.all(readers).then((results) => {
            onChange([...images, ...results]);
          });
        };
        const handleRemove = (img) => {
          onChange(images.filter((item) => item !== img));
        };
        return (
          <div className="space-y-3">
            <label className="text-sm text-slate-300">ç”¢å“åœ–ç‰‡ (1:1)</label>
            <input
              type="file"
              accept="image/*"
              multiple
              onChange={(e) => handleFiles(e.target.files)}
              className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
            />
            <div className="grid grid-cols-3 gap-3">
              {images.map((img, idx) => (
                <div key={idx} className="relative group">
                  <img
                    src={img}
                    alt="product"
                    className="w-full aspect-square object-cover rounded-2xl border border-slate-800"
                  />
                  <button
                    onClick={() => handleRemove(img)}
                    className="absolute top-2 right-2 bg-black/60 text-xs px-2 py-1 rounded-full hidden group-hover:block"
                  >
                    åˆªé™¤
                  </button>
                </div>
              ))}
              {!images.length && (
                <div className="col-span-3 text-sm text-slate-500">
                  å°šæœªä¸Šå‚³åœ–ç‰‡
                </div>
              )}
            </div>
          </div>
        );
      };

      const ExportPanel = ({ selectedProducts }) => {
        const [fields, setFields] = useState([
          "productNumber",
          "nameZh",
          "nameEn",
          "category",
          "features",
          "channelSkus",
          "shortDescription",
        ]);
        const [previewOpen, setPreviewOpen] = useState(false);

        const fieldConfig = [
          { key: "productNumber", label: "ç”¢å“ç·¨è™Ÿ" },
          { key: "category", label: "å¤§åˆ†é¡" },
          { key: "usageFlow", label: "ä½¿ç”¨ç¨‹åº" },
          { key: "nameZh", label: "ä¸­æ–‡å“å" },
          { key: "nameEn", label: "è‹±æ–‡å“å" },
          { key: "features", label: "äº”å¤§ç‰¹è‰²" },
          { key: "nickname", label: "ç”¢å“ç¶½è™Ÿ" },
          { key: "usageMethod", label: "ç”¢å“ä½¿ç”¨æ–¹å¼" },
          { key: "audiences", label: "ç”¢å“å—çœ¾" },
          { key: "painPoints", label: "ç”¢å“ç—›é»" },
          { key: "awards", label: "å¾—çæ¦®è­½" },
          { key: "channelSkus", label: "é€šè·¯è²¨è™Ÿ" },
          { key: "channelLinks", label: "é€šè·¯çŸ­é€£çµ" },
          { key: "purchaseDecision", label: "è³¼è²·æ±ºç­–" },
          { key: "faqs", label: "å¸¸è¦‹å•ç­”" },
          { key: "shortDescription", label: "ç”¢å“ä»‹ç´¹çŸ­æ–‡" },
          { key: "recommendedCombos", label: "æ¨è–¦æ­é…ç”¢å“" },
          { key: "recommendedOthers", label: "æ¨è–¦å…¶ä»–ç”¢å“" },
          { key: "highConversionAssets", label: "é«˜è½‰æ›ç´ æ" },
        ];

        const toggleField = (key) => {
          setFields((prev) =>
            prev.includes(key) ? prev.filter((item) => item !== key) : [...prev, key]
          );
        };

        const formatFieldValue = (field, value) => {
          if (value === null || value === undefined) return "";
          if (Array.isArray(value)) {
            if (!value.length) return "";
            if (field === "faqs") {
              return value
                .map(
                  (item, idx) =>
                    `Q${idx + 1}: ${item?.question || ""}\nA${idx + 1}: ${
                      item?.answer || ""
                    }`
                )
                .join("\n");
            }
            if (field === "recommendedCombos") {
              return value
                .map((item) => {
                  const parts = [item?.name || ""];
                  if (item?.link) parts.push(item.link);
                  if (item?.reason) parts.push(item.reason);
                  return parts.filter(Boolean).join(" | ");
                })
                .join("\n");
            }
            return value
              .map((v) =>
                typeof v === "object" ? Object.values(v).join(" / ") : v
              )
              .join("\n");
          }
          if (typeof value === "object") {
            return Object.entries(value)
              .map(([k, v]) => `${k}: ${v}`)
              .join("\n");
          }
          if (typeof value === "string") return strip(value);
          return String(value ?? "");
        };

        const buildRows = () =>
          selectedProducts.map((product) => {
            const row = {};
            fields.forEach((field) => {
              row[field] = formatFieldValue(field, product[field]);
            });
            return row;
          });

        const handleExport = async (type) => {
          if (!selectedProducts.length) {
            alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹ç”¢å“");
            return;
          }
          const rows = buildRows();
          if (type === "excel") {
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
            XLSX.writeFile(workbook, "products.xlsx");
          } else if (type === "pdf") {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt" });
            rows.forEach((row, index) => {
              const startY = 40 + index * 220;
              if (startY > 720) {
                doc.addPage();
              }
              let line = 0;
              Object.entries(row).forEach(([key, value]) => {
                const text = `${key}: ${value}`;
                const lines = doc.splitTextToSize(text, 500);
                doc.text(lines, 40, 60 + line * 16 + index * 200);
                line += lines.length;
              });
              doc.line(30, 220 + index * 200, 560, 220 + index * 200);
            });
            doc.save("products.pdf");
          } else if (type === "word") {
            const doc = new docx.Document({
              sections: [
                {
                  properties: {},
                  children: rows.map(
                    (row) =>
                      new docx.Paragraph({
                        children: Object.entries(row).map(
                          ([key, value]) =>
                            new docx.TextRun({
                              text: `${key}: ${value}`,
                              break: 1,
                            })
                        ),
                      })
                  ),
                },
              ],
            });
            const blob = await docx.Packer.toBlob(doc);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "products.docx";
            document.body.appendChild(link);
            link.click();
            link.remove();
          }
        };

        return (
          <SectionCard
            title="åŒ¯å‡ºä¸­å¿ƒ"
            actions={
              <button
                onClick={() => setPreviewOpen(!previewOpen)}
                className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
              >
                {previewOpen ? "é—œé–‰é è¦½" : "åŒ¯å‡ºé è¦½"}
              </button>
            }
          >
            <div className="space-y-3 text-sm">
              <p className="text-slate-400">
                å·²é¸ {selectedProducts.length} é …ç”¢å“ï¼Œè«‹é¸æ“‡è¦åŒ¯å‡ºçš„æ¬„ä½èˆ‡æ ¼å¼ã€‚
              </p>
              <div className="grid grid-cols-2 gap-2">
                {fieldConfig.map(({ key, label }) => (
                  <label
                    key={key}
                    className="flex items-center gap-2 text-xs border border-slate-800 rounded-xl px-2 py-1"
                  >
                    <input
                      type="checkbox"
                      checked={fields.includes(key)}
                      onChange={() => toggleField(key)}
                    />
                    {label}
                  </label>
                ))}
              </div>
              <div className="flex gap-3">
                <button
                  onClick={() => handleExport("excel")}
                  className="flex-1 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/50"
                >
                  åŒ¯å‡º Excel
                </button>
                <button
                  onClick={() => handleExport("word")}
                  className="flex-1 py-2 rounded-xl bg-sky-500/20 border border-sky-500/50"
                >
                  åŒ¯å‡º Word
                </button>
                <button
                  onClick={() => handleExport("pdf")}
                  className="flex-1 py-2 rounded-xl bg-purple-500/20 border border-purple-500/50"
                >
                  åŒ¯å‡º PDF
                </button>
              </div>
              {previewOpen && (
                <div className="border border-slate-800 rounded-xl p-3 bg-slate-950/60 space-y-2 max-h-64 overflow-auto">
                  {selectedProducts.map((product) => (
                    <div key={product.id} className="border border-slate-800 rounded-xl p-3">
                      <p className="font-semibold">{product.nameZh}</p>
                      <p className="text-xs text-slate-400">{product.productNumber}</p>
                      <div className="text-xs text-slate-300 mt-2 space-y-1">
                        {fields.map((field) => (
                          <p key={field} className="whitespace-pre-line">
                            <span className="text-slate-500">{field}ï¼š</span>
                            {formatFieldValue(field, product[field]) || "-"}
                          </p>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </SectionCard>
        );
      };

      const ProductForm = ({
        initialValue,
        referenceOptions,
        onSubmit,
        onCancel,
        onAddReference = () => {},
      }) => {
        const [form, setForm] = useState(() =>
          initialValue
            ? sanitizeProduct(initialValue)
            : {
                id: crypto.randomUUID(),
                productNumber: "",
                category: "",
                usageFlow: "",
                usageMethod: "",
                nameZh: "",
                nameEn: "",
                nickname: "",
                shortDescription: "",
                purchaseDecision: [],
                channelLinks: {},
                features: normalizeFeatures(),
                audiences: [],
                painPoints: [],
                awards: [],
                images: [],
                channelSkus: [],
                recommendedCombos: [],
                recommendedOthers: [],
                highConversionAssets: [],
                faqs: [],
              }
        );

        const updateField = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handleQuickAdd = (optionKey, label, targetField) => {
          const value = window.prompt(`è«‹è¼¸å…¥æ–°çš„${label}`);
          if (!value || !value.trim()) return;
          const trimmed = value.trim();
          onAddReference(optionKey, trimmed);
          updateField(targetField, trimmed);
        };

        const handleChannelSkuAdd = () => {
          setForm((prev) => ({
            ...prev,
            channelSkus: [...prev.channelSkus, { channel: "", sku: "" }],
          }));
        };

        const handleChannelLinkChange = (channel, value) => {
          setForm((prev) => {
            const nextLinks = { ...(prev.channelLinks || {}) };
            if (value) {
              nextLinks[channel] = value;
            } else {
              delete nextLinks[channel];
            }
            return { ...prev, channelLinks: nextLinks };
          });
        };

        const handleListChange = (key, index, field, value) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            ),
          }));
        };

        const handleListRemove = (key, index) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].filter((_, idx) => idx !== index),
          }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(form);
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-6">
            <SectionCard
              title="åŸºæœ¬è³‡è¨Š"
              actions={
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={onCancel}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    å„²å­˜
                  </button>
                </div>
              }
            >
              <div className="grid md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ç”¢å“ç·¨è™Ÿ</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.productNumber}
                    onChange={(e) => updateField("productNumber", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">å¤§åˆ†é¡</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.category}
                      onChange={(e) => updateField("category", e.target.value)}
                    >
                      <option value="">é¸æ“‡åˆ†é¡</option>
                      {referenceOptions.categories.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("categories", "å¤§åˆ†é¡", "category")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + æ–°å¢
                    </button>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">ä½¿ç”¨ç¨‹åºåˆ†é¡</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.usageFlow}
                      onChange={(e) => updateField("usageFlow", e.target.value)}
                    >
                      <option value="">é¸æ“‡åˆ†é¡</option>
                      {referenceOptions.usageFlows.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("usageFlows", "ä½¿ç”¨ç¨‹åºåˆ†é¡", "usageFlow")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + æ–°å¢
                    </button>
                  </div>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ä¸­æ–‡å“å</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameZh}
                    onChange={(e) => updateField("nameZh", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">è‹±æ–‡å“å</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameEn}
                    onChange={(e) => updateField("nameEn", e.target.value)}
                  />
                </div>
              </div>
              <div className="space-y-2">
                <label className="text-sm">ç”¢å“ä»‹ç´¹çŸ­æ–‡</label>
                <textarea
                  className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 min-h-[120px]"
                  value={form.shortDescription}
                  onChange={(e) => updateField("shortDescription", e.target.value)}
                ></textarea>
              </div>
              <div className="space-y-4">
                <FiveFeaturesInput
                  values={form.features}
                  onChange={(values) => updateField("features", values)}
                />
                <ComboEditor
                  items={form.recommendedCombos || []}
                  onChange={(values) => updateField("recommendedCombos", values)}
                />
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <FAQEditor
                  items={form.faqs || []}
                  onChange={(values) => updateField("faqs", values)}
                />
                <div>
                  <label className="block text-sm text-slate-300 mb-2">è³¼è²·æ±ºç­–</label>
                  <MultiInput
                    values={
                      Array.isArray(form.purchaseDecision)
                        ? form.purchaseDecision
                        : form.purchaseDecision
                        ? [form.purchaseDecision]
                        : []
                    }
                    placeholder="è¼¸å…¥è³¼è²·æ±ºç­–è¦é»"
                    onChange={(values) =>
                      updateField("purchaseDecision", values)
                    }
                  />
                </div>
              </div>
            </SectionCard>

            <SectionCard title="é€šè·¯èˆ‡åœ–ç‰‡">
              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <h3 className="text-sm text-slate-300">é€šè·¯è²¨è™Ÿ</h3>
                  <button
                    type="button"
                    onClick={handleChannelSkuAdd}
                    className="px-3 py-1 text-xs rounded-full border border-slate-700"
                  >
                    æ–°å¢é€šè·¯
                  </button>
                </div>
                <div className="space-y-3">
                  {form.channelSkus.map((item, index) => (
                    <div
                      key={index}
                      className="grid md:grid-cols-3 gap-3 bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                    >
                      <input
                        className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                        placeholder="é€šè·¯åç¨±"
                        value={item.channel}
                        onChange={(e) =>
                          handleListChange("channelSkus", index, "channel", e.target.value)
                        }
                      />
                      <input
                        className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                        placeholder="é€šè·¯è²¨è™Ÿ"
                        value={item.sku}
                        onChange={(e) =>
                          handleListChange("channelSkus", index, "sku", e.target.value)
                        }
                      />
                      <button
                        type="button"
                        onClick={() => handleListRemove("channelSkus", index)}
                        className="rounded-xl border border-red-500/40 text-red-300 text-sm"
                      >
                        ç§»é™¤
                      </button>
                    </div>
                  ))}
                  {!form.channelSkus.length && (
                    <p className="text-sm text-slate-500">å°šç„¡é€šè·¯è¨­å®š</p>
                  )}
                </div>
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <h3 className="text-sm text-slate-300">é€šè·¯çŸ­é€£çµ</h3>
                    <p className="text-xs text-slate-500">
                      é€šè·¯é¸é …å¯åœ¨å³å´ã€Œé€šè·¯ç®¡ç†ã€ç·¨è¼¯
                    </p>
                  </div>
                  <div className="space-y-3">
                    {referenceOptions.channelLinks.length ? (
                      referenceOptions.channelLinks.map((channel) => (
                        <div
                          key={channel}
                          className="grid md:grid-cols-3 gap-3 items-center bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                        >
                          <div className="text-sm font-medium text-slate-200">
                            {channel}
                          </div>
                          <div className="md:col-span-2">
                            <input
                              className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                              placeholder="è¼¸å…¥çŸ­ç¶²å€æˆ–å®Œæ•´ç¶²å€"
                              value={form.channelLinks?.[channel] || ""}
                              onChange={(e) =>
                                handleChannelLinkChange(channel, e.target.value)
                              }
                            />
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-sm text-slate-500">
                        å°šæœªè¨­å®šé€šè·¯ï¼Œè«‹è‡³å³å´ã€Œé€šè·¯ç®¡ç†ã€æ–°å¢ã€‚
                      </div>
                    )}
                  </div>
                </div>
                <FileUploader
                  images={form.images}
                  onChange={(images) => updateField("images", images)}
                />
              </div>
            </SectionCard>

            <SectionCard title="å—çœ¾èˆ‡ç—›é»">
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ç”¢å“ä½¿ç”¨æ–¹å¼</label>
                  <input
                    list="usage-method-options"
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    placeholder="è¼¸å…¥æˆ–é¸æ“‡ä½¿ç”¨æ–¹å¼"
                    value={form.usageMethod}
                    onChange={(e) => updateField("usageMethod", e.target.value)}
                  />
                  <datalist id="usage-method-options">
                    {referenceOptions.usageMethods.map((opt) => (
                      <option key={opt} value={opt} />
                    ))}
                  </datalist>
                </div>
                <MultiInput
                  label="ç”¢å“ç¶½è™Ÿ"
                  values={form.nickname ? [form.nickname] : []}
                  placeholder="è¼¸å…¥ç¶½è™Ÿ"
                  onChange={(values) =>
                    updateField("nickname", values.length ? values[0] : "")
                  }
                />
                <MultiInput
                  label="ç”¢å“å—çœ¾"
                  values={form.audiences}
                  placeholder="æ–°å¢å—çœ¾"
                  onChange={(values) => updateField("audiences", values)}
                />
                <MultiInput
                  label="ç”¢å“ç—›é»"
                  values={form.painPoints}
                  placeholder="æ–°å¢ç—›é»"
                  onChange={(values) => updateField("painPoints", values)}
                />
              </div>
              <MultiInput
                label="å¾—çæ¦®è­½"
                values={form.awards}
                placeholder="æ–°å¢å¾—çç´€éŒ„"
                onChange={(values) => updateField("awards", values)}
              />
            </SectionCard>
          </form>
        );
      };

      const ProductList = ({ products, onSelect, selectedIds }) => (
        <SectionCard
          title="ç”¢å“æ¸…å–®"
          actions={<Badge label={`${products.length} é …`} />}
        >
          <div className="space-y-2">
            {products.map((product) => (
              <button
                key={product.id}
                onClick={() => onSelect(product)}
                className={`w-full text-left px-4 py-3 rounded-2xl border ${
                  selectedIds.includes(product.id)
                    ? "border-emerald-400 bg-emerald-400/10"
                    : "border-slate-800 hover:border-emerald-400/40"
                }`}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-semibold">{product.nameZh || "æœªå‘½åç”¢å“"}</p>
                    <p className="text-xs text-slate-400">{product.productNumber}</p>
                  </div>
                  <div className="flex gap-2">
                    {product.category && <Badge label={product.category} />}
                    {product.usageFlow && <Badge label={product.usageFlow} />}
                  </div>
                </div>
              </button>
            ))}
            {!products.length && (
              <div className="text-center text-sm text-slate-500 py-10">
                å°šç„¡ç”¢å“ï¼Œè«‹å…ˆå»ºç«‹ã€‚
              </div>
            )}
          </div>
        </SectionCard>
      );

      const ProductModule = ({ db, setDb }) => {
        const [mode, setMode] = useState("list");
        const [editingProduct, setEditingProduct] = useState(null);
        const [selected, setSelected] = useState([]);
        const [search, setSearch] = useState("");
        const [filterCategory, setFilterCategory] = useState("");

        const filteredProducts = useMemo(() => {
          return db.products.filter((p) => {
            const matchCategory = filterCategory ? p.category === filterCategory : true;
            const matchSearch = search
              ? (p.nameZh || "").includes(search) ||
                (p.nameEn || "").includes(search) ||
                (p.productNumber || "").includes(search)
              : true;
            return matchCategory && matchSearch;
          });
        }, [db.products, search, filterCategory]);

        const handleSaveProduct = (product) => {
          const cleanProduct = sanitizeProduct(product);
          setDb((prev) => {
            const exists = prev.products.some((p) => p.id === cleanProduct.id);
            const products = exists
              ? prev.products.map((p) =>
                  p.id === cleanProduct.id ? cleanProduct : p
                )
              : [...prev.products, cleanProduct];
            return { ...prev, products };
          });
          setMode("list");
          setEditingProduct(null);
        };

        const handleDelete = (product) => {
          if (!window.confirm("ç¢ºå®šåˆªé™¤æ­¤ç”¢å“ï¼Ÿ")) return;
          setDb((prev) => ({
            ...prev,
            products: prev.products.filter((p) => p.id !== product.id),
          }));
          setSelected((prev) => prev.filter((id) => id !== product.id));
        };

        const handleReferenceSave = (key, items) => {
          setDb((prev) => ({
            ...prev,
            referenceOptions: {
              ...prev.referenceOptions,
              [key]: items,
            },
          }));
        };

        const handleReferenceAdd = (key, value) => {
          if (!value || !value.trim()) return;
          setDb((prev) => {
            const current = prev.referenceOptions[key] || [];
            if (current.includes(value)) return prev;
            return {
              ...prev,
              referenceOptions: {
                ...prev.referenceOptions,
                [key]: [...current, value],
              },
            };
          });
        };

        const toggleSelect = (product) => {
          setSelected((prev) =>
            prev.includes(product.id)
              ? prev.filter((id) => id !== product.id)
              : [...prev, product.id]
          );
        };

        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              {mode === "list" && (
                <>
                  <SectionCard
                    title="æŸ¥æ‰¾ç”¢å“"
                    actions={
                      <button
                        onClick={() => {
                          setMode("edit");
                          setEditingProduct(null);
                        }}
                        className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                      >
                        æ–°å¢ç”¢å“
                      </button>
                    }
                  >
                    <div className="grid md:grid-cols-3 gap-3">
                      <input
                        placeholder="è¼¸å…¥å“å / ç·¨è™Ÿ"
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                      />
                      <select
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={filterCategory}
                        onChange={(e) => setFilterCategory(e.target.value)}
                      >
                        <option value="">å…¨éƒ¨åˆ†é¡</option>
                        {db.referenceOptions.categories.map((cat) => (
                          <option key={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                  </SectionCard>
                  <ProductList
                    products={filteredProducts}
                    selectedIds={selected}
                    onSelect={(product) => {
                      setEditingProduct(product);
                      setMode("details");
                    }}
                  />
                </>
              )}
              {mode === "edit" && (
                <ProductForm
                  initialValue={editingProduct}
                  referenceOptions={db.referenceOptions}
                  onSubmit={handleSaveProduct}
                  onAddReference={handleReferenceAdd}
                  onCancel={() => {
                    setMode("list");
                    setEditingProduct(null);
                  }}
                />
              )}
              {mode === "details" && editingProduct && (
                <SectionCard
                  title={editingProduct.nameZh || "ç”¢å“è©³æƒ…"}
                  actions={
                    <div className="flex gap-2">
                      <button
                        onClick={() => toggleSelect(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        {selected.includes(editingProduct.id) ? "å–æ¶ˆå‹¾é¸" : "å‹¾é¸åŒ¯å‡º"}
                      </button>
                      <button
                        onClick={() => {
                          setMode("edit");
                        }}
                        className="px-3 py-1 rounded-xl border border-emerald-400/40 text-xs"
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        onClick={() => handleDelete(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        åˆªé™¤
                      </button>
                      <button
                        onClick={() => {
                          setMode("list");
                          setEditingProduct(null);
                        }}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        è¿”å›åˆ—è¡¨
                      </button>
                    </div>
                  }
                >
                  <div className="grid md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="text-slate-400">ç”¢å“ç·¨è™Ÿ</p>
                      <p>{editingProduct.productNumber || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">å¤§åˆ†é¡</p>
                      <p>{editingProduct.category || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ä½¿ç”¨ç¨‹åº</p>
                      <p>{editingProduct.usageFlow || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ä¸­æ–‡å“å</p>
                      <p>{editingProduct.nameZh || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">è‹±æ–‡å“å</p>
                      <p>{editingProduct.nameEn || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ç”¢å“ç¶½è™Ÿ</p>
                      <p>{editingProduct.nickname || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ç”¢å“ä½¿ç”¨æ–¹å¼</p>
                      <p>{editingProduct.usageMethod || "-"}</p>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">äº”å¤§ç‰¹è‰²</p>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {editingProduct.features?.filter(f => f).map((f, idx) => (
                          <Badge key={idx} label={f} />
                        ))}
                        {(!editingProduct.features || editingProduct.features.filter(f => f).length === 0) && (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">ç”¢å“å—çœ¾</p>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {editingProduct.audiences?.map((a, idx) => (
                          <Badge key={idx} label={a} />
                        ))}
                        {(!editingProduct.audiences || editingProduct.audiences.length === 0) && (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">ç”¢å“ç—›é»</p>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {editingProduct.painPoints?.map((p, idx) => (
                          <Badge key={idx} label={p} />
                        ))}
                        {(!editingProduct.painPoints || editingProduct.painPoints.length === 0) && (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">å¾—çæ¦®è­½</p>
                      <div className="flex flex-wrap gap-2 mt-1">
                        {editingProduct.awards?.map((a, idx) => (
                          <Badge key={idx} label={a} />
                        ))}
                        {(!editingProduct.awards || editingProduct.awards.length === 0) && (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">é€šè·¯è²¨è™Ÿ</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.channelSkus?.length > 0 ? (
                          editingProduct.channelSkus.map((item, idx) => (
                            <div key={idx} className="text-xs bg-slate-800/50 p-2 rounded">
                              <span className="text-slate-300">{item.channel}</span>ï¼š
                              <span className="text-slate-200 ml-1">{item.sku}</span>
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">é€šè·¯çŸ­é€£çµ</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.channelLinks && Object.keys(editingProduct.channelLinks).length > 0 ? (
                          Object.entries(editingProduct.channelLinks).map(([channel, url]) => (
                            <div key={channel} className="text-xs bg-slate-800/50 p-2 rounded">
                              <span className="text-slate-300">{channel}</span>ï¼š
                              <a href={url} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline ml-1">
                                {url}
                              </a>
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">è³¼è²·æ±ºç­–</p>
                      <div className="space-y-2 mt-1">
                        {Array.isArray(editingProduct.purchaseDecision) && editingProduct.purchaseDecision.length > 0 ? (
                          editingProduct.purchaseDecision.map((item, idx) => (
                            <div key={idx} className="text-xs bg-slate-800/50 p-2 rounded">
                              {item}
                            </div>
                          ))
                        ) : editingProduct.purchaseDecision ? (
                          <div className="text-xs bg-slate-800/50 p-2 rounded">
                            {editingProduct.purchaseDecision}
                          </div>
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">å¸¸è¦‹å•ç­”</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.faqs?.length > 0 ? (
                          editingProduct.faqs.map((faq, idx) => (
                            <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                              <p className="text-emerald-400 font-semibold mb-1">Q{idx + 1}: {faq.question || "-"}</p>
                              <p className="text-slate-300 text-xs">A: {faq.answer || "-"}</p>
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">ç”¢å“ä»‹ç´¹çŸ­æ–‡</p>
                      <p className="mt-1 whitespace-pre-wrap">{editingProduct.shortDescription || "-"}</p>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">æ¨è–¦æ­é…ç”¢å“</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.recommendedCombos?.length > 0 ? (
                          editingProduct.recommendedCombos.map((item, idx) => (
                            <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                              <p className="text-slate-200 font-semibold">{item.name || "-"}</p>
                              {item.link && (
                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                                  {item.link}
                                </a>
                              )}
                              {item.reason && (
                                <p className="text-slate-400 text-xs mt-1">åŸå› ï¼š{item.reason}</p>
                              )}
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">æ¨è–¦å…¶ä»–ç”¢å“</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.recommendedOthers?.length > 0 ? (
                          editingProduct.recommendedOthers.map((item, idx) => (
                            <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                              <p className="text-slate-200 font-semibold">{item.name || "-"}</p>
                              {item.link && (
                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                                  {item.link}
                                </a>
                              )}
                              {item.reason && (
                                <p className="text-slate-400 text-xs mt-1">åŸå› ï¼š{item.reason}</p>
                              )}
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                    <div className="md:col-span-2">
                      <p className="text-slate-400">é«˜è½‰æ›ç´ æ</p>
                      <div className="space-y-2 mt-1">
                        {editingProduct.highConversionAssets?.length > 0 ? (
                          editingProduct.highConversionAssets.map((item, idx) => (
                            <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                              <p className="text-slate-200 font-semibold">{item.title || "-"}</p>
                              {item.content && (
                                <p className="text-slate-300 text-xs mt-1">{item.content}</p>
                              )}
                              {item.link && (
                                <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                                  {item.link}
                                </a>
                              )}
                            </div>
                          ))
                        ) : (
                          <span className="text-slate-500">-</span>
                        )}
                      </div>
                    </div>
                  </div>
                  {editingProduct.images?.length > 0 && (
                    <div className="grid grid-cols-3 gap-3 mt-4">
                      {editingProduct.images.map((img, idx) => (
                        <img
                          key={idx}
                          src={img}
                          className="rounded-2xl border border-slate-800"
                        />
                      ))}
                    </div>
                  )}
                </SectionCard>
              )}
            </div>
            <div className="space-y-6">
              <ExportPanel
                selectedProducts={db.products.filter((p) => selected.includes(p.id))}
              />
              <OptionEditor
                optionKey="categories"
                label="å¤§åˆ†é¡"
                options={db.referenceOptions.categories}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageFlows"
                label="ä½¿ç”¨ç¨‹åºåˆ†é¡"
                options={db.referenceOptions.usageFlows}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageMethods"
                label="ä½¿ç”¨æ–¹å¼"
                options={db.referenceOptions.usageMethods}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="channelLinks"
                label="é€šè·¯ç®¡ç†"
                options={db.referenceOptions.channelLinks}
                onSave={handleReferenceSave}
              />
            </div>
          </div>
        );
      };

      const PermissionBadges = ({ permissions }) => (
        <div className="flex flex-wrap gap-2">
          {Object.entries(permissions).map(([key, value]) =>
            value ? (
              <Badge
                key={key}
                label={
                  {
                    products: "ç”¢å“è³‡æ–™åº«",
                    ads: "å»£å‘Šæ–‡æ¡ˆ",
                  }[key] || key
                }
              />
            ) : null
          )}
        </div>
      );

      const UserManagement = ({ db, setDb, currentUser }) => {
        const emptyUser = {
          id: "",
          username: "",
          password: "",
          displayName: "",
          role: "member",
          permissions: { products: false, ads: false },
        };

        const [form, setForm] = useState(emptyUser);
        const [isEditing, setIsEditing] = useState(false);

        const openCreate = () => {
          setForm({ ...emptyUser, id: crypto.randomUUID() });
          setIsEditing(false);
        };

        const openEdit = (user) => {
          setForm({
            ...user,
            permissions: normalizePermissions(user.permissions),
          });
          setIsEditing(true);
        };

        const resetForm = () => {
          setForm(emptyUser);
          setIsEditing(false);
        };

        const handleChange = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handlePermissionChange = (key) => {
          setForm((prev) => ({
            ...prev,
            permissions: {
              ...prev.permissions,
              [key]: !prev.permissions[key],
            },
          }));
        };

        const usernameExists = (username, excludeId) =>
          db.users.some(
            (user) =>
              user.username.toLowerCase() === username.toLowerCase() &&
              user.id !== excludeId
          );

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!form.username.trim() || !form.password.trim()) {
            alert("å¸³è™Ÿèˆ‡å¯†ç¢¼ç‚ºå¿…å¡«");
            return;
          }
          if (usernameExists(form.username, form.id)) {
            alert("æ­¤å¸³è™Ÿå·²å­˜åœ¨");
            return;
          }

          const payload = {
            ...form,
            username: form.username.trim(),
            password: form.password,
            displayName: form.displayName.trim() || form.username.trim(),
            role: form.role,
            permissions: normalizePermissions(form.permissions),
          };

          setDb((prev) => {
            const exists = prev.users.some((user) => user.id === payload.id);
            const users = exists
              ? prev.users.map((user) => (user.id === payload.id ? payload : user))
              : [...prev.users, payload];
            return { ...prev, users };
          });
          resetForm();
        };

        const handleDelete = (user) => {
          if (user.id === currentUser.id) {
            alert("ç„¡æ³•åˆªé™¤è‡ªå·±");
            return;
          }
          const admins = db.users.filter((u) => u.role === "admin");
          if (user.role === "admin" && admins.length <= 1) {
            alert("è‡³å°‘éœ€è¦ä¸€ä½ç®¡ç†å“¡");
            return;
          }
          if (!window.confirm(`ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼š${user.username}ï¼Ÿ`)) return;
          setDb((prev) => ({
            ...prev,
            users: prev.users.filter((u) => u.id !== user.id),
          }));
        };

        return (
          <div className="space-y-6">
            <SectionCard
              title="å¸³è™Ÿåˆ—è¡¨"
              actions={
                <button
                  onClick={openCreate}
                  className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                >
                  æ–°å¢å¸³è™Ÿ
                </button>
              }
            >
              <div className="space-y-3 text-sm">
                {db.users.map((user) => (
                  <div
                    key={user.id}
                    className="p-4 rounded-2xl border border-slate-800 bg-slate-950/30 flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
                  >
                    <div>
                      <p className="font-semibold">
                        {user.displayName}{" "}
                        <span className="text-xs uppercase text-slate-400 ml-2">
                          {user.role}
                        </span>
                      </p>
                      <p className="text-xs text-slate-400">{user.username}</p>
                      <PermissionBadges permissions={user.permissions} />
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => openEdit(user)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        onClick={() => handleDelete(user)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        åˆªé™¤
                      </button>
                    </div>
                  </div>
                ))}
                {!db.users.length && (
                  <p className="text-center text-slate-500">å°šç„¡å¸³è™Ÿ</p>
                )}
              </div>
            </SectionCard>

            <SectionCard title={isEditing ? "ç·¨è¼¯å¸³è™Ÿ" : "æ–°å¢å¸³è™Ÿ"}>
              <form className="space-y-4" onSubmit={handleSubmit}>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-sm">å¸³è™Ÿ</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.username}
                      onChange={(e) => handleChange("username", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">å¯†ç¢¼</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.password}
                      onChange={(e) => handleChange("password", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">é¡¯ç¤ºåç¨±</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.displayName}
                      onChange={(e) => handleChange("displayName", e.target.value)}
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">è§’è‰²</label>
                    <select
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.role}
                      onChange={(e) => handleChange("role", e.target.value)}
                    >
                      <option value="admin">admin</option>
                      <option value="editor">editor</option>
                      <option value="member">member</option>
                    </select>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">å¯ä½¿ç”¨ç®¡ç†ä»‹é¢</label>
                  <div className="flex flex-wrap gap-3">
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.products}
                        onChange={() => handlePermissionChange("products")}
                      />
                      ç”¢å“è³‡æ–™åº«
                    </label>
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.ads}
                        onChange={() => handlePermissionChange("ads")}
                      />
                      å»£å‘Šæ–‡æ¡ˆï¼ˆé ç•™ï¼‰
                    </label>
                  </div>
                </div>
                <div className="flex gap-3">
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    {isEditing ? "æ›´æ–°å¸³è™Ÿ" : "å»ºç«‹å¸³è™Ÿ"}
                  </button>
                  <button
                    type="button"
                    onClick={resetForm}
                    className="px-4 py-2 rounded-xl border border-slate-700"
                  >
                    æ¸…ç©º
                  </button>
                </div>
              </form>
            </SectionCard>
          </div>
        );
      };

      const Dashboard = ({ user, onLogout, db, setDb, storageInfo = {} }) => {
        const availableTabs = React.useMemo(
          () =>
            [
              user.permissions?.products && {
                key: "products",
                label: "ç”¢å“è³‡æ–™åº«ç®¡ç†",
                disabled: false,
              },
              user.permissions?.ads && {
                key: "ads",
                label: "å»£å‘Šæ–‡æ¡ˆæ¨¡çµ„ï¼ˆå³å°‡æ¨å‡ºï¼‰",
                disabled: true,
              },
              user.role === "admin" && {
                key: "users",
                label: "æœƒå“¡ç®¡ç†ç³»çµ±",
                disabled: false,
              },
            ].filter(Boolean),
          [user]
        );

        const initialTab = availableTabs[0]?.key || "products";
        const [activeTab, setActiveTab] = useState(initialTab);

        useEffect(() => {
          if (!availableTabs.find((tab) => tab.key === activeTab)) {
            setActiveTab(availableTabs[0]?.key || "products");
          }
        }, [availableTabs, activeTab]);

        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-950 to-slate-900 text-slate-100">
            <header className="border-b border-white/5 bg-black/30 backdrop-blur sticky top-0 z-20">
              <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                <div>
                  <p className="text-xs tracking-[0.3em] text-emerald-400">
                    MARKETING OPS
                  </p>
                  <h1 className="text-xl font-semibold">è¡ŒéŠ·éƒ¨ç®¡ç†ç³»çµ±</h1>
                </div>
                <div className="flex items-center gap-4">
                  {storageInfo.storageMode && (
                    <div className="text-xs px-2 py-1 rounded-full border border-slate-700 bg-slate-900/50">
                      {storageInfo.storageMode === 'supabase' ? (
                        <span className="text-emerald-400">â˜ï¸ é›²ç«¯åŒæ­¥</span>
                      ) : (
                        <span className="text-slate-400">ğŸ’¾ é›¢ç·šæ¨¡å¼</span>
                      )}
                    </div>
                  )}
                  <div className="text-sm">
                    <p className="font-semibold">{user.displayName}</p>
                    <p className="text-slate-400 text-xs uppercase">{user.role}</p>
                  </div>
                  <button
                    onClick={onLogout}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    ç™»å‡º
                  </button>
                </div>
              </div>
              <nav className="max-w-6xl mx-auto px-6 py-3 flex gap-3 text-sm flex-wrap">
                {availableTabs.map((tab) => (
                  <button
                    key={tab.key}
                    disabled={tab.disabled}
                    onClick={() => setActiveTab(tab.key)}
                    className={`px-4 py-2 rounded-2xl border ${
                      activeTab === tab.key
                        ? "border-emerald-400 bg-emerald-400/10"
                        : "border-transparent hover:border-slate-700"
                    } ${tab.disabled ? "opacity-50 cursor-not-allowed" : ""}`}
                  >
                    {tab.label}
                  </button>
                ))}
              </nav>
            </header>
            <main className="max-w-6xl mx-auto px-6 py-8 space-y-8">
              {activeTab === "products" && user.permissions?.products && (
                <ProductModule db={db} setDb={setDb} />
              )}
              {activeTab === "products" && !user.permissions?.products && (
                <SectionCard title="ç„¡æ¬Šé™">
                  <p className="text-sm text-slate-400">
                    æ‚¨å°šæœªè¢«æˆæ¬Šä½¿ç”¨ç”¢å“è³‡æ–™åº«ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚
                  </p>
                </SectionCard>
              )}
              {activeTab === "users" && user.role === "admin" && (
                <UserManagement db={db} setDb={setDb} currentUser={user} />
              )}
              {activeTab === "ads" && (
                <SectionCard title="å»£å‘Šæ–‡æ¡ˆæ¨¡çµ„">
                  <p className="text-sm text-slate-400">
                    æ¨¡çµ„é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ã€‚
                  </p>
                </SectionCard>
              )}
            </main>
          </div>
        );
      };

      const App = () => {
        const [db, setDb, storageInfo] = usePersistentDb();
        const [user, setUser] = useState(null);

        const refreshUser = (target) => {
          if (!target) return;
          setUser({
            ...target,
            permissions: normalizePermissions(target.permissions),
          });
        };

        useEffect(() => {
          if (!user) return;
          const fresh = db.users.find((u) => u.id === user.id);
          if (fresh) {
            const next = {
              ...fresh,
              permissions: normalizePermissions(fresh.permissions),
            };
            if (JSON.stringify(next) !== JSON.stringify(user)) {
              setUser(next);
            }
          }
        }, [db.users]);

        const handleLogin = ({ username, password }) => {
          const found = db.users.find(
            (u) => u.username === username && u.password === password
          );
          if (found) {
            refreshUser(found);
            return true;
          }
          return false;
        };

        const handleLogout = () => setUser(null);

        const handleResetStorage = () => {
          if (
            window.confirm(
              "æ­¤å‹•ä½œæœƒæ¸…é™¤æœ¬æ©Ÿå·²å„²å­˜çš„è³‡æ–™åº«ä¸¦é‡æ–°è¼‰å…¥é è¨­å¸³è™Ÿã€‚ç¢ºå®šè¦ç¹¼çºŒï¼Ÿ"
            )
          ) {
            localStorage.removeItem(STORAGE_KEY);
            window.location.reload();
          }
        };

        return user ? (
          <Dashboard
            user={user}
            onLogout={handleLogout}
            db={db}
            setDb={setDb}
            storageInfo={storageInfo}
          />
        ) : (
          <LoginForm onLogin={handleLogin} onResetStorage={handleResetStorage} />
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </body>
</html>


