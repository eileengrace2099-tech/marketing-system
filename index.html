<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¡ŒéŠ·ç®¡ç†ç³»çµ±</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.0.1/build/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // ============================================
      // ğŸ”§ Supabase è¨­å®š
      // ============================================
      // æ–¹æ³• 1ï¼šä½¿ç”¨ Zeabur ç’°å¢ƒè®Šæ•¸ï¼ˆæ¨è–¦ï¼Œæ›´å®‰å…¨ï¼‰
      // åœ¨ Zeabur â†’ Settings â†’ Environment Variables è¨­å®šï¼š
      // - VITE_SUPABASE_URL = ä½ çš„ Supabase Project URL
      // - VITE_SUPABASE_KEY = ä½ çš„ Supabase anon public key
      //
      // æ–¹æ³• 2ï¼šç›´æ¥å¡«å…¥ï¼ˆåƒ…ç”¨æ–¼æœ¬åœ°æ¸¬è©¦ï¼‰
      // å¦‚æœç’°å¢ƒè®Šæ•¸ä¸å­˜åœ¨ï¼Œæœƒä½¿ç”¨ä¸‹é¢çš„é è¨­å€¼
      // ============================================
      const SUPABASE_URL = 
        window.VITE_SUPABASE_URL || 
        'https://rocxusxophynujcrrigu.supabase.co'; // ä½ çš„ Supabase Project URL
      
      const SUPABASE_KEY = 
        window.VITE_SUPABASE_KEY || 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJvY3h1c3hvcGh5bnVqY3JyaWd1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NTYxMDIsImV4cCI6MjA3OTAzMjEwMn0.fB5aSqcGBB7sFoEA596QUDpP8iVO3WtoFltt4oUkqK8'; // ä½ çš„ Supabase API Key
      
      // å¦‚æœé‚„æ²’è¨­å®š Supabaseï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰
      const USE_SUPABASE = SUPABASE_URL && SUPABASE_KEY;
      const supabase = USE_SUPABASE ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

      const STORAGE_KEY = "marketing-system-db";

      const DEFAULT_ADMIN = {
        id: "u-1",
        username: "admin",
        password: "admin",
        displayName: "ç³»çµ±ç®¡ç†å“¡",
        role: "admin",
        permissions: {
          products: true,
          ads: false,
        },
      };

      const DEFAULT_DB = {
        users: [DEFAULT_ADMIN],
        referenceOptions: {
          categories: ["ä¿é¤Š", "ç¾å¦", "ç”Ÿæ´»å®¶é›»"],
          usageFlows: ["æ—¥å¸¸ä¿é¤Š", "å½©å¦æ­¥é©Ÿ", "æ·±å±¤æ¸…æ½”"],
          usageMethods: ["æ—©æ™šä½¿ç”¨", "ç¡å‰ä½¿ç”¨", "é‹å‹•å‰å¾Œ"],
          audiences: ["å¥³æ€§", "ç”·æ€§", "é’å°‘å¹´", "æ•æ„Ÿè‚Œ"],
          painPoints: ["å‡ºæ²¹", "æš—æ²‰", "ç—˜ç—˜", "ä¹¾è£‚"],
          awards: ["FG ç‰¹å„ª", "å¥³äººæˆ‘æœ€å¤§æ¨è–¦", "ç™¾å¤§ç¶²å‹å£ç¢‘"],
          channelLinks: ["å®˜ç¶²", "è¦çš®", "å±ˆè‡£æ°"],
        },
        products: [],
      };

      const strip = (value) => (typeof value === "string" ? value.trim() : "");

      const normalizeFeatures = (features = []) => {
        const list = Array.isArray(features) ? features : [];
        return Array.from({ length: 5 }, (_, index) => strip(list[index] ?? ""));
      };

      const normalizeFaqs = (faqs = []) => {
        if (!Array.isArray(faqs)) return [];
        return faqs
          .map((item) => {
            if (typeof item === "string") {
              return { question: strip(item), answer: "" };
            }
            if (Array.isArray(item)) {
              return {
                question: strip(item[0]),
                answer: strip(item[1]),
              };
            }
            return {
              question: strip(item?.question ?? item?.q ?? ""),
              answer: strip(item?.answer ?? item?.a ?? ""),
            };
          })
          .filter((item) => item.question || item.answer);
      };

      const normalizeRecommendedCombos = (combos = []) => {
        if (!Array.isArray(combos)) return [];
        return combos
          .map((item) => {
            if (typeof item === "string") {
              return { name: strip(item), link: "", reason: "" };
            }
            return {
              name: strip(item?.name ?? item?.title ?? ""),
              link: strip(item?.link ?? item?.url ?? ""),
              reason: strip(item?.reason ?? item?.note ?? ""),
            };
          })
          .filter((item) => item.name || item.link || item.reason);
      };

      const sanitizeProduct = (product) => {
        const channelLinks = Object.fromEntries(
          Object.entries(product.channelLinks || {})
            .map(([channel, url]) => [channel, strip(url)])
            .filter(([, url]) => url)
        );
        const features = normalizeFeatures(product.features);
        const purchaseDecision = Array.isArray(product.purchaseDecision)
          ? product.purchaseDecision.filter(pd => pd && pd.trim())
          : product.purchaseDecision
          ? [product.purchaseDecision].filter(pd => pd && pd.trim())
          : [];
        return {
          ...product,
          productNumber: strip(product.productNumber),
          nameZh: strip(product.nameZh),
          nameEn: strip(product.nameEn),
          nickname: strip(product.nickname),
          usageMethod: strip(product.usageMethod),
          category: strip(product.category),
          usageFlow: strip(product.usageFlow),
          shortDescription: strip(product.shortDescription),
          purchaseDecision,
          faqs: normalizeFaqs(product.faqs),
          recommendedCombos: normalizeRecommendedCombos(product.recommendedCombos),
          features,
          channelLinks,
        };
      };

      // ============================================
      // ğŸ“¦ Supabase è³‡æ–™æ“ä½œå‡½æ•¸
      // ============================================
      const loadFromSupabase = async () => {
        if (!USE_SUPABASE) return null;
        
        try {
          // è¼‰å…¥ users
          const { data: usersData, error: usersError } = await supabase
            .from('users')
            .select('*');
          if (usersError) throw usersError;

          // è¼‰å…¥ products
          const { data: productsData, error: productsError } = await supabase
            .from('products')
            .select('*');
          if (productsError) throw productsError;

          // è¼‰å…¥ reference_options
          const { data: refData, error: refError } = await supabase
            .from('reference_options')
            .select('*');
          if (refError) throw refError;

          // è½‰æ› reference_options æ ¼å¼
          const referenceOptions = {};
          if (refData) {
            refData.forEach((item) => {
              referenceOptions[item.option_key] = item.options || [];
            });
          }

          // è½‰æ› users æ ¼å¼ï¼ˆSupabase ä½¿ç”¨ snake_caseï¼Œå‰ç«¯ä½¿ç”¨ camelCaseï¼‰
          const users = (usersData || []).map((user) => ({
            id: user.id,
            username: user.username,
            password: user.password,
            email: user.email,
            displayName: user.display_name,
            role: user.role,
            permissions: user.permissions || { products: false, ads: false },
          }));

          // è½‰æ› products æ ¼å¼
          const products = (productsData || []).map((product) => ({
            id: product.id,
            productNumber: product.product_number,
            category: product.category,
            usageFlow: product.usage_flow,
            usageMethod: product.usage_method,
            nameZh: product.name_zh,
            nameEn: product.name_en,
            nickname: product.nickname,
            shortDescription: product.short_description,
            purchaseDecision: Array.isArray(product.purchase_decision) 
              ? product.purchase_decision 
              : product.purchase_decision 
              ? [product.purchase_decision] 
              : [],
            channelLinks: product.channel_links || {},
            features: product.features || [],
            audiences: product.audiences || [],
            painPoints: product.pain_points || [],
            awards: product.awards || [],
            images: product.images || [],
            channelSkus: product.channel_skus || [],
            recommendedCombos: product.recommended_combos || [],
            recommendedOthers: product.recommended_others || [],
            highConversionAssets: product.high_conversion_assets || [],
            faqs: product.faqs || [],
          }));

          return {
            users: users,
            products: products,
            referenceOptions: referenceOptions,
          };
        } catch (error) {
          console.error('Supabase è¼‰å…¥å¤±æ•—ï¼Œæ”¹ç”¨ localStorage', error);
          return null;
        }
      };

      const saveToSupabase = async (data) => {
        if (!USE_SUPABASE) return false;

        try {
          // å„²å­˜ usersï¼ˆä½¿ç”¨æ‰¹æ¬¡ upsertï¼‰
          if (data.users && data.users.length > 0) {
            const usersData = data.users.map(user => ({
              id: user.id,
              username: user.username,
              password: user.password,
              email: user.email || null,
              display_name: user.displayName || null,
              role: user.role || 'member',
              permissions: user.permissions || {},
            }));
            
            const { error: usersError } = await supabase
              .from('users')
              .upsert(usersData, { onConflict: 'id' });
            
            if (usersError) {
              console.error('âŒ Users å„²å­˜å¤±æ•—:', usersError);
              throw usersError;
            }
          }

          // å„²å­˜ productsï¼ˆä½¿ç”¨æ‰¹æ¬¡ upsertï¼‰
          if (data.products && data.products.length > 0) {
            const productsData = data.products.map(product => ({
              id: product.id,
              product_number: product.productNumber || null,
              category: product.category || null,
              usage_flow: product.usageFlow || null,
              usage_method: product.usageMethod || null,
              name_zh: product.nameZh || null,
              name_en: product.nameEn || null,
              nickname: product.nickname || null,
              short_description: product.shortDescription || null,
              purchase_decision: product.purchaseDecision || null,
              channel_links: product.channelLinks || {},
              features: product.features || [],
              audiences: product.audiences || [],
              pain_points: product.painPoints || [],
              awards: product.awards || [],
              images: product.images || [],
              channel_skus: product.channelSkus || [],
              recommended_combos: product.recommendedCombos || [],
              recommended_others: product.recommendedOthers || [],
              high_conversion_assets: product.highConversionAssets || [],
              faqs: product.faqs || [],
            }));
            
            const { error: productsError } = await supabase
              .from('products')
              .upsert(productsData, { onConflict: 'id' });
            
            if (productsError) {
              console.error('âŒ Products å„²å­˜å¤±æ•—:', productsError);
              throw productsError;
            }
          }

          // å„²å­˜ reference_optionsï¼ˆä½¿ç”¨æ‰¹æ¬¡ upsertï¼‰
          if (data.referenceOptions) {
            const referenceData = Object.entries(data.referenceOptions).map(([key, options]) => ({
              option_key: key,
              options: options || [],
            }));
            
            if (referenceData.length > 0) {
              const { error: refError } = await supabase
                .from('reference_options')
                .upsert(referenceData, { onConflict: 'option_key' });
              
              if (refError) {
                console.error('âŒ Reference Options å„²å­˜å¤±æ•—:', refError);
                throw refError;
              }
            }
          }

          console.log('âœ… Supabase è³‡æ–™å„²å­˜æˆåŠŸ');
          return true;
        } catch (error) {
          console.error('âŒ Supabase å„²å­˜å¤±æ•—:', error);
          console.error('éŒ¯èª¤è©³æƒ…:', {
            message: error.message,
            details: error.details,
            hint: error.hint,
            code: error.code
          });
          return false;
        }
      };

      // ============================================
      // ğŸ’¾ æœ¬åœ°å„²å­˜ï¼ˆlocalStorageï¼‰å‡½æ•¸ï¼ˆå‚™ç”¨ï¼‰
      // ============================================
      const saveToStorage = (data) => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (error) {
          console.error('localStorage å„²å­˜å¤±æ•—', error);
        }
      };

      const readFromStorage = () => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : DEFAULT_DB;
        } catch (error) {
          console.error("è®€å– localStorage å¤±æ•—", error);
          return DEFAULT_DB;
        }
      };

      const normalizePermissions = (permissions = {}) => ({
        products: permissions.products ?? true,
        ads: permissions.ads ?? false,
      });

      const ensureDbShape = (data) => {
        const next = { ...DEFAULT_DB, ...data };
        let users = (next.users || []).map((user, index) => ({
          id: user.id || `u-${index + 1}`,
          username: user.username || "",
          password: user.password || "",
          displayName: user.displayName || user.username || "",
          role: user.role || "member",
          permissions: normalizePermissions(user.permissions),
        }));

        const adminIndex = users.findIndex(
          (user) => user.username === DEFAULT_ADMIN.username
        );

        if (adminIndex === -1) {
          users.push({
            ...DEFAULT_ADMIN,
            id: DEFAULT_ADMIN.id || crypto.randomUUID(),
          });
        } else {
          users[adminIndex] = {
            ...DEFAULT_ADMIN,
            ...users[adminIndex],
            password: DEFAULT_ADMIN.password,
            role: "admin",
            permissions: normalizePermissions({
              products: true,
              ads: false,
              ...users[adminIndex].permissions,
            }),
          };
        }

        const hasAdmin = users.some((user) => user.role === "admin");
        if (!hasAdmin) {
          users.push({
            ...DEFAULT_ADMIN,
            id: crypto.randomUUID(),
          });
        }

        next.users = users;
        next.referenceOptions = {
          ...DEFAULT_DB.referenceOptions,
          ...(next.referenceOptions || {}),
        };
        next.products = (next.products || []).map((product, index) =>
          sanitizeProduct({
            id: product.id || `p-${index + 1}`,
            ...product,
          })
        );
        return next;
      };

      const usePersistentDb = () => {
        const [db, setDb] = useState(() => ensureDbShape(readFromStorage()));
        const [isLoading, setIsLoading] = useState(USE_SUPABASE);
        const [storageMode, setStorageMode] = useState(USE_SUPABASE ? 'supabase' : 'localStorage');
        const [lastSaveTime, setLastSaveTime] = useState(null);
        const [autoSyncEnabled, setAutoSyncEnabled] = useState(false); // æ˜¯å¦å•Ÿç”¨è‡ªå‹•åŒæ­¥
        const [isSyncing, setIsSyncing] = useState(false);

        // åˆå§‹åŒ–ï¼šå¾ Supabase è¼‰å…¥è³‡æ–™
        useEffect(() => {
          if (USE_SUPABASE) {
            loadFromSupabase().then((supabaseData) => {
              if (supabaseData) {
                const merged = ensureDbShape({
                  ...readFromStorage(),
                  ...supabaseData,
                });
                setDb(merged);
                setStorageMode('supabase');
                console.log('âœ… Supabase é€£ç·šæˆåŠŸï¼Œè³‡æ–™å·²å¾é›²ç«¯è¼‰å…¥');
              } else {
                setStorageMode('localStorage');
                console.log('â„¹ï¸ ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰');
              }
              setIsLoading(false);
            });
          } else {
            setIsLoading(false);
            console.log('â„¹ï¸ ä½¿ç”¨ localStorageï¼ˆé›¢ç·šæ¨¡å¼ï¼‰');
          }
        }, []);

        // æ‰‹å‹•åŒæ­¥å‡½æ•¸
        const manualSync = async () => {
          if (!USE_SUPABASE || storageMode !== 'supabase') {
            console.warn('âš ï¸ Supabase æœªå•Ÿç”¨æˆ–è™•æ–¼é›¢ç·šæ¨¡å¼');
            return false;
          }
          
          setIsSyncing(true);
          try {
            // ç¸½æ˜¯å…ˆå¯«å…¥ localStorage
            saveToStorage(db);
            
            const success = await saveToSupabase(db);
            if (success) {
              setLastSaveTime(Date.now());
              console.log('âœ… æ‰‹å‹•åŒæ­¥æˆåŠŸ');
              return true;
            } else {
              console.warn('âš ï¸ æ‰‹å‹•åŒæ­¥å¤±æ•—');
              return false;
            }
          } finally {
            setIsSyncing(false);
          }
        };

        // å„²å­˜è³‡æ–™ï¼šç¸½æ˜¯å¯«å…¥ localStorageï¼Œä½†åªåœ¨å•Ÿç”¨è‡ªå‹•åŒæ­¥æ™‚å¯«å…¥ Supabase
        useEffect(() => {
          if (isLoading) return;

          // ç¸½æ˜¯å¯«å…¥ localStorageï¼ˆä½œç‚ºå‚™ä»½ï¼‰
          saveToStorage(db);

          // å¦‚æœå•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼Œæ‰è‡ªå‹•å¯«å…¥ Supabase
          if (USE_SUPABASE && storageMode === 'supabase' && autoSyncEnabled) {
            saveToSupabase(db).then((success) => {
              if (success) {
                setLastSaveTime(Date.now());
                console.log('âœ… è³‡æ–™å·²è‡ªå‹•åŒæ­¥åˆ° Supabase');
              } else {
                console.warn('âš ï¸ Supabase è‡ªå‹•åŒæ­¥å¤±æ•—ï¼Œä½†è³‡æ–™å·²å„²å­˜åœ¨æœ¬åœ°');
              }
            });
          }
        }, [db, isLoading, storageMode, autoSyncEnabled]);

        // 10åˆ†é˜è‡ªå‹•å„²å­˜æ©Ÿåˆ¶ï¼ˆè¿½è¹¤è³‡æ–™è®Šæ›´æ™‚é–“ï¼‰
        useEffect(() => {
          if (!USE_SUPABASE || storageMode !== 'supabase' || isLoading) return;

          const AUTO_SAVE_INTERVAL = 10 * 60 * 1000; // 10åˆ†é˜
          const dataChangeTime = Date.now();

          // å¦‚æœæ²’æœ‰è¨˜éŒ„æœ€å¾Œå„²å­˜æ™‚é–“ï¼Œå…ˆè¨˜éŒ„ç•¶å‰æ™‚é–“
          if (!lastSaveTime) {
            setLastSaveTime(dataChangeTime);
            return;
          }

          // è¨­å®šè¨ˆæ™‚å™¨ï¼Œ10åˆ†é˜å¾Œè‡ªå‹•å„²å­˜
          const timer = setTimeout(() => {
            console.log('â° 10åˆ†é˜å·²éï¼Œè‡ªå‹•å„²å­˜åˆ°é›²ç«¯');
            saveToStorage(db); // ç¢ºä¿æœ¬åœ°æœ‰æœ€æ–°è³‡æ–™
            saveToSupabase(db).then((success) => {
              if (success) {
                setLastSaveTime(Date.now());
                console.log('âœ… è‡ªå‹•å„²å­˜æˆåŠŸ');
              } else {
                console.warn('âš ï¸ è‡ªå‹•å„²å­˜å¤±æ•—');
              }
            });
          }, AUTO_SAVE_INTERVAL);

          return () => clearTimeout(timer);
        }, [db, storageMode, isLoading]); // ç•¶ db è®Šæ›´æ™‚é‡ç½®è¨ˆæ™‚å™¨

        return [
          db,
          setDb,
          {
            isLoading,
            storageMode,
            manualSync,
            isSyncing,
            setAutoSyncEnabled,
            autoSyncEnabled,
            lastSaveTime
          }
        ];
      };

      const SectionCard = ({ title, actions, children }) => (
        <div className="bg-slate-900/70 border border-slate-800 rounded-2xl p-6 shadow-2xl shadow-black/40">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <div className="w-1 h-6 bg-emerald-400 rounded-full"></div>
              <h2 className="text-lg font-semibold tracking-wide">{title}</h2>
            </div>
            {actions}
          </div>
          <div className="space-y-3">{children}</div>
        </div>
      );

      const Badge = ({ label }) => (
        <span className="px-3 py-1 text-xs rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/20">
          {label}
        </span>
      );

      const LoginForm = ({ onLogin, onResetStorage }) => {
        const [form, setForm] = useState({ username: "", password: "" });
        const [error, setError] = useState("");

        const handleSubmit = (e) => {
          e.preventDefault();
          const success = onLogin(form);
          if (!success) {
            setError("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-slate-950">
            <div className="w-full max-w-md space-y-6 bg-slate-900/80 border border-slate-800 rounded-3xl p-10 shadow-2xl shadow-black/70">
              <div>
                <p className="text-emerald-400 uppercase tracking-[0.3em] text-xs mb-2">
                  MARKETING OPS
                </p>
                <h1 className="text-3xl font-semibold mb-2">
                  è¡ŒéŠ·éƒ¨ç®¡ç†ç³»çµ±
                </h1>
                <p className="text-slate-400 text-sm">
                  è«‹å…ˆç™»å…¥ä»¥é€²å…¥ç®¡ç†ä»‹é¢
                </p>
              </div>
              <form className="space-y-4" onSubmit={handleSubmit} autoComplete="off">
                <div>
                  <input
                    type="text"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="off"
                    value={form.username}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, username: e.target.value }))
                    }
                  />
                </div>
                <div>
                  <input
                    type="password"
                    className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                    autoComplete="new-password"
                    value={form.password}
                    onChange={(e) =>
                      setForm((prev) => ({ ...prev, password: e.target.value }))
                    }
                  />
                </div>
                {error && (
                  <div className="text-sm text-red-400 bg-red-400/10 border border-red-500/20 px-3 py-2 rounded-xl">
                    {error}
                  </div>
                )}
                <button
                  type="submit"
                  className="w-full py-3 rounded-xl bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 text-slate-950 font-semibold shadow-lg shadow-emerald-500/30"
                >
                  ç™»å…¥ç³»çµ±
                </button>
              </form>
      
              <button
                type="button"
                onClick={onResetStorage}
                className="w-full text-xs text-slate-400 hover:text-emerald-300 underline mt-2"
              >
                è‹¥ç„¡æ³•ç™»å…¥ï¼Œé»æ­¤æ¸…é™¤æœ¬æ©Ÿè³‡æ–™ä¸¦é‡è¨­
              </button>
            </div>
          </div>
        );
      };

      const OptionEditor = ({ optionKey, label, options, onSave }) => {
        const [value, setValue] = useState("");
        const handleAdd = () => {
          if (!value.trim()) return;
          onSave(optionKey, [...options, value.trim()]);
          setValue("");
        };
        const handleRemove = (item) => {
          onSave(
            optionKey,
            options.filter((opt) => opt !== item)
          );
        };
        return (
          <SectionCard title={`${label} ç®¡ç†`}>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                placeholder={`æ–°å¢${label}`}
                value={value}
                onChange={(e) => setValue(e.target.value)}
              />
              <button
                className="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/40 text-emerald-200"
                onClick={handleAdd}
              >
                æ–°å¢
              </button>
            </div>
            <div className="flex flex-wrap gap-2 mt-2">
              {options.map((opt) => (
                <button
                  key={opt}
                  onClick={() => handleRemove(opt)}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 hover:border-red-400 hover:text-red-200 transition"
                >
                  {opt} Ã—
                </button>
              ))}
              {!options.length && (
                <p className="text-slate-500 text-sm">å°šæœªè¨­å®šä»»ä½•é …ç›®</p>
              )}
            </div>
          </SectionCard>
        );
      };

      const MultiInput = ({ label, values, placeholder, onChange }) => {
        const [input, setInput] = useState("");
        const handleAdd = () => {
          if (!input.trim()) return;
          onChange([...values, input.trim()]);
          setInput("");
        };
        const handleRemove = (item) =>
          onChange(values.filter((val) => val !== item));
        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">{label}</label>
            <div className="flex gap-2">
              <input
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                value={input}
                placeholder={placeholder}
                onChange={(e) => setInput(e.target.value)}
              />
              <button
                type="button"
                onClick={handleAdd}
                className="px-4 py-2 rounded-xl border border-emerald-500/30 text-emerald-300"
              >
                åŠ å…¥
              </button>
            </div>
            <div className="flex flex-wrap gap-2">
              {values.map((val) => (
                <span
                  key={val}
                  className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 flex items-center gap-2"
                >
                  {val}
                  <button onClick={() => handleRemove(val)} className="text-red-300">
                    Ã—
                  </button>
                </span>
              ))}
            </div>
          </div>
        );
      };

      const FiveFeaturesInput = ({ values = [], onChange }) => {
        const normalized = normalizeFeatures(values);

        const handleChange = (index, value) => {
          const next = [...normalized];
          next[index] = value;
          onChange(next);
        };

        return (
          <div className="space-y-2">
            <label className="text-sm text-slate-300">ç”¢å“ä¸»è¦äº”å¤§ç‰¹è‰²</label>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {normalized.map((feature, index) => (
                <input
                  key={index}
                  className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                  placeholder={`ç‰¹è‰² ${index + 1}`}
                  value={feature}
                  onChange={(e) => handleChange(index, e.target.value)}
                />
              ))}
            </div>
            <p className="text-xs text-slate-500">
              è«‹è¼¸å…¥æœ€å¤šäº”å€‹ç”¢å“äº®é»ï¼›å¯ç•™ç©ºçš„æ¬„ä½æœƒè‡ªå‹•å¿½ç•¥ã€‚
            </p>
          </div>
        );
      };

      const PurchaseDecisionEditor = ({ items = [], onChange }) => {
        const [value, setValue] = useState("");
        
        const handleAdd = () => {
          if (!value.trim()) return;
          onChange([...(items || []), value.trim()]);
          setValue("");
        };
        
        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };
        
        const handleKeyPress = (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleAdd();
          }
        };

        return (
          <div className="space-y-3">
            <label className="text-sm text-slate-300">è³¼è²·æ±ºç­–</label>
            <div className="flex gap-2">
              <input
                type="text"
                className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                placeholder="æ–°å¢è³¼è²·æ±ºç­–è¦é»"
                value={value}
                onChange={(e) => setValue(e.target.value)}
                onKeyPress={handleKeyPress}
              />
              <button
                type="button"
                className="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/40 text-emerald-200"
                onClick={handleAdd}
              >
                æ–°å¢
              </button>
            </div>
            {items.length > 0 && (
              <div className="flex flex-wrap gap-2 mt-2">
                {items.map((item, index) => (
                  <span
                    key={index}
                    className="px-3 py-1 text-xs rounded-full bg-slate-800 border border-slate-700 flex items-center gap-2"
                  >
                    {item}
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-red-300 hover:text-red-200"
                    >
                      Ã—
                    </button>
                  </span>
                ))}
              </div>
            )}
          </div>
        );
      };

      const FAQEditor = ({ items = [], onChange }) => {
        const handleAdd = () =>
          onChange([...(items || []), { question: "", answer: "" }]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">å¸¸è¦‹å•ç­”</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                æ–°å¢å•ç­”
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder={`å•é¡Œ #${index + 1}`}
                      value={item.question}
                      onChange={(e) =>
                        handleChange(index, "question", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="ç­”æ¡ˆ"
                      value={item.answer}
                      onChange={(e) =>
                        handleChange(index, "answer", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      åˆªé™¤æ­¤å•ç­”
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">å°šæœªæ–°å¢å•ç­”</p>
              )}
            </div>
          </div>
        );
      };

      const ComboEditor = ({ items = [], onChange, label = "æ¨è–¦æ­é…ç”¢å“" }) => {
        const handleAdd = () =>
          onChange([
            ...(items || []),
            { name: "", link: "", reason: "" },
          ]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        return (
          <div className="space-y-3">
            {label && (
              <div className="flex items-center justify-between">
                <label className="text-sm text-slate-300">{label}</label>
                <button
                  type="button"
                  onClick={handleAdd}
                  className="px-3 py-1 text-xs rounded-full border border-slate-700"
                >
                  æ–°å¢æ¨è–¦
                </button>
              </div>
            )}
            {!label && (
              <div className="flex justify-end">
                <button
                  type="button"
                  onClick={handleAdd}
                  className="px-3 py-1 text-xs rounded-full border border-slate-700"
                >
                  æ–°å¢
                </button>
              </div>
            )}
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="ç”¢å“åç¨±"
                      value={item.name}
                      onChange={(e) =>
                        handleChange(index, "name", e.target.value)
                      }
                    />
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="ç”¢å“è¶…é€£çµï¼ˆå¯é¸ï¼‰"
                      value={item.link}
                      onChange={(e) =>
                        handleChange(index, "link", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="æ¨è–¦åŸå› ï¼ˆå¯æè¿°æ­é…æƒ…å¢ƒï¼‰"
                      value={item.reason}
                      onChange={(e) =>
                        handleChange(index, "reason", e.target.value)
                      }
                    />
                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      åˆªé™¤æ­¤æ¨è–¦
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">å°šæœªæ–°å¢æ¨è–¦ç”¢å“</p>
              )}
            </div>
          </div>
        );
      };

      // å½±ç‰‡ä¸Šå‚³è™•ç†å‡½æ•¸
      const handleVideoUpload = (file, index, items, handleChange) => {
        if (!file.type.startsWith('video/')) {
          alert('è«‹é¸æ“‡å½±ç‰‡æª”æ¡ˆ');
          return;
        }

        // é™åˆ¶æª”æ¡ˆå¤§å°ç‚º 50MB
        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('å½±ç‰‡æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 50MB');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          // å„²å­˜ç‚º base64
          const videoData = e.target.result;
          
          // ç²å–ç¬¬ä¸€å€‹ CUT ä½œç‚ºé è¦½ï¼ˆå¾å½±ç‰‡ä¸­æˆªå–ç¬¬ä¸€å¹€ï¼‰
          const video = document.createElement('video');
          video.preload = 'metadata';
          video.muted = true;
          video.playsInline = true;
          
          video.onloadedmetadata = () => {
            video.currentTime = 0.1; // 0.1 ç§’è™•ä½œç‚ºé è¦½
          };
          
          video.onseeked = () => {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
              
              canvas.toBlob((blob) => {
                if (blob) {
                  const previewReader = new FileReader();
                  previewReader.onload = (previewEvent) => {
                    const previewData = previewEvent.target.result;
                    handleChange(index, 'video', videoData);
                    handleChange(index, 'preview', previewData);
                    handleChange(index, 'videoName', file.name);
                  };
                  previewReader.readAsDataURL(blob);
                } else {
                  // å¦‚æœæˆªåœ–å¤±æ•—ï¼Œä½¿ç”¨é è¨­é è¦½
                  handleChange(index, 'video', videoData);
                  handleChange(index, 'preview', '');
                  handleChange(index, 'videoName', file.name);
                }
              }, 'image/jpeg', 0.8);
            } catch (error) {
              console.error('æˆªå–é è¦½å¤±æ•—:', error);
              // å¦‚æœæˆªåœ–å¤±æ•—ï¼Œä»ç„¶å„²å­˜å½±ç‰‡
              handleChange(index, 'video', videoData);
              handleChange(index, 'preview', '');
              handleChange(index, 'videoName', file.name);
            }
          };
          
          video.onerror = () => {
            // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä»ç„¶å„²å­˜å½±ç‰‡ï¼ˆå¯èƒ½æ˜¯æ ¼å¼å•é¡Œï¼‰
            handleChange(index, 'video', videoData);
            handleChange(index, 'preview', '');
            handleChange(index, 'videoName', file.name);
          };
          
          video.src = videoData;
        };
        reader.readAsDataURL(file);
      };

      // é«˜è½‰æ›ç´ æç·¨è¼¯å™¨
      const HighConversionEditor = ({ items = [], onChange }) => {
        const [playingIndex, setPlayingIndex] = useState(null);

        const handleAdd = () =>
          onChange([
            ...(items || []),
            { title: "", content: "", link: "", video: "", preview: "", videoName: "" },
          ]);

        const handleChange = (index, field, value) => {
          onChange(
            items.map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            )
          );
        };

        const handleRemove = (index) => {
          onChange(items.filter((_, idx) => idx !== index));
        };

        const handleDownload = (item, index) => {
          if (item.video) {
            const link = document.createElement('a');
            link.href = item.video;
            link.download = item.videoName || `video_${index + 1}.mp4`;
            link.click();
          } else if (item.link) {
            window.open(item.link, '_blank');
          }
        };

        return (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm text-slate-300">é«˜è½‰æ›ç´ æ</label>
              <button
                type="button"
                onClick={handleAdd}
                className="px-3 py-1 text-xs rounded-full border border-slate-700"
              >
                æ–°å¢ç´ æ
              </button>
            </div>
            <div className="space-y-3">
              {items.length ? (
                items.map((item, index) => (
                  <div
                    key={index}
                    className="space-y-2 bg-slate-950/40 border border-slate-800 rounded-2xl p-4"
                  >
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="æ¨™é¡Œ"
                      value={item.title || ""}
                      onChange={(e) =>
                        handleChange(index, "title", e.target.value)
                      }
                    />
                    <textarea
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 min-h-[80px]"
                      placeholder="å…§æ–‡"
                      value={item.content || ""}
                      onChange={(e) =>
                        handleChange(index, "content", e.target.value)
                      }
                    />
                    <input
                      className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                      placeholder="é€£çµï¼ˆå¯é¸ï¼‰"
                      value={item.link || ""}
                      onChange={(e) =>
                        handleChange(index, "link", e.target.value)
                      }
                    />
                    
                    {/* å½±ç‰‡ä¸Šå‚³ */}
                    <div className="space-y-2">
                      <label className="text-xs text-slate-400">å½±ç‰‡ç´ æï¼ˆå¯é¸ï¼Œæœ€å¤§ 50MBï¼‰</label>
                      <input
                        type="file"
                        accept="video/*"
                        className="w-full bg-transparent border border-slate-800 rounded-xl px-3 py-2 text-xs"
                        onChange={(e) => {
                          if (e.target.files.length > 0) {
                            handleVideoUpload(e.target.files[0], index, items, handleChange);
                          }
                          e.target.value = '';
                        }}
                      />
                      {item.video && (
                        <div className="relative">
                          {playingIndex === index ? (
                            <div className="space-y-2">
                              <video
                                controls
                                className="w-full rounded-xl border border-slate-800"
                                src={item.video}
                              />
                              <button
                                type="button"
                                onClick={() => setPlayingIndex(null)}
                                className="text-xs text-slate-400 hover:text-slate-200"
                              >
                                é—œé–‰æ’­æ”¾
                              </button>
                            </div>
                          ) : (
                            <div className="relative group">
                              {item.preview ? (
                                <img
                                  src={item.preview}
                                  alt="é è¦½"
                                  className="w-full rounded-xl border border-slate-800 cursor-pointer"
                                  onClick={() => setPlayingIndex(index)}
                                />
                              ) : (
                                <div
                                  className="w-full h-48 bg-slate-900 rounded-xl border border-slate-800 flex items-center justify-center cursor-pointer hover:bg-slate-800"
                                  onClick={() => setPlayingIndex(index)}
                                >
                                  <span className="text-slate-400">é»æ“Šæ’­æ”¾å½±ç‰‡</span>
                                </div>
                              )}
                              <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <div className="bg-black/50 rounded-full p-3">
                                  <span className="text-white text-2xl">â–¶</span>
                                </div>
                              </div>
                            </div>
                          )}
                          {item.videoName && (
                            <p className="text-xs text-slate-400 mt-1">{item.videoName}</p>
                          )}
                          <div className="flex gap-2 mt-2">
                            <button
                              type="button"
                              onClick={() => setPlayingIndex(playingIndex === index ? null : index)}
                              className="px-3 py-1 text-xs rounded-xl border border-emerald-400/40 text-emerald-300"
                            >
                              {playingIndex === index ? 'é—œé–‰' : 'æ’­æ”¾'}
                            </button>
                            <button
                              type="button"
                              onClick={() => handleDownload(item, index)}
                              className="px-3 py-1 text-xs rounded-xl border border-slate-700 text-slate-300"
                            >
                              ä¸‹è¼‰
                            </button>
                            <button
                              type="button"
                              onClick={() => {
                                handleChange(index, 'video', '');
                                handleChange(index, 'preview', '');
                                handleChange(index, 'videoName', '');
                              }}
                              className="px-3 py-1 text-xs rounded-xl border border-red-500/40 text-red-300"
                            >
                              ç§»é™¤å½±ç‰‡
                            </button>
                          </div>
                        </div>
                      )}
                    </div>

                    <button
                      type="button"
                      onClick={() => handleRemove(index)}
                      className="text-xs text-red-300 border border-red-500/40 rounded-xl px-3 py-1"
                    >
                      åˆªé™¤æ­¤ç´ æ
                    </button>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">å°šæœªæ–°å¢é«˜è½‰æ›ç´ æ</p>
              )}
            </div>
          </div>
        );
      };

      // åœ–ç‰‡å£“ç¸®å‡½æ•¸ï¼šå£“ç¸®åˆ°30KBä»¥ä¸‹ï¼Œé«˜åº¦100px
      const compressImage = (file, maxSizeKB = 30, targetHeight = 100) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              // è¨ˆç®—å¯¬åº¦ï¼ˆä¿æŒ1:1æ¯”ä¾‹ï¼‰
              const canvas = document.createElement('canvas');
              const ctx = canvas.getContext('2d');
              
              canvas.width = targetHeight;
              canvas.height = targetHeight;
              
              // ç¹ªè£½åœ–ç‰‡ï¼ˆå±…ä¸­è£å‰ªï¼‰
              const scale = Math.max(img.width / targetHeight, img.height / targetHeight);
              const x = (img.width - targetHeight * scale) / 2;
              const y = (img.height - targetHeight * scale) / 2;
              
              ctx.drawImage(
                img,
                x, y,
                targetHeight * scale, targetHeight * scale,
                0, 0,
                targetHeight, targetHeight
              );
              
              // å£“ç¸®åˆ°30KBä»¥ä¸‹
              let quality = 0.9;
              const maxSize = maxSizeKB * 1024;
              
              const compress = () => {
                canvas.toBlob(
                  (blob) => {
                    if (blob.size <= maxSize || quality <= 0.1) {
                      const reader = new FileReader();
                      reader.onload = () => resolve(reader.result);
                      reader.readAsDataURL(blob);
                    } else {
                      quality -= 0.1;
                      compress();
                    }
                  },
                  'image/jpeg',
                  quality
                );
              };
              
              compress();
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      };

      const FileUploader = ({ images, onChange }) => {
        const [uploading, setUploading] = useState(false);
        
        const handleFiles = async (files) => {
          setUploading(true);
          try {
            const compressedImages = await Promise.all(
              Array.from(files).map(file => compressImage(file, 30, 100))
            );
            onChange([...images, ...compressedImages]);
          } catch (error) {
            console.error('åœ–ç‰‡å£“ç¸®å¤±æ•—:', error);
            alert('åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦');
          } finally {
            setUploading(false);
          }
        };
        
        const handleRemove = (img) => {
          onChange(images.filter((item) => item !== img));
        };
        
        return (
          <div className="space-y-3">
            <label className="text-sm text-slate-300">ç”¢å“åœ–ç‰‡ (1:1, é«˜åº¦100px, å£“ç¸®è‡³30KBä»¥ä¸‹)</label>
            <input
              type="file"
              accept="image/*"
              multiple
              disabled={uploading}
              onChange={(e) => {
                if (e.target.files.length > 0) {
                  handleFiles(e.target.files);
                }
                e.target.value = ''; // é‡ç½®inputï¼Œå…è¨±é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
              }}
              className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 disabled:opacity-50"
            />
            {uploading && (
              <p className="text-xs text-emerald-400">æ­£åœ¨è™•ç†åœ–ç‰‡...</p>
            )}
            <div className="grid grid-cols-6 gap-2">
              {images.map((img, idx) => (
                <div key={idx} className="relative group">
                  <img
                    src={img}
                    alt="product"
                    className="w-full h-[100px] object-cover rounded-xl border border-slate-800"
                  />
                  <button
                    onClick={() => handleRemove(img)}
                    className="absolute top-1 right-1 bg-red-500/80 text-white text-xs px-2 py-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    åˆªé™¤
                  </button>
                </div>
              ))}
              {!images.length && (
                <div className="col-span-6 text-sm text-slate-500 text-center py-4">
                  å°šæœªä¸Šå‚³åœ–ç‰‡
                </div>
              )}
            </div>
          </div>
        );
      };

      const ExportPanel = ({ selectedProducts, db, setDb, currentUser }) => {
        const [fields, setFields] = useState([
          "productNumber",
          "nameZh",
          "nameEn",
          "category",
          "features",
          "channelSkus",
          "shortDescription",
        ]);
        const [previewOpen, setPreviewOpen] = useState(false);

        const fieldConfig = [
          { key: "productNumber", label: "ç”¢å“ç·¨è™Ÿ" },
          { key: "category", label: "å¤§åˆ†é¡" },
          { key: "usageFlow", label: "ä½¿ç”¨ç¨‹åº" },
          { key: "nameZh", label: "ä¸­æ–‡å“å" },
          { key: "nameEn", label: "è‹±æ–‡å“å" },
          { key: "features", label: "äº”å¤§ç‰¹è‰²" },
          { key: "nickname", label: "ç”¢å“ç¶½è™Ÿ" },
          { key: "usageMethod", label: "ç”¢å“ä½¿ç”¨æ–¹å¼" },
          { key: "audiences", label: "ç”¢å“å—çœ¾" },
          { key: "painPoints", label: "ç”¢å“ç—›é»" },
          { key: "awards", label: "å¾—çæ¦®è­½" },
          { key: "channelSkus", label: "é€šè·¯è²¨è™Ÿ" },
          { key: "channelLinks", label: "é€šè·¯çŸ­é€£çµ" },
          { key: "purchaseDecision", label: "è³¼è²·æ±ºç­–" },
          { key: "faqs", label: "å¸¸è¦‹å•ç­”" },
          { key: "shortDescription", label: "ç”¢å“ä»‹ç´¹çŸ­æ–‡" },
          { key: "recommendedCombos", label: "æ¨è–¦æ­é…ç”¢å“" },
          { key: "recommendedOthers", label: "æ¨è–¦å…¶ä»–ç”¢å“" },
          { key: "highConversionAssets", label: "é«˜è½‰æ›ç´ æ" },
        ];

        const toggleField = (key) => {
          setFields((prev) =>
            prev.includes(key) ? prev.filter((item) => item !== key) : [...prev, key]
          );
        };

        const formatFieldValue = (field, value) => {
          if (value === null || value === undefined) return "";
          if (Array.isArray(value)) {
            if (!value.length) return "";
            if (field === "faqs") {
              return value
                .map(
                  (item, idx) =>
                    `Q${idx + 1}: ${item?.question || ""}\nA${idx + 1}: ${
                      item?.answer || ""
                    }`
                )
                .join("\n");
            }
            if (field === "recommendedCombos") {
              return value
                .map((item) => {
                  const parts = [item?.name || ""];
                  if (item?.link) parts.push(item.link);
                  if (item?.reason) parts.push(item.reason);
                  return parts.filter(Boolean).join(" | ");
                })
                .join("\n");
            }
            return value
              .map((v) =>
                typeof v === "object" ? Object.values(v).join(" / ") : v
              )
              .join("\n");
          }
          if (typeof value === "object") {
            return Object.entries(value)
              .map(([k, v]) => `${k}: ${v}`)
              .join("\n");
          }
          if (typeof value === "string") return strip(value);
          return String(value ?? "");
        };

        // ç²å–æ¬„ä½çš„ä¸­æ–‡æ¨™ç±¤
        const getFieldLabel = (key) => {
          const config = fieldConfig.find((f) => f.key === key);
          return config ? config.label : key;
        };

        // ç²å–æ¬„ä½çš„å®Œæ•´åç¨±ï¼ˆè‹±æ–‡ + ä¸­æ–‡ï¼‰
        const getFieldFullName = (key) => {
          const label = getFieldLabel(key);
          return `${key} (${label})`;
        };

        const buildRows = () =>
          selectedProducts.map((product) => {
            const row = {};
            fields.forEach((field) => {
              // ä½¿ç”¨å®Œæ•´åç¨±ï¼ˆè‹±æ–‡ + ä¸­æ–‡ï¼‰ä½œç‚º key
              row[getFieldFullName(field)] = formatFieldValue(field, product[field]);
            });
            return row;
          });

        const handleExport = async (type) => {
          if (!selectedProducts.length) {
            alert("è«‹å…ˆé¸æ“‡è‡³å°‘ 1 å€‹ç”¢å“");
            return;
          }
          const rows = buildRows();
          if (type === "excel") {
            const worksheet = XLSX.utils.json_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Products");
            XLSX.writeFile(workbook, "products.xlsx");
          } else if (type === "pdf") {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ unit: "pt" });
            rows.forEach((row, index) => {
              const startY = 40 + index * 220;
              if (startY > 720) {
                doc.addPage();
              }
              let line = 0;
              Object.entries(row).forEach(([key, value]) => {
                // key å·²ç¶“æ˜¯å®Œæ•´åç¨±ï¼ˆè‹±æ–‡ + ä¸­æ–‡ï¼‰
                const text = `${key}: ${value}`;
                const lines = doc.splitTextToSize(text, 500);
                doc.text(lines, 40, 60 + line * 16 + index * 200);
                line += lines.length;
              });
              doc.line(30, 220 + index * 200, 560, 220 + index * 200);
            });
            doc.save("products.pdf");
          } else if (type === "word") {
            const doc = new docx.Document({
              sections: [
                {
                  properties: {},
                  children: rows.map(
                    (row) =>
                      new docx.Paragraph({
                        children: Object.entries(row).map(
                          ([key, value]) =>
                            new docx.TextRun({
                              text: `${key}: ${value}`,
                              break: 1,
                            })
                        ),
                      })
                  ),
                },
              ],
            });
            const blob = await docx.Packer.toBlob(doc);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "products.docx";
            document.body.appendChild(link);
            link.click();
            link.remove();
          }
        };

        return (
          <SectionCard
            title="åŒ¯å‡ºä¸­å¿ƒ"
            actions={
              <button
                onClick={() => setPreviewOpen(!previewOpen)}
                className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
              >
                {previewOpen ? "é—œé–‰é è¦½" : "åŒ¯å‡ºé è¦½"}
              </button>
            }
          >
            <div className="space-y-3 text-sm">
              <p className="text-slate-400">
                å·²é¸ {selectedProducts.length} é …ç”¢å“ï¼Œè«‹é¸æ“‡è¦åŒ¯å‡ºçš„æ¬„ä½èˆ‡æ ¼å¼ã€‚
              </p>
              <div className="grid grid-cols-2 gap-2">
                {fieldConfig.map(({ key, label }) => (
                  <label
                    key={key}
                    className="flex items-center gap-2 text-xs border border-slate-800 rounded-xl px-2 py-1"
                  >
                    <input
                      type="checkbox"
                      checked={fields.includes(key)}
                      onChange={() => toggleField(key)}
                    />
                    {label}
                  </label>
                ))}
              </div>
              <div className="flex gap-3 flex-wrap">
                <button
                  onClick={() => handleExport("excel")}
                  className="flex-1 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500/50"
                >
                  åŒ¯å‡º Excel
                </button>
                <button
                  onClick={() => handleExport("word")}
                  className="flex-1 py-2 rounded-xl bg-sky-500/20 border border-sky-500/50"
                >
                  åŒ¯å‡º Word
                </button>
                <button
                  onClick={() => handleExport("pdf")}
                  className="flex-1 py-2 rounded-xl bg-purple-500/20 border border-purple-500/50"
                >
                  åŒ¯å‡º PDF
                </button>
              </div>
              {previewOpen && (
                <div className="border border-slate-800 rounded-xl p-3 bg-slate-950/60 space-y-2">
                  <div className="flex items-center justify-between mb-2">
                    <p className="text-xs text-slate-400">é è¦½å…§å®¹</p>
                    <button
                      onClick={() => {
                        // ç”Ÿæˆæ‰€æœ‰ç”¢å“çš„æ–‡å­—å…§å®¹
                        const content = selectedProducts.map((product) => {
                          const productText = [
                            `ç”¢å“åç¨±ï¼š${product.nameZh || "-"}`,
                            `ç”¢å“ç·¨è™Ÿï¼š${product.productNumber || "-"}`,
                            ...fields.map((field) => {
                              const label = fieldConfig.find((f) => f.key === field)?.label || field;
                              const value = formatFieldValue(field, product[field]) || "-";
                              return `${field} (${label})ï¼š${value}`;
                            })
                          ].join('\n');
                          return productText;
                        }).join('\n\n' + '='.repeat(50) + '\n\n');
                        
                        navigator.clipboard.writeText(content).then(() => {
                          alert('âœ… å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                        }).catch(() => {
                          // å‚™ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ textarea
                          const textarea = document.createElement('textarea');
                          textarea.value = content;
                          textarea.style.position = 'fixed';
                          textarea.style.opacity = '0';
                          document.body.appendChild(textarea);
                          textarea.select();
                          document.execCommand('copy');
                          document.body.removeChild(textarea);
                          alert('âœ… å…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                        });
                      }}
                      className="px-3 py-1 text-xs rounded-xl border border-emerald-400/40 bg-emerald-400/10 text-emerald-300 hover:bg-emerald-400/20 transition"
                    >
                      ğŸ“‹ ä¸€éµè¤‡è£½å…¨éƒ¨å…§å®¹
                    </button>
                  </div>
                  <div className="max-h-64 overflow-auto space-y-2">
                    {selectedProducts.map((product) => (
                      <div key={product.id} className="border border-slate-800 rounded-xl p-3">
                        <p className="font-semibold">{product.nameZh}</p>
                        <p className="text-xs text-slate-400">{product.productNumber}</p>
                        <div className="text-xs text-slate-300 mt-2 space-y-1">
                          {fields.map((field) => {
                            const label = fieldConfig.find((f) => f.key === field)?.label || field;
                            return (
                              <p key={field} className="whitespace-pre-line">
                                <span className="text-slate-500">{field} ({label})ï¼š</span>
                                {formatFieldValue(field, product[field]) || "-"}
                              </p>
                            );
                          })}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </SectionCard>
        );
      };

      // é«˜è½‰æ›ç´ æé¡¯ç¤ºçµ„ä»¶
      const HighConversionAssetDisplay = ({ item, index }) => {
        const [isPlaying, setIsPlaying] = useState(false);

        const handleDownload = () => {
          if (item.video) {
            const link = document.createElement('a');
            link.href = item.video;
            link.download = item.videoName || `video_${index + 1}.mp4`;
            link.click();
          } else if (item.link) {
            window.open(item.link, '_blank');
          }
        };

        return (
          <div className="bg-slate-800/50 p-3 rounded-lg space-y-2">
            <p className="text-slate-200 font-semibold">{item.title || "-"}</p>
            {item.content && (
              <p className="text-slate-300 text-xs">{item.content}</p>
            )}
            {item.video ? (
              <div className="space-y-2">
                {isPlaying ? (
                  <div className="space-y-2">
                    <video
                      controls
                      className="w-full rounded-xl border border-slate-700"
                      src={item.video}
                    />
                    <button
                      type="button"
                      onClick={() => setIsPlaying(false)}
                      className="text-xs text-slate-400 hover:text-slate-200"
                    >
                      é—œé–‰æ’­æ”¾
                    </button>
                  </div>
                ) : (
                  <div className="relative group cursor-pointer" onClick={() => setIsPlaying(true)}>
                    {item.preview ? (
                      <img
                        src={item.preview}
                        alt="é è¦½"
                        className="w-full rounded-xl border border-slate-700"
                      />
                    ) : (
                      <div className="w-full h-48 bg-slate-900 rounded-xl border border-slate-700 flex items-center justify-center">
                        <span className="text-slate-400">é»æ“Šæ’­æ”¾å½±ç‰‡</span>
                      </div>
                    )}
                    <div className="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                      <div className="bg-black/50 rounded-full p-3">
                        <span className="text-white text-2xl">â–¶</span>
                      </div>
                    </div>
                  </div>
                )}
                {item.videoName && (
                  <p className="text-xs text-slate-400">{item.videoName}</p>
                )}
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={() => setIsPlaying(!isPlaying)}
                    className="px-3 py-1 text-xs rounded-xl border border-emerald-400/40 text-emerald-300"
                  >
                    {isPlaying ? 'é—œé–‰' : 'æ’­æ”¾'}
                  </button>
                  <button
                    type="button"
                    onClick={handleDownload}
                    className="px-3 py-1 text-xs rounded-xl border border-slate-700 text-slate-300"
                  >
                    ä¸‹è¼‰
                  </button>
                </div>
              </div>
            ) : item.link && (
              <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                {item.link}
              </a>
            )}
          </div>
        );
      };

      // ç”¢å“è©³æƒ…é¡¯ç¤ºé ç±¤çµ„ä»¶
      const ProductDetailsTabs = ({ product }) => {
        const [activeTab, setActiveTab] = useState('content');

        const tabs = [
          { key: 'content', label: 'ç”¢å“å…§å®¹' },
          { key: 'audience', label: 'å—çœ¾èˆ‡ç—›é»' },
          { key: 'channel', label: 'é€šè·¯ç®¡ç†' },
          { key: 'decision', label: 'è³¼è²·æ±ºç­–èˆ‡å•ç­”' },
          { key: 'recommend', label: 'æ¨è–¦èˆ‡ç´ æ' },
        ];

        return (
          <div className="space-y-4">
            {/* é ç±¤å°èˆª */}
            <div className="flex gap-2 border-b border-slate-800 overflow-x-auto">
              {tabs.map((tab) => (
                <button
                  key={tab.key}
                  type="button"
                  onClick={() => setActiveTab(tab.key)}
                  className={`px-4 py-2 text-sm font-medium border-b-2 transition ${
                    activeTab === tab.key
                      ? 'border-emerald-400 text-emerald-300'
                      : 'border-transparent text-slate-400 hover:text-slate-200'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* é ç±¤å…§å®¹ */}
            <div className="min-h-[300px]">
              {activeTab === 'content' && (
                <div className="space-y-4 text-sm">
                  <div>
                    <p className="text-slate-400 mb-2">äº”å¤§ç‰¹è‰²</p>
                    <div className="flex flex-wrap gap-2">
                      {product.features?.filter(f => f).map((f, idx) => (
                        <Badge key={idx} label={f} />
                      ))}
                      {(!product.features || product.features.filter(f => f).length === 0) && (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">ç”¢å“ä»‹ç´¹çŸ­æ–‡</p>
                    <p className="whitespace-pre-wrap">{product.shortDescription || "-"}</p>
                  </div>
                </div>
              )}

              {activeTab === 'audience' && (
                <div className="space-y-4 text-sm">
                  <div>
                    <p className="text-slate-400 mb-2">ç”¢å“å—çœ¾</p>
                    <div className="flex flex-wrap gap-2">
                      {product.audiences?.map((a, idx) => (
                        <Badge key={idx} label={a} />
                      ))}
                      {(!product.audiences || product.audiences.length === 0) && (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">ç”¢å“ç—›é»</p>
                    <div className="flex flex-wrap gap-2">
                      {product.painPoints?.map((p, idx) => (
                        <Badge key={idx} label={p} />
                      ))}
                      {(!product.painPoints || product.painPoints.length === 0) && (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">å¾—çæ¦®è­½</p>
                    <div className="flex flex-wrap gap-2">
                      {product.awards?.map((a, idx) => (
                        <Badge key={idx} label={a} />
                      ))}
                      {(!product.awards || product.awards.length === 0) && (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'channel' && (
                <div className="space-y-4 text-sm">
                  <div>
                    <p className="text-slate-400 mb-2">é€šè·¯è²¨è™Ÿ</p>
                    <div className="space-y-2">
                      {product.channelSkus?.length > 0 ? (
                        product.channelSkus.map((item, idx) => (
                          <div key={idx} className="text-xs bg-slate-800/50 p-2 rounded">
                            <span className="text-slate-300">{item.channel}</span>ï¼š
                            <span className="text-slate-200 ml-1">{item.sku}</span>
                          </div>
                        ))
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">é€šè·¯çŸ­é€£çµ</p>
                    <div className="space-y-2">
                      {product.channelLinks && Object.keys(product.channelLinks).length > 0 ? (
                        Object.entries(product.channelLinks).map(([channel, url]) => {
                          const finalUrl = url && url.trim() 
                            ? (url.startsWith('http://') || url.startsWith('https://') ? url : `https://${url}`)
                            : null;
                          return (
                            <div key={channel} className="flex items-center justify-between text-xs bg-slate-800/50 p-2 rounded">
                              <div className="flex-1">
                                <span className="text-slate-300">{channel}</span>ï¼š
                                {finalUrl ? (
                                  <a href={finalUrl} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline ml-1">
                                    {url}
                                  </a>
                                ) : (
                                  <span className="text-slate-500 ml-1">{url || "-"}</span>
                                )}
                              </div>
                              {finalUrl && (
                                <button
                                  onClick={() => window.open(finalUrl, '_blank', 'noopener,noreferrer')}
                                  className="ml-2 px-2 py-1 rounded border border-emerald-400/40 bg-emerald-400/10 text-emerald-300 text-xs hover:bg-emerald-400/20 transition whitespace-nowrap"
                                  title="åœ¨æ–°è¦–çª—é–‹å•Ÿé€£çµ"
                                >
                                  å‰å¾€
                                </button>
                              )}
                            </div>
                          );
                        })
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  {product.images?.length > 0 && (
                    <div>
                      <p className="text-slate-400 mb-2">ç”¢å“åœ–ç‰‡</p>
                      <div className="grid grid-cols-6 gap-2">
                        {product.images.map((img, idx) => (
                          <img
                            key={idx}
                            src={img}
                            alt="product"
                            className="w-full h-[100px] object-cover rounded-xl border border-slate-800"
                          />
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'decision' && (
                <div className="space-y-4 text-sm">
                  <div>
                    <p className="text-slate-400 mb-2">è³¼è²·æ±ºç­–</p>
                    <div className="space-y-2">
                      {Array.isArray(product.purchaseDecision) && product.purchaseDecision.length > 0 ? (
                        product.purchaseDecision.map((item, idx) => (
                          <div key={idx} className="text-xs bg-slate-800/50 p-2 rounded">
                            {item}
                          </div>
                        ))
                      ) : product.purchaseDecision ? (
                        <div className="text-xs bg-slate-800/50 p-2 rounded">
                          {product.purchaseDecision}
                        </div>
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">å¸¸è¦‹å•ç­”</p>
                    <div className="space-y-2">
                      {product.faqs?.length > 0 ? (
                        product.faqs.map((faq, idx) => (
                          <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                            <p className="text-emerald-400 font-semibold mb-1">Q{idx + 1}: {faq.question || "-"}</p>
                            <p className="text-slate-300 text-xs">A: {faq.answer || "-"}</p>
                          </div>
                        ))
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {activeTab === 'recommend' && (
                <div className="space-y-4 text-sm">
                  <div>
                    <p className="text-slate-400 mb-2">æ¨è–¦æ­é…ç”¢å“</p>
                    <div className="space-y-2">
                      {product.recommendedCombos?.length > 0 ? (
                        product.recommendedCombos.map((item, idx) => (
                          <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                            <p className="text-slate-200 font-semibold">{item.name || "-"}</p>
                            {item.link && (
                              <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                                {item.link}
                              </a>
                            )}
                            {item.reason && (
                              <p className="text-slate-400 text-xs mt-1">åŸå› ï¼š{item.reason}</p>
                            )}
                          </div>
                        ))
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">æ¨è–¦å…¶ä»–ç”¢å“</p>
                    <div className="space-y-2">
                      {product.recommendedOthers?.length > 0 ? (
                        product.recommendedOthers.map((item, idx) => (
                          <div key={idx} className="bg-slate-800/50 p-3 rounded-lg">
                            <p className="text-slate-200 font-semibold">{item.name || "-"}</p>
                            {item.link && (
                              <a href={item.link} target="_blank" rel="noopener noreferrer" className="text-emerald-400 hover:underline text-xs">
                                {item.link}
                              </a>
                            )}
                            {item.reason && (
                              <p className="text-slate-400 text-xs mt-1">åŸå› ï¼š{item.reason}</p>
                            )}
                          </div>
                        ))
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                  <div>
                    <p className="text-slate-400 mb-2">é«˜è½‰æ›ç´ æ</p>
                    <div className="space-y-2">
                      {product.highConversionAssets?.length > 0 ? (
                        product.highConversionAssets.map((item, idx) => (
                          <HighConversionAssetDisplay key={idx} item={item} index={idx} />
                        ))
                      ) : (
                        <span className="text-slate-500">-</span>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      // ç”¢å“è¡¨å–®é ç±¤çµ„ä»¶
      const ProductTabs = ({
        form,
        updateField,
        referenceOptions,
        handleChannelSkuAdd,
        handleListChange,
        handleListRemove,
        handleChannelLinkChange,
      }) => {
        const [activeTab, setActiveTab] = useState('content');

        const tabs = [
          { key: 'content', label: 'ç”¢å“å…§å®¹' },
          { key: 'audience', label: 'å—çœ¾èˆ‡ç—›é»' },
          { key: 'channel', label: 'é€šè·¯ç®¡ç†' },
          { key: 'decision', label: 'è³¼è²·æ±ºç­–èˆ‡å•ç­”' },
          { key: 'recommend', label: 'æ¨è–¦èˆ‡ç´ æ' },
        ];

        return (
          <div className="space-y-4">
            {/* é ç±¤å°èˆª */}
            <div className="flex gap-2 border-b border-slate-800 overflow-x-auto">
              {tabs.map((tab) => (
                <button
                  key={tab.key}
                  type="button"
                  onClick={() => setActiveTab(tab.key)}
                  className={`px-4 py-2 text-sm font-medium border-b-2 transition ${
                    activeTab === tab.key
                      ? 'border-emerald-400 text-emerald-300'
                      : 'border-transparent text-slate-400 hover:text-slate-200'
                  }`}
                >
                  {tab.label}
                </button>
              ))}
            </div>

            {/* é ç±¤å…§å®¹ */}
            <div className="min-h-[400px]">
              {activeTab === 'content' && (
                <div className="space-y-4">
                  <FiveFeaturesInput
                    values={form.features}
                    onChange={(values) => updateField("features", values)}
                  />
                  <div className="space-y-2">
                    <label className="text-sm">ç”¢å“ä»‹ç´¹çŸ­æ–‡</label>
                    <textarea
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2 min-h-[120px]"
                      value={form.shortDescription}
                      onChange={(e) => updateField("shortDescription", e.target.value)}
                    ></textarea>
                  </div>
                </div>
              )}

              {activeTab === 'audience' && (
                <div className="space-y-4">
                  <MultiInput
                    label="ç”¢å“å—çœ¾"
                    values={form.audiences}
                    placeholder="æ–°å¢å—çœ¾"
                    onChange={(values) => updateField("audiences", values)}
                  />
                  <MultiInput
                    label="ç”¢å“ç—›é»"
                    values={form.painPoints}
                    placeholder="æ–°å¢ç—›é»"
                    onChange={(values) => updateField("painPoints", values)}
                  />
                  <MultiInput
                    label="å¾—çæ¦®è­½"
                    values={form.awards}
                    placeholder="æ–°å¢å¾—çç´€éŒ„"
                    onChange={(values) => updateField("awards", values)}
                  />
                </div>
              )}

              {activeTab === 'channel' && (
                <div className="space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="text-sm text-slate-300">é€šè·¯è²¨è™Ÿ</h3>
                    <button
                      type="button"
                      onClick={handleChannelSkuAdd}
                      className="px-3 py-1 text-xs rounded-full border border-slate-700"
                    >
                      æ–°å¢é€šè·¯
                    </button>
                  </div>
                  <div className="space-y-3">
                    {form.channelSkus.map((item, index) => (
                      <div
                        key={index}
                        className="grid md:grid-cols-3 gap-3 bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                      >
                        <input
                          className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                          placeholder="é€šè·¯åç¨±"
                          value={item.channel}
                          onChange={(e) =>
                            handleListChange("channelSkus", index, "channel", e.target.value)
                          }
                        />
                        <input
                          className="bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                          placeholder="é€šè·¯è²¨è™Ÿ"
                          value={item.sku}
                          onChange={(e) =>
                            handleListChange("channelSkus", index, "sku", e.target.value)
                          }
                        />
                        <button
                          type="button"
                          onClick={() => handleListRemove("channelSkus", index)}
                          className="rounded-xl border border-red-500/40 text-red-300 text-sm"
                        >
                          ç§»é™¤
                        </button>
                      </div>
                    ))}
                    {!form.channelSkus.length && (
                      <p className="text-sm text-slate-500">å°šç„¡é€šè·¯è¨­å®š</p>
                    )}
                  </div>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <h3 className="text-sm text-slate-300">é€šè·¯çŸ­é€£çµ</h3>
                      <p className="text-xs text-slate-500">
                        é€šè·¯é¸é …å¯åœ¨å³å´ã€Œé€šè·¯ç®¡ç†ã€ç·¨è¼¯
                      </p>
                    </div>
                    <div className="space-y-3">
                      {referenceOptions.channelLinks.length ? (
                        referenceOptions.channelLinks.map((channel) => {
                          const url = form.channelLinks?.[channel] || "";
                          return (
                            <div
                              key={channel}
                              className="grid md:grid-cols-3 gap-3 items-center bg-slate-950/40 p-3 rounded-2xl border border-slate-800"
                            >
                              <div className="text-sm font-medium text-slate-200">
                                {channel}
                              </div>
                              <div className="md:col-span-2 flex gap-2">
                                <input
                                  className="flex-1 bg-transparent border border-slate-800 rounded-xl px-3 py-2"
                                  placeholder="è¼¸å…¥çŸ­ç¶²å€æˆ–å®Œæ•´ç¶²å€"
                                  value={url}
                                  onChange={(e) =>
                                    handleChannelLinkChange(channel, e.target.value)
                                  }
                                />
                                {url && url.trim() && (
                                  <button
                                    type="button"
                                    onClick={() => {
                                      const finalUrl = url.startsWith('http://') || url.startsWith('https://') 
                                        ? url 
                                        : `https://${url}`;
                                      window.open(finalUrl, '_blank', 'noopener,noreferrer');
                                    }}
                                    className="px-3 py-2 rounded-xl border border-emerald-400/40 bg-emerald-400/10 text-emerald-300 text-xs hover:bg-emerald-400/20 transition whitespace-nowrap"
                                    title="åœ¨æ–°è¦–çª—é–‹å•Ÿé€£çµ"
                                  >
                                    å‰å¾€
                                  </button>
                                )}
                              </div>
                            </div>
                          );
                        })
                      ) : (
                        <div className="text-sm text-slate-500 text-center py-4">
                          å°šæœªè¨­å®šé€šè·¯ï¼Œè«‹è‡³å³å´ã€Œé€šè·¯ç®¡ç†ã€æ–°å¢ã€‚
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="space-y-2">
                    <FileUploader
                      images={form.images}
                      onChange={(images) => updateField("images", images)}
                    />
                  </div>
                </div>
              )}

              {activeTab === 'decision' && (
                <div className="space-y-4">
                  <PurchaseDecisionEditor
                    items={
                      Array.isArray(form.purchaseDecision)
                        ? form.purchaseDecision
                        : form.purchaseDecision
                        ? [form.purchaseDecision]
                        : []
                    }
                    onChange={(values) =>
                      updateField("purchaseDecision", values)
                    }
                  />
                  <FAQEditor
                    items={form.faqs || []}
                    onChange={(values) => updateField("faqs", values)}
                  />
                </div>
              )}

              {activeTab === 'recommend' && (
                <div className="space-y-4">
                  <ComboEditor
                    items={form.recommendedCombos || []}
                    onChange={(values) => updateField("recommendedCombos", values)}
                  />
                  <ComboEditor
                    items={form.recommendedOthers || []}
                    onChange={(values) => updateField("recommendedOthers", values)}
                    label="æ¨è–¦å…¶ä»–ç”¢å“"
                  />
                  <HighConversionEditor
                    items={form.highConversionAssets || []}
                    onChange={(values) => updateField("highConversionAssets", values)}
                  />
                </div>
              )}
            </div>
          </div>
        );
      };

      const ProductForm = ({
        initialValue,
        referenceOptions,
        onSubmit,
        onCancel,
        onAddReference = () => {},
      }) => {
        const [form, setForm] = useState(() =>
          initialValue
            ? sanitizeProduct(initialValue)
            : {
                id: crypto.randomUUID(),
                productNumber: "",
                category: "",
                usageFlow: "",
                usageMethod: "",
                nameZh: "",
                nameEn: "",
                nickname: "",
                shortDescription: "",
                purchaseDecision: [],
                channelLinks: {},
                features: normalizeFeatures(),
                audiences: [],
                painPoints: [],
                awards: [],
                images: [],
                channelSkus: [],
                recommendedCombos: [],
                recommendedOthers: [],
                highConversionAssets: [],
                faqs: [],
              }
        );

        const updateField = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handleQuickAdd = (optionKey, label, targetField) => {
          const value = window.prompt(`è«‹è¼¸å…¥æ–°çš„${label}`);
          if (!value || !value.trim()) return;
          const trimmed = value.trim();
          onAddReference(optionKey, trimmed);
          updateField(targetField, trimmed);
        };

        const handleChannelSkuAdd = () => {
          setForm((prev) => ({
            ...prev,
            channelSkus: [...prev.channelSkus, { channel: "", sku: "" }],
          }));
        };

        const handleChannelLinkChange = (channel, value) => {
          setForm((prev) => {
            const nextLinks = { ...(prev.channelLinks || {}) };
            if (value) {
              nextLinks[channel] = value;
            } else {
              delete nextLinks[channel];
            }
            return { ...prev, channelLinks: nextLinks };
          });
        };

        const handleListChange = (key, index, field, value) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].map((item, idx) =>
              idx === index ? { ...item, [field]: value } : item
            ),
          }));
        };

        const handleListRemove = (key, index) => {
          setForm((prev) => ({
            ...prev,
            [key]: prev[key].filter((_, idx) => idx !== index),
          }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          onSubmit(form);
        };

        return (
          <form onSubmit={handleSubmit} className="space-y-6">
            <SectionCard
              title="åŸºæœ¬è³‡è¨Š"
              actions={
                <div className="flex gap-2">
                  <button
                    type="button"
                    onClick={onCancel}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    å„²å­˜
                  </button>
                </div>
              }
            >
              {/* ç”¢å“åœ–ç‰‡ - æ”¾åœ¨æœ€ä¸Šé¢ */}
              <div className="mb-6">
                <FileUploader
                  images={form.images}
                  onChange={(images) => updateField("images", images)}
                />
              </div>
              
              <div className="grid md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ç”¢å“ç·¨è™Ÿ</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.productNumber}
                    onChange={(e) => updateField("productNumber", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">å¤§åˆ†é¡</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.category}
                      onChange={(e) => updateField("category", e.target.value)}
                    >
                      <option value="">é¸æ“‡åˆ†é¡</option>
                      {referenceOptions.categories.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("categories", "å¤§åˆ†é¡", "category")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + æ–°å¢
                    </button>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">ä½¿ç”¨ç¨‹åºåˆ†é¡</label>
                  <div className="flex gap-2">
                    <select
                      className="flex-1 bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.usageFlow}
                      onChange={(e) => updateField("usageFlow", e.target.value)}
                    >
                      <option value="">é¸æ“‡åˆ†é¡</option>
                      {referenceOptions.usageFlows.map((opt) => (
                        <option key={opt}>{opt}</option>
                      ))}
                    </select>
                    <button
                      type="button"
                      onClick={() =>
                        handleQuickAdd("usageFlows", "ä½¿ç”¨ç¨‹åºåˆ†é¡", "usageFlow")
                      }
                      className="px-3 py-2 rounded-xl border border-emerald-400/40 text-xs"
                    >
                      + æ–°å¢
                    </button>
                  </div>
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ä¸­æ–‡å“å</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameZh}
                    onChange={(e) => updateField("nameZh", e.target.value)}
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-sm">è‹±æ–‡å“å</label>
                  <input
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    value={form.nameEn}
                    onChange={(e) => updateField("nameEn", e.target.value)}
                  />
                </div>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <label className="text-sm">ç”¢å“ä½¿ç”¨æ–¹å¼</label>
                  <input
                    list="usage-method-options"
                    className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                    placeholder="è¼¸å…¥æˆ–é¸æ“‡ä½¿ç”¨æ–¹å¼"
                    value={form.usageMethod}
                    onChange={(e) => updateField("usageMethod", e.target.value)}
                  />
                  <datalist id="usage-method-options">
                    {referenceOptions.usageMethods.map((opt) => (
                      <option key={opt} value={opt} />
                    ))}
                  </datalist>
                </div>
                <MultiInput
                  label="ç”¢å“ç¶½è™Ÿ"
                  values={form.nickname ? [form.nickname] : []}
                  placeholder="è¼¸å…¥ç¶½è™Ÿ"
                  onChange={(values) =>
                    updateField("nickname", values.length ? values[0] : "")
                  }
                />
              </div>
            </SectionCard>

            {/* é ç±¤å€åŸŸ */}
            <SectionCard title="è©³ç´°è³‡è¨Š">
              <ProductTabs
                form={form}
                updateField={updateField}
                referenceOptions={referenceOptions}
                handleChannelSkuAdd={handleChannelSkuAdd}
                handleListChange={handleListChange}
                handleListRemove={handleListRemove}
                handleChannelLinkChange={handleChannelLinkChange}
              />
            </SectionCard>
          </form>
        );
      };

      const ProductList = ({ products, onSelect, selectedIds }) => (
        <SectionCard
          title="ç”¢å“æ¸…å–®"
          actions={<Badge label={`${products.length} é …`} />}
        >
          <div className="space-y-2">
            {products.map((product) => (
              <button
                key={product.id}
                onClick={() => onSelect(product)}
                className={`w-full text-left px-4 py-3 rounded-2xl border ${
                  selectedIds.includes(product.id)
                    ? "border-emerald-400 bg-emerald-400/10"
                    : "border-slate-800 hover:border-emerald-400/40"
                }`}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <p className="font-semibold">{product.nameZh || "æœªå‘½åç”¢å“"}</p>
                    <p className="text-xs text-slate-400">{product.productNumber}</p>
                  </div>
                  <div className="flex gap-2">
                    {product.category && <Badge label={product.category} />}
                    {product.usageFlow && <Badge label={product.usageFlow} />}
                  </div>
                </div>
              </button>
            ))}
            {!products.length && (
              <div className="text-center text-sm text-slate-500 py-10">
                å°šç„¡ç”¢å“ï¼Œè«‹å…ˆå»ºç«‹ã€‚
              </div>
            )}
          </div>
        </SectionCard>
      );

      const ProductModule = ({ db, setDb, storageInfo = {}, currentUser }) => {
        const [mode, setMode] = useState("list");
        const [editingProduct, setEditingProduct] = useState(null);
        const [selected, setSelected] = useState([]);
        const [search, setSearch] = useState("");
        const [filterCategory, setFilterCategory] = useState("");

        const filteredProducts = useMemo(() => {
          return db.products.filter((p) => {
            const matchCategory = filterCategory ? p.category === filterCategory : true;
            const matchSearch = search
              ? (p.nameZh || "").includes(search) ||
                (p.nameEn || "").includes(search) ||
                (p.productNumber || "").includes(search)
              : true;
            return matchCategory && matchSearch;
          });
        }, [db.products, search, filterCategory]);

        const handleSaveProduct = async (product) => {
          const cleanProduct = sanitizeProduct(product);
          setDb((prev) => {
            const exists = prev.products.some((p) => p.id === cleanProduct.id);
            const products = exists
              ? prev.products.map((p) =>
                  p.id === cleanProduct.id ? cleanProduct : p
                )
              : [...prev.products, cleanProduct];
            return { ...prev, products };
          });
          
          // å„²å­˜å¾Œç«‹å³åŒæ­¥åˆ°é›²ç«¯ï¼ˆå¦‚æœæ²’æœ‰å•Ÿç”¨è‡ªå‹•åŒæ­¥ï¼‰
          if (storageInfo.storageMode === 'supabase' && !storageInfo.autoSyncEnabled && storageInfo.manualSync) {
            // ä½¿ç”¨ setTimeout ç¢ºä¿ db å·²æ›´æ–°
            setTimeout(async () => {
              await storageInfo.manualSync();
            }, 100);
          }
          
          setMode("list");
          setEditingProduct(null);
        };

        const handleDelete = (product) => {
          if (!window.confirm("ç¢ºå®šåˆªé™¤æ­¤ç”¢å“ï¼Ÿ")) return;
          setDb((prev) => ({
            ...prev,
            products: prev.products.filter((p) => p.id !== product.id),
          }));
          setSelected((prev) => prev.filter((id) => id !== product.id));
        };

        const handleReferenceSave = (key, items) => {
          setDb((prev) => ({
            ...prev,
            referenceOptions: {
              ...prev.referenceOptions,
              [key]: items,
            },
          }));
        };

        const handleReferenceAdd = (key, value) => {
          if (!value || !value.trim()) return;
          setDb((prev) => {
            const current = prev.referenceOptions[key] || [];
            if (current.includes(value)) return prev;
            return {
              ...prev,
              referenceOptions: {
                ...prev.referenceOptions,
                [key]: [...current, value],
              },
            };
          });
        };

        const toggleSelect = (product) => {
          setSelected((prev) =>
            prev.includes(product.id)
              ? prev.filter((id) => id !== product.id)
              : [...prev, product.id]
          );
        };

        return (
          <div className="grid lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 space-y-6">
              {mode === "list" && (
                <>
                  <SectionCard
                    title="æŸ¥æ‰¾ç”¢å“"
                    actions={
                      <button
                        onClick={() => {
                          setMode("edit");
                          setEditingProduct(null);
                        }}
                        className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                      >
                        æ–°å¢ç”¢å“
                      </button>
                    }
                  >
                    <div className="grid md:grid-cols-3 gap-3">
                      <input
                        placeholder="è¼¸å…¥å“å / ç·¨è™Ÿ"
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                      />
                      <select
                        className="bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                        value={filterCategory}
                        onChange={(e) => setFilterCategory(e.target.value)}
                      >
                        <option value="">å…¨éƒ¨åˆ†é¡</option>
                        {db.referenceOptions.categories.map((cat) => (
                          <option key={cat}>{cat}</option>
                        ))}
                      </select>
                    </div>
                  </SectionCard>
                  <ProductList
                    products={filteredProducts}
                    selectedIds={selected}
                    onSelect={(product) => {
                      setEditingProduct(product);
                      setMode("details");
                    }}
                  />
                </>
              )}
              {mode === "edit" && (
                <ProductForm
                  initialValue={editingProduct}
                  referenceOptions={db.referenceOptions}
                  onSubmit={handleSaveProduct}
                  onAddReference={handleReferenceAdd}
                  onCancel={() => {
                    setMode("list");
                    setEditingProduct(null);
                  }}
                />
              )}
              {mode === "details" && editingProduct && (
                <SectionCard
                  title={editingProduct.nameZh || "ç”¢å“è©³æƒ…"}
                  actions={
                    <div className="flex gap-2">
                      <button
                        onClick={() => toggleSelect(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        {selected.includes(editingProduct.id) ? "å–æ¶ˆå‹¾é¸" : "å‹¾é¸åŒ¯å‡º"}
                      </button>
                      <button
                        onClick={() => {
                          setMode("edit");
                        }}
                        className="px-3 py-1 rounded-xl border border-emerald-400/40 text-xs"
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        onClick={() => handleDelete(editingProduct)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        åˆªé™¤
                      </button>
                      <button
                        onClick={() => {
                          setMode("list");
                          setEditingProduct(null);
                        }}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        è¿”å›åˆ—è¡¨
                      </button>
                    </div>
                  }
                >
                  {/* åŸºæœ¬è³‡è¨Š */}
                  <div className="grid md:grid-cols-2 gap-4 text-sm mb-6">
                    <div>
                      <p className="text-slate-400">ç”¢å“ç·¨è™Ÿ</p>
                      <p>{editingProduct.productNumber || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">å¤§åˆ†é¡</p>
                      <p>{editingProduct.category || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ä½¿ç”¨ç¨‹åº</p>
                      <p>{editingProduct.usageFlow || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ä¸­æ–‡å“å</p>
                      <p>{editingProduct.nameZh || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">è‹±æ–‡å“å</p>
                      <p>{editingProduct.nameEn || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ç”¢å“ç¶½è™Ÿ</p>
                      <p>{editingProduct.nickname || "-"}</p>
                    </div>
                    <div>
                      <p className="text-slate-400">ç”¢å“ä½¿ç”¨æ–¹å¼</p>
                      <p>{editingProduct.usageMethod || "-"}</p>
                    </div>
                  </div>

                  {/* é ç±¤å€åŸŸ */}
                  <ProductDetailsTabs product={editingProduct} />
                </SectionCard>
              )}
            </div>
            <div className="space-y-6">
              <ExportPanel
                selectedProducts={db.products.filter((p) => selected.includes(p.id))}
                db={db}
                setDb={setDb}
                currentUser={currentUser}
              />
              <OptionEditor
                optionKey="categories"
                label="å¤§åˆ†é¡"
                options={db.referenceOptions.categories}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageFlows"
                label="ä½¿ç”¨ç¨‹åºåˆ†é¡"
                options={db.referenceOptions.usageFlows}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="usageMethods"
                label="ä½¿ç”¨æ–¹å¼"
                options={db.referenceOptions.usageMethods}
                onSave={handleReferenceSave}
              />
              <OptionEditor
                optionKey="channelLinks"
                label="é€šè·¯ç®¡ç†"
                options={db.referenceOptions.channelLinks}
                onSave={handleReferenceSave}
              />
            </div>
          </div>
        );
      };

      const PermissionBadges = ({ permissions }) => (
        <div className="flex flex-wrap gap-2">
          {Object.entries(permissions).map(([key, value]) =>
            value ? (
              <Badge
                key={key}
                label={
                  {
                    products: "ç”¢å“è³‡æ–™åº«",
                    ads: "å»£å‘Šæ–‡æ¡ˆ",
                  }[key] || key
                }
              />
            ) : null
          )}
        </div>
      );

      const UserManagement = ({ db, setDb, currentUser }) => {
        const emptyUser = {
          id: "",
          username: "",
          password: "",
          displayName: "",
          role: "member",
          permissions: { products: false, ads: false },
        };

        const [form, setForm] = useState(emptyUser);
        const [isEditing, setIsEditing] = useState(false);

        const openCreate = () => {
          setForm({ ...emptyUser, id: crypto.randomUUID() });
          setIsEditing(false);
        };

        const openEdit = (user) => {
          setForm({
            ...user,
            permissions: normalizePermissions(user.permissions),
          });
          setIsEditing(true);
        };

        const resetForm = () => {
          setForm(emptyUser);
          setIsEditing(false);
        };

        const handleChange = (key, value) => {
          setForm((prev) => ({ ...prev, [key]: value }));
        };

        const handlePermissionChange = (key) => {
          setForm((prev) => ({
            ...prev,
            permissions: {
              ...prev.permissions,
              [key]: !prev.permissions[key],
            },
          }));
        };

        const usernameExists = (username, excludeId) =>
          db.users.some(
            (user) =>
              user.username.toLowerCase() === username.toLowerCase() &&
              user.id !== excludeId
          );

        const handleSubmit = (e) => {
          e.preventDefault();
          if (!form.username.trim() || !form.password.trim()) {
            alert("å¸³è™Ÿèˆ‡å¯†ç¢¼ç‚ºå¿…å¡«");
            return;
          }
          if (usernameExists(form.username, form.id)) {
            alert("æ­¤å¸³è™Ÿå·²å­˜åœ¨");
            return;
          }

          const payload = {
            ...form,
            username: form.username.trim(),
            password: form.password,
            displayName: form.displayName.trim() || form.username.trim(),
            role: form.role,
            permissions: normalizePermissions(form.permissions),
          };

          setDb((prev) => {
            const exists = prev.users.some((user) => user.id === payload.id);
            const users = exists
              ? prev.users.map((user) => (user.id === payload.id ? payload : user))
              : [...prev.users, payload];
            return { ...prev, users };
          });
          
          // æ–°å¢æˆåŠŸå¾Œï¼Œè‡ªå‹•æº–å‚™æ–°å¢ä¸‹ä¸€å€‹å¸³è™Ÿï¼ˆç„¡é™æ–°å¢ï¼‰
          if (!isEditing) {
            setForm({ ...emptyUser, id: crypto.randomUUID() });
            setIsEditing(false);
            // å¯é¸ï¼šé¡¯ç¤ºæˆåŠŸè¨Šæ¯
            console.log(`âœ… å¸³è™Ÿ "${payload.username}" å·²æˆåŠŸæ–°å¢`);
          } else {
            resetForm();
          }
        };

        const handleDelete = (user) => {
          if (user.id === currentUser.id) {
            alert("ç„¡æ³•åˆªé™¤è‡ªå·±");
            return;
          }
          const admins = db.users.filter((u) => u.role === "admin");
          if (user.role === "admin" && admins.length <= 1) {
            alert("è‡³å°‘éœ€è¦ä¸€ä½ç®¡ç†å“¡");
            return;
          }
          if (!window.confirm(`ç¢ºå®šåˆªé™¤å¸³è™Ÿï¼š${user.username}ï¼Ÿ`)) return;
          setDb((prev) => ({
            ...prev,
            users: prev.users.filter((u) => u.id !== user.id),
          }));
        };

        return (
          <div className="space-y-6">
            <SectionCard
              title="å¸³è™Ÿåˆ—è¡¨"
              actions={
                <button
                  onClick={openCreate}
                  className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                >
                  æ–°å¢å¸³è™Ÿ
                </button>
              }
            >
              <div className="space-y-3 text-sm">
                {db.users.map((user) => (
                  <div
                    key={user.id}
                    className="p-4 rounded-2xl border border-slate-800 bg-slate-950/30 flex flex-col gap-2 md:flex-row md:items-center md:justify-between"
                  >
                    <div>
                      <p className="font-semibold">
                        {user.displayName}{" "}
                        <span className="text-xs uppercase text-slate-400 ml-2">
                          {user.role}
                        </span>
                      </p>
                      <p className="text-xs text-slate-400">{user.username}</p>
                      <PermissionBadges permissions={user.permissions} />
                    </div>
                    <div className="flex gap-2">
                      <button
                        onClick={() => openEdit(user)}
                        className="px-3 py-1 rounded-xl border border-slate-700 text-xs"
                      >
                        ç·¨è¼¯
                      </button>
                      <button
                        onClick={() => handleDelete(user)}
                        className="px-3 py-1 rounded-xl border border-red-400/40 text-xs text-red-300"
                      >
                        åˆªé™¤
                      </button>
                    </div>
                  </div>
                ))}
                {!db.users.length && (
                  <p className="text-center text-slate-500">å°šç„¡å¸³è™Ÿ</p>
                )}
              </div>
            </SectionCard>

            <SectionCard title={isEditing ? "ç·¨è¼¯å¸³è™Ÿ" : "æ–°å¢å¸³è™Ÿ"}>
              <form className="space-y-4" onSubmit={handleSubmit}>
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <label className="text-sm">å¸³è™Ÿ</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.username}
                      onChange={(e) => handleChange("username", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">å¯†ç¢¼</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.password}
                      onChange={(e) => handleChange("password", e.target.value)}
                      required
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">é¡¯ç¤ºåç¨±</label>
                    <input
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.displayName}
                      onChange={(e) => handleChange("displayName", e.target.value)}
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-sm">è§’è‰²</label>
                    <select
                      className="w-full bg-slate-950/60 border border-slate-800 rounded-xl px-3 py-2"
                      value={form.role}
                      onChange={(e) => handleChange("role", e.target.value)}
                    >
                      <option value="admin">admin</option>
                      <option value="editor">editor</option>
                      <option value="member">member</option>
                    </select>
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-sm">å¯ä½¿ç”¨ç®¡ç†ä»‹é¢</label>
                  <div className="flex flex-wrap gap-3">
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.products}
                        onChange={() => handlePermissionChange("products")}
                      />
                      ç”¢å“è³‡æ–™åº«
                    </label>
                    <label className="flex items-center gap-2 text-sm">
                      <input
                        type="checkbox"
                        checked={form.permissions.ads}
                        onChange={() => handlePermissionChange("ads")}
                      />
                      å»£å‘Šæ–‡æ¡ˆï¼ˆé ç•™ï¼‰
                    </label>
                  </div>
                </div>
                <div className="flex gap-3">
                  <button
                    type="submit"
                    className="px-4 py-2 rounded-xl bg-emerald-500 text-slate-950 font-semibold"
                  >
                    {isEditing ? "æ›´æ–°å¸³è™Ÿ" : "å»ºç«‹å¸³è™Ÿ"}
                  </button>
                  <button
                    type="button"
                    onClick={resetForm}
                    className="px-4 py-2 rounded-xl border border-slate-700"
                  >
                    æ¸…ç©º
                  </button>
                </div>
              </form>
            </SectionCard>
          </div>
        );
      };

      const Dashboard = ({ user, users = [], activeUserId, onLogout, onSwitchUser, onLogin, db, setDb, storageInfo = {} }) => {
        const [showLoginModal, setShowLoginModal] = useState(false);
        const [loginForm, setLoginForm] = useState({ username: "", password: "" });
        const [loginError, setLoginError] = useState("");

        // å¦‚æœ user ä¸å­˜åœ¨ï¼Œè¿”å›éŒ¯èª¤è¨Šæ¯
        if (!user) {
          return (
            <div className="min-h-screen flex items-center justify-center">
              <div className="text-center">
                <p className="text-red-400">éŒ¯èª¤ï¼šä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨</p>
                <button
                  onClick={() => onLogout()}
                  className="mt-4 px-4 py-2 rounded-xl border border-slate-700"
                >
                  è¿”å›ç™»å…¥
                </button>
              </div>
            </div>
          );
        }

        const handleAddLogin = () => {
          setShowLoginModal(true);
          setLoginForm({ username: "", password: "" });
          setLoginError("");
        };

        const handleModalLogin = (e) => {
          e.preventDefault();
          const success = onLogin(loginForm);
          if (success) {
            setShowLoginModal(false);
            setLoginForm({ username: "", password: "" });
            setLoginError("");
          } else {
            setLoginError("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
          }
        };

        const availableTabs = React.useMemo(
          () =>
            [
              user?.permissions?.products && {
                key: "products",
                label: "ç”¢å“è³‡æ–™åº«ç®¡ç†",
                disabled: false,
              },
              user?.permissions?.ads && {
                key: "ads",
                label: "å»£å‘Šæ–‡æ¡ˆæ¨¡çµ„ï¼ˆå³å°‡æ¨å‡ºï¼‰",
                disabled: true,
              },
              user?.role === "admin" && {
                key: "users",
                label: "æœƒå“¡ç®¡ç†ç³»çµ±",
                disabled: false,
              },
            ].filter(Boolean),
          [user]
        );

        const initialTab = availableTabs[0]?.key || "products";
        const [activeTab, setActiveTab] = useState(initialTab);

        useEffect(() => {
          if (!availableTabs.find((tab) => tab.key === activeTab)) {
            setActiveTab(availableTabs[0]?.key || "products");
          }
        }, [availableTabs, activeTab]);

        return (
          <div className="min-h-screen bg-gradient-to-b from-slate-950 via-slate-950 to-slate-900 text-slate-100">
            <header className="border-b border-white/5 bg-black/30 backdrop-blur sticky top-0 z-20">
              <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
                <div>
                  <p className="text-xs tracking-[0.3em] text-emerald-400">
                    MARKETING OPS
                  </p>
                  <h1 className="text-xl font-semibold">è¡ŒéŠ·éƒ¨ç®¡ç†ç³»çµ±</h1>
                </div>
                <div className="flex items-center gap-4">
                  {storageInfo.storageMode && (
                    <div className="flex items-center gap-2">
                      <div className="text-xs px-2 py-1 rounded-full border border-slate-700 bg-slate-900/50">
                        {storageInfo.storageMode === 'supabase' ? (
                          <span className="text-emerald-400">â˜ï¸ é›²ç«¯åŒæ­¥</span>
                        ) : (
                          <span className="text-slate-400">ğŸ’¾ é›¢ç·šæ¨¡å¼</span>
                        )}
                      </div>
                      {storageInfo.storageMode === 'supabase' && storageInfo.manualSync && (
                        <button
                          onClick={async () => {
                            const success = await storageInfo.manualSync();
                            if (success) {
                              alert('âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥åˆ°é›²ç«¯');
                            } else {
                              alert('âš ï¸ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
                            }
                          }}
                          disabled={storageInfo.isSyncing}
                          className="px-3 py-1 text-xs rounded-full border border-emerald-400/40 bg-emerald-400/10 text-emerald-300 hover:bg-emerald-400/20 disabled:opacity-50 disabled:cursor-not-allowed transition"
                          title="ç«‹å³åŒæ­¥åˆ°é›²ç«¯"
                        >
                          {storageInfo.isSyncing ? 'åŒæ­¥ä¸­...' : 'ğŸ”„ åŒæ­¥'}
                        </button>
                      )}
                    </div>
                  )}
                  {/* å¤šä½¿ç”¨è€…åˆ‡æ›å™¨ */}
                  {users.length > 1 && (
                    <div className="flex items-center gap-2 flex-wrap">
                      <span className="text-xs text-slate-400">å·²ç™»å…¥å¸³è™Ÿï¼š</span>
                      {users.map(u => (
                        <div
                          key={u.id}
                          className={`flex items-center gap-1 px-2 py-1 rounded-full border transition ${
                            activeUserId === u.id
                              ? 'border-emerald-400 bg-emerald-400/20 text-emerald-300'
                              : 'border-slate-700 hover:border-slate-600'
                          }`}
                        >
                          <button
                            onClick={() => onSwitchUser(u.id)}
                            className="text-xs"
                          >
                            {u.displayName || u.username}
                          </button>
                          {users.length > 1 && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                onLogout(u.id);
                              }}
                              className="text-red-300 hover:text-red-200 text-xs ml-1"
                              title={`ç™»å‡º ${u.displayName || u.username}`}
                            >
                              Ã—
                            </button>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                  <div className="text-sm">
                    <p className="font-semibold">{user.displayName}</p>
                    <p className="text-slate-400 text-xs uppercase">{user.role}</p>
                  </div>
                  <button
                    onClick={handleAddLogin}
                    className="px-3 py-1 rounded-xl border border-slate-700 text-xs hover:border-emerald-400/40 hover:text-emerald-300 transition"
                    title="æ–°å¢ç™»å…¥å¸³è™Ÿ"
                  >
                    + æ–°å¢ç™»å…¥
                  </button>
                  <button
                    onClick={() => onLogout()}
                    className="px-4 py-2 rounded-xl border border-slate-700 text-sm"
                  >
                    ç™»å‡º
                  </button>
                </div>
              </div>
              <nav className="max-w-6xl mx-auto px-6 py-3 flex gap-3 text-sm flex-wrap">
                {availableTabs.map((tab) => (
                  <button
                    key={tab.key}
                    disabled={tab.disabled}
                    onClick={() => setActiveTab(tab.key)}
                    className={`px-4 py-2 rounded-2xl border ${
                      activeTab === tab.key
                        ? "border-emerald-400 bg-emerald-400/10"
                        : "border-transparent hover:border-slate-700"
                    } ${tab.disabled ? "opacity-50 cursor-not-allowed" : ""}`}
                  >
                    {tab.label}
                  </button>
                ))}
              </nav>
            </header>
            <main className="max-w-6xl mx-auto px-6 py-8 space-y-8">
              {activeTab === "products" && user.permissions?.products && (
                <ProductModule db={db} setDb={setDb} storageInfo={storageInfo} currentUser={user} />
              )}
              {activeTab === "products" && !user.permissions?.products && (
                <SectionCard title="ç„¡æ¬Šé™">
                  <p className="text-sm text-slate-400">
                    æ‚¨å°šæœªè¢«æˆæ¬Šä½¿ç”¨ç”¢å“è³‡æ–™åº«ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚
                  </p>
                </SectionCard>
              )}
              {activeTab === "users" && user.role === "admin" && (
                <UserManagement db={db} setDb={setDb} currentUser={user} />
              )}
              {activeTab === "ads" && (
                <SectionCard title="å»£å‘Šæ–‡æ¡ˆæ¨¡çµ„">
                  <p className="text-sm text-slate-400">
                    æ¨¡çµ„é–‹ç™¼ä¸­ï¼Œæ•¬è«‹æœŸå¾…ã€‚
                  </p>
                </SectionCard>
              )}
            </main>
            
            {/* æ–°å¢ç™»å…¥æ¨¡æ…‹æ¡† */}
            {showLoginModal && (
              <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                <div className="w-full max-w-md space-y-6 bg-slate-900/95 border border-slate-800 rounded-3xl p-8 shadow-2xl">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-emerald-400 uppercase tracking-[0.3em] text-xs mb-2">
                        ADD LOGIN
                      </p>
                      <h2 className="text-2xl font-semibold">æ–°å¢ç™»å…¥å¸³è™Ÿ</h2>
                      <p className="text-slate-400 text-sm mt-1">
                        ç™»å…¥å¦ä¸€å€‹å¸³è™Ÿä»¥åŒæ™‚ä½¿ç”¨
                      </p>
                    </div>
                    <button
                      onClick={() => {
                        setShowLoginModal(false);
                        setLoginForm({ username: "", password: "" });
                        setLoginError("");
                      }}
                      className="text-slate-400 hover:text-slate-200 text-2xl"
                    >
                      Ã—
                    </button>
                  </div>
                  <form className="space-y-4" onSubmit={handleModalLogin} autoComplete="off">
                    <div>
                      <input
                        type="text"
                        placeholder="å¸³è™Ÿ"
                        className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                        autoComplete="off"
                        value={loginForm.username}
                        onChange={(e) =>
                          setLoginForm((prev) => ({ ...prev, username: e.target.value }))
                        }
                        required
                      />
                    </div>
                    <div>
                      <input
                        type="password"
                        placeholder="å¯†ç¢¼"
                        className="w-full bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-emerald-500/60"
                        autoComplete="new-password"
                        value={loginForm.password}
                        onChange={(e) =>
                          setLoginForm((prev) => ({ ...prev, password: e.target.value }))
                        }
                        required
                      />
                    </div>
                    {loginError && (
                      <p className="text-red-400 text-sm">{loginError}</p>
                    )}
                    <div className="flex gap-3">
                      <button
                        type="button"
                        onClick={() => {
                          setShowLoginModal(false);
                          setLoginForm({ username: "", password: "" });
                          setLoginError("");
                        }}
                        className="flex-1 px-4 py-3 rounded-xl border border-slate-700 text-sm hover:border-slate-600 transition"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        type="submit"
                        className="flex-1 px-4 py-3 rounded-xl bg-emerald-500 text-slate-950 font-semibold hover:bg-emerald-400 transition"
                      >
                        ç™»å…¥
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      };

      // å…¬é–‹ç”¢å“é è¦½é é¢çµ„ä»¶
      const App = () => {
        const [db, setDb, storageInfo] = usePersistentDb();
        const [users, setUsers] = useState([]); // å¤šå€‹ç™»å…¥çš„ä½¿ç”¨è€…
        const [activeUserId, setActiveUserId] = useState(null); // ç•¶å‰é¸ä¸­çš„ä½¿ç”¨è€…ID

        const activeUser = users.find(u => u.id === activeUserId) || users[0] || null;

        const refreshUser = (target) => {
          if (!target) return;
          const refreshed = {
            ...target,
            permissions: normalizePermissions(target.permissions),
          };
          setUsers(prev => {
            const exists = prev.find(u => u.id === target.id);
            if (exists) {
              return prev.map(u => u.id === target.id ? refreshed : u);
            }
            return [...prev, refreshed];
          });
          if (!activeUserId || activeUserId === target.id) {
            setActiveUserId(target.id);
          }
        };

        useEffect(() => {
          // æ›´æ–°æ‰€æœ‰å·²ç™»å…¥ä½¿ç”¨è€…çš„è³‡æ–™
          setUsers(prev => prev.map(user => {
            const fresh = db.users.find((u) => u.id === user.id);
            if (fresh) {
              return {
                ...fresh,
                permissions: normalizePermissions(fresh.permissions),
              };
            }
            return user;
          }));
        }, [db.users]);

        // è‡ªå‹•ç™»å‡ºï¼š1å°æ™‚ç„¡å‹•ä½œè‡ªå‹•ç™»å‡ºï¼ˆé‡å°ç•¶å‰ä½¿ç”¨è€…ï¼‰
        useEffect(() => {
          if (!activeUser) return;

          let inactivityTimer = null;
          const INACTIVITY_TIMEOUT = 60 * 60 * 1000; // 1å°æ™‚ï¼ˆæ¯«ç§’ï¼‰

          const resetTimer = () => {
            if (inactivityTimer) {
              clearTimeout(inactivityTimer);
            }
            inactivityTimer = setTimeout(() => {
              console.log(`â° ä½¿ç”¨è€… ${activeUser.username} 1å°æ™‚ç„¡å‹•ä½œï¼Œè‡ªå‹•ç™»å‡º`);
              handleLogout(activeUser.id);
              if (users.length === 1) {
                alert('æ‚¨å·²è¶…é1å°æ™‚æœªæ“ä½œï¼Œç³»çµ±å·²è‡ªå‹•ç™»å‡ºä»¥ä¿è­·æ‚¨çš„å¸³è™Ÿå®‰å…¨ã€‚');
              }
            }, INACTIVITY_TIMEOUT);
          };

          const activityEvents = [
            'mousedown',
            'mousemove',
            'keypress',
            'scroll',
            'touchstart',
            'click'
          ];

          resetTimer();

          activityEvents.forEach(event => {
            document.addEventListener(event, resetTimer, true);
          });

          return () => {
            if (inactivityTimer) {
              clearTimeout(inactivityTimer);
            }
            activityEvents.forEach(event => {
              document.removeEventListener(event, resetTimer, true);
            });
          };
        }, [activeUser, users.length]);

        const handleLogin = ({ username, password }) => {
          const found = db.users.find(
            (u) => u.username === username && u.password === password
          );
          if (found) {
            // æª¢æŸ¥æ˜¯å¦å·²ç¶“ç™»å…¥
            const alreadyLoggedIn = users.find(u => u.id === found.id);
            if (alreadyLoggedIn) {
              // å¦‚æœå·²ç™»å…¥ï¼Œåˆ‡æ›åˆ°è©²ä½¿ç”¨è€…
              setActiveUserId(found.id);
              return true;
            }
            // æ–°å¢åˆ°ç™»å…¥åˆ—è¡¨
            refreshUser(found);
            return true;
          }
          return false;
        };

        const handleLogout = (userId = null) => {
          if (userId) {
            // ç™»å‡ºç‰¹å®šä½¿ç”¨è€…
            console.log(`ğŸ‘‹ ä½¿ç”¨è€… ${users.find(u => u.id === userId)?.username} ç™»å‡º`);
            setUsers(prev => {
              const remaining = prev.filter(u => u.id !== userId);
              if (remaining.length > 0 && activeUserId === userId) {
                setActiveUserId(remaining[0].id);
              } else if (remaining.length === 0) {
                setActiveUserId(null);
              }
              return remaining;
            });
          } else {
            // ç™»å‡ºç•¶å‰ä½¿ç”¨è€…
            if (activeUser) {
              console.log(`ğŸ‘‹ ä½¿ç”¨è€… ${activeUser.username} ç™»å‡º`);
              handleLogout(activeUser.id);
            }
          }
        };

        const handleSwitchUser = (userId) => {
          setActiveUserId(userId);
        };

        const handleResetStorage = () => {
          if (
            window.confirm(
              "æ­¤å‹•ä½œæœƒæ¸…é™¤æœ¬æ©Ÿå·²å„²å­˜çš„è³‡æ–™åº«ä¸¦é‡æ–°è¼‰å…¥é è¨­å¸³è™Ÿã€‚ç¢ºå®šè¦ç¹¼çºŒï¼Ÿ"
            )
          ) {
            localStorage.removeItem(STORAGE_KEY);
            window.location.reload();
          }
        };

        return users.length > 0 ? (
          <Dashboard
            user={activeUser}
            users={users}
            activeUserId={activeUserId}
            onLogout={handleLogout}
            onSwitchUser={handleSwitchUser}
            onLogin={handleLogin}
            db={db}
            setDb={setDb}
            storageInfo={storageInfo}
          />
        ) : (
          <LoginForm onLogin={handleLogin} onResetStorage={handleResetStorage} />
        );
      };

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>
  </body>
</html>


